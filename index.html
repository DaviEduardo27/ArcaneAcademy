<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcane Academy [BETA] - Patch 2.0</title>
    
    <!-- Open Graph / Discord & WhatsApp Preview -->
    <meta property="og:title" content="Arcane Academy [BETA] - Patch 2.0">
    <meta property="og:description" content="Embarque em uma jornada m√°gica, enfrente chefes lend√°rios e complete seu Grim√≥rio neste jogo de mem√≥ria e estrat√©gia.">
    <meta property="og:image" content="Imagens/CapaGame.jpg">
    <meta property="og:type" content="website">
    <meta name="theme-color" content="#c5a028">

    <link rel="icon" type="image/x-icon" href="icone.ico">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=MedievalSharp&family=Pirata+One&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <style>
        /* --- VISUAL CORE --- */
        :root {
            --bg-deep: #050505; --accent-gold: #c5a028; --accent-glow: #ffd700; --danger-red: #8b0000;
            --magic-blue: #00a8cc; --combo-orange: #d35400; --chaos-purple: #6c3483; --panel-bg: rgba(5, 5, 8, 0.95);
            --paper-color: #e3dac9; --ink-color: #1a1a1a; --glass-dark: rgba(0, 0, 0, 0.9);
            --rew-silver: #bdc3c7; --rew-mythril: #1abc9c; --rew-cosmic: #8e44ad;
        }
        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; outline: none; margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Cinzel', serif; color: #d0d0d0; cursor: default; }

        /* --- BACKGROUNDS --- */
        #dynamic-bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background-size: cover; background-position: center; transition: opacity 1s ease, filter 1s ease; opacity: 0.6; filter: contrast(1.1) saturate(0.9); }
        .env-default { background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%); }
        .env-glacia{background-image:url('Imagens/Fundos/bg_glacia.jpg');} .env-thalros{background-image:url('Imagens/Fundos/bg_thalros.jpg');} 
        .env-umbra{background-image:url('Imagens/Fundos/bg_umbra.jpg');} .env-ferrum{background-image:url('Imagens/Fundos/bg_ferrum.jpg');} 
        .env-solari{background-image:url('Imagens/Fundos/bg_solari.jpg');} .env-aurelius{background-image:url('Imagens/Fundos/bg_aurelius.jpg');} 
        .env-malakor{background-image:url('Imagens/Fundos/bg_malakor.jpg');} .env-sertis{background-image:url('Imagens/Fundos/bg_sertis.jpg');} 
        .env-trion{background-image:url('Imagens/Fundos/bg_trion.jpg');} .env-gaiaos{background-image:url('Imagens/Fundos/bg_gaiaos.jpg');}

        /* --- VFX --- */
        #magic-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        #combo-pulse-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 0%, #000 100%); z-index: 2; transition: background 0.2s ease; pointer-events: none; mix-blend-mode: overlay; }
        #vfx-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; }
        .magic-spark { position: absolute; width: 8px; height: 8px; background: #fff; border-radius: 50%; box-shadow: 0 0 15px #fff, 0 0 30px var(--accent-gold); pointer-events: none; }
        .spell-projectile { position: absolute; width: 50px; height: 50px; border-radius: 50%; background: radial-gradient(circle, #fff, var(--magic-blue)); box-shadow: 0 0 30px var(--magic-blue), 0 0 60px #fff; z-index: 9000; pointer-events: none; mix-blend-mode: screen; }
        #fx-overlay, #fade-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 8000; opacity: 0; }
        #fade-layer { background: #000; z-index: 10000; transition: opacity 0.8s; }
        .fade-active { opacity: 1 !important; pointer-events: all !important; }
        .levelup-shockwave { position: absolute; border: 3px solid var(--accent-gold); border-radius: 50%; pointer-events: none; z-index: 9999; box-shadow: 0 0 30px var(--accent-gold), inset 0 0 20px var(--accent-gold); opacity: 0; }
        #time-warning-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9000; opacity: 0; transition: opacity 0.5s; box-shadow: inset 0 0 0 rgba(255,0,0,0); }
        #time-warning-layer.active { opacity: 1; animation: timePulse 1s infinite ease-in-out; }
        @keyframes timePulse { 0% { box-shadow: inset 0 0 30px rgba(255, 0, 0, 0.3); } 50% { box-shadow: inset 0 0 100px rgba(255, 0, 0, 0.8); } 100% { box-shadow: inset 0 0 30px rgba(255, 0, 0, 0.3); } }
        
        #portal-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 15000; pointer-events: none; opacity: 0; transition: opacity 0.5s; }
        #portal-canvas.active { opacity: 1; }
        
        /* Combo Breaker Crack */
        #crack-fx { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9500; pointer-events: none; opacity: 0; display: flex; align-items: center; justify-content: center; mix-blend-mode: overlay; }
        #crack-svg { width: 80%; height: 80%; filter: drop-shadow(0 0 10px rgba(0,0,0,0.8)); }
        .crack-path { fill: none; stroke: rgba(255, 255, 255, 0.8); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; vector-effect: non-scaling-stroke; }
        
        /* BLACK HOLE FX */
        #black-hole {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            width: 150px; height: 150px; border-radius: 50%;
            background: #000;
            box-shadow: 0 0 30px #4b0082, 0 0 60px #800080, inset 0 0 40px rgba(255,255,255,0.1);
            z-index: 9000; pointer-events: none; opacity: 0;
        }
        #black-hole::before { content: ''; position: absolute; top: -20%; left: -20%; width: 140%; height: 140%; border-radius: 50%; border: 2px solid rgba(108, 52, 131, 0.5); border-top-color: transparent; border-bottom-color: transparent; animation: bhSpin 2s linear infinite; filter: url(#gravitational-distortion); }
        #black-hole::after { content: ''; position: absolute; top: -40%; left: -40%; width: 180%; height: 180%; border-radius: 50%; border: 2px dashed rgba(75, 0, 130, 0.3); animation: bhSpin 4s linear infinite reverse; filter: url(#gravitational-distortion); }
        @keyframes bhSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Chromatic Aberration Class */
        .chromatic-active { animation: chromaticShake 0.2s infinite; filter: url(#chromatic-aberration); }
        @keyframes chromaticShake { 0% { transform: translate(1px, 0); } 50% { transform: translate(-1px, 0); } 100% { transform: translate(1px, 0); } }
        .time-turner-fx { animation: timeRewind 1.5s ease-in-out; } @keyframes timeRewind { 0% { filter: sepia(0); } 50% { filter: sepia(1) hue-rotate(-50deg) blur(2px); } 100% { filter: sepia(0); } }
        
        /* --- SCREENS --- */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.5s; z-index: 10; }
        .screen.active { display: flex; opacity: 1; z-index: 50; }

        /* --- INTRO FIX (FULLSCREEN + VINHETA) --- */
        #screen-intro { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: radial-gradient(ellipse at center, #1a2639 0%, #000000 100%); z-index: 20000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .intro-container { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* Efeito Teto M√°gico: Azul profundo nas bordas, transparente no centro */
        .magic-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: radial-gradient(circle at center, transparent 40%, rgba(0, 0, 0, 0.6) 100%); 
            pointer-events: none; z-index: 20001; 
        }
        
        /* Video Centralizado (Cinema Mode) */
        #intro-video { 
            width: auto; height: auto; 
            max-width: 85vw; max-height: 85vh;
            border-radius: 20px;
            box-shadow: 0 0 60px rgba(0, 168, 204, 0.3);
            opacity: 1; 
            z-index: 20000; 
        }
        
        #start-btn-intro { z-index: 20002; position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%); background: linear-gradient(180deg, rgba(10, 20, 30, 0.95), #000); border: 1px solid rgba(0, 168, 204, 0.5); color: var(--accent-gold); padding: 18px 50px; font-family: 'Cinzel'; font-size: 1.4rem; letter-spacing: 4px; text-transform: uppercase; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); backdrop-filter: blur(5px); box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); opacity: 1; text-shadow: 0 0 10px rgba(197, 160, 40, 0.5); border-radius: 50px; }
        #start-btn-intro:hover { background: linear-gradient(180deg, rgba(20, 40, 60, 1), #050505); border-color: var(--magic-blue); box-shadow: 0 0 50px rgba(0, 168, 204, 0.6), inset 0 0 20px rgba(0, 168, 204, 0.2); color: #fff; transform: translateX(-50%) scale(1.05) translateY(-5px); text-shadow: 0 0 20px var(--magic-blue); }
        #skip-text { position: absolute; bottom: 30px; right: 40px; z-index: 20002; font-family: 'Cinzel'; color: rgba(255,255,255,0.4); font-size: 0.9rem; letter-spacing: 3px; cursor: pointer; display: none; text-transform: uppercase; }

        /* --- MENU --- */
        #screen-menu { 
            background: url('Imagens/CapaGame.jpg') no-repeat center center;
            background-size: contain; /* Garante Full HD sem cortes */
            width: 100%; height: 100%; 
        }
        .menu-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, transparent 30%, rgba(5, 10, 30, 0.5) 70%, #000 100%); z-index: 1; pointer-events: none; }
        
        .menu-card { width: 100%; height: 100%; background: transparent; border: none; box-shadow: none; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; overflow: hidden; z-index: 2; }
        .title-glow-fx { position: absolute; top: 0; width: 100%; height: 40%; background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent); pointer-events: none; z-index: 5; }
        .beta-badge { position: absolute; top: 30px; right: 40px; font-family: 'Cinzel'; font-size: 1.2rem; font-weight: bold; color: rgba(255, 255, 255, 0.8); letter-spacing: 4px; z-index: 100; text-shadow: 0 0 10px rgba(0, 168, 204, 0.8); }
        
        /* Carrossel */
        .menu-options-container { width: 100%; background: linear-gradient(to top, #000 0%, rgba(0,0,0,0.8) 50%, transparent 100%); padding: 0; display: flex; justify-content: center; align-items: center; gap: 25px; z-index: 2000; min-height: 450px; border: none; position: relative; flex-wrap: wrap; align-content: center; }
        
        .magic-menu-card { width: 190px; height: 290px; flex-shrink: 0; background: rgba(10, 12, 16, 0.85); border: 1px solid rgba(197, 160, 40, 0.3); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative; backdrop-filter: blur(5px); opacity: 1; pointer-events: auto; transform: translateY(0); animation: cardFloatMenu 4s ease-in-out infinite; text-align: center; }
        
        /* Varia√ß√£o na anima√ß√£o para parecer org√¢nico */
        .magic-menu-card:nth-child(odd) { animation-duration: 4.5s; animation-delay: 0.5s; }
        .magic-menu-card:nth-child(even) { animation-duration: 3.8s; animation-delay: 0s; }

        @keyframes cardFloatMenu { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        
        .card-icon { font-size: 4.5rem; color: #aaa; transition: 0.4s; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); }
        .card-label { font-family: 'Cinzel'; font-size: 1.1rem; font-weight: 700; color: #aaa; text-transform: uppercase; letter-spacing: 3px; transition: 0.4s; margin-top: 10px; width: 100%; text-align: center; }
        
        .magic-menu-card:hover { transform: translateY(-30px) scale(1.1) !important; background: linear-gradient(to bottom, rgba(20, 30, 50, 0.95), rgba(10, 12, 16, 0.95)); border-color: var(--accent-gold); box-shadow: 0 0 40px rgba(197, 160, 40, 0.4), inset 0 0 20px rgba(197, 160, 40, 0.1); z-index: 100; animation: none; }
        .magic-menu-card:hover .card-icon { color: #fff; filter: drop-shadow(0 0 25px var(--magic-blue)); transform: scale(1.1) translateZ(30px); }
        .magic-menu-card:hover .card-label { color: #fff; text-shadow: 0 0 20px var(--magic-blue); transform: translateZ(30px); }
        .magic-menu-card:active { transform: translateY(-25px) scale(0.95); filter: brightness(1.3); }
        .magic-menu-card.disabled { opacity: 0.3; filter: grayscale(1); pointer-events: none; display:none; }

        .nav-zone { display: none; }

        /* --- UI & HUD --- */
        .panel-glass { background: linear-gradient(135deg, #1a1a1a, #050505); border: 2px solid var(--accent-gold); padding: 50px; border-radius: 8px; text-align: center; width: 600px; max-width: 90%; box-shadow: 0 0 100px rgba(0,0,0,0.9); }
        .btn-main { background: rgba(0,0,0,0.7); border: 1px solid rgba(197, 160, 40, 0.4); color: var(--accent-gold); font-family: 'Cinzel'; font-size: 1.2rem; padding: 18px 0; cursor: pointer; transition: 0.3s; width: 100%; text-transform: uppercase; letter-spacing: 4px; margin-top: 15px; }
        .btn-main:hover { background: rgba(197, 160, 40, 0.15); border-color: var(--accent-gold); box-shadow: 0 0 25px rgba(197, 160, 40, 0.3); transform: scale(1.02); }
        .btn-main:active { transform: scale(0.98); }
        
        .hud-top { position: absolute; top: 0; left: 0; width: 100%; padding: 30px 50px; display: flex; justify-content: space-between; align-items: flex-start; z-index: 100; pointer-events: none; }
        .profile-card-hud, .stats-card-hud { pointer-events: auto; background: rgba(15, 18, 25, 0.9); padding: 12px 30px; border-radius: 6px; backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .profile-card-hud { display: flex; align-items: center; gap: 20px; border-left: 4px solid var(--accent-gold); }
        .avatar-frame { width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--accent-gold); background: #000; overflow: hidden; } .avatar-frame img { width: 100%; height: 100%; object-fit: cover; }
        .stats-card-hud { display: flex; gap: 50px; font-family: 'Cinzel'; font-size: 1.3rem; }
        .val-gold { color: var(--accent-gold); font-weight:bold; } .val-blue { color: var(--magic-blue); font-weight:bold; }
        
        .game-area { display: flex; align-items: center; justify-content: center; gap: 80px; width: 100%; height: 100%; transform-style: preserve-3d; z-index: 10; }
        .boss-panel { width: 350px; text-align: center; position: relative; }
        .boss-img { width: 300px; height: 300px; margin: 0 auto; animation: float 5s infinite ease-in-out; } .boss-img img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 20px 40px rgba(0,0,0,0.8)); }
        
        #boss-n { font-size: 2.2rem; margin-top: 15px; font-weight: bold; color: #fff; text-shadow: 0 0 15px var(--accent-gold); letter-spacing: 4px; font-family: 'Cinzel'; text-transform: uppercase; border-bottom: 2px solid var(--accent-gold); padding-bottom: 5px; display: inline-block; }
        
        .boss-hp-bg { width: 100%; height: 18px; background: #0a0a0a; margin-top: 20px; border-radius: 10px; border: 2px solid var(--accent-gold); box-shadow: 0 0 20px rgba(0,0,0,0.8); position: relative; overflow: hidden; }
        .boss-hp-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #8b0000, #e74c3c); transition: 0.3s; box-shadow: 0 0 15px #e74c3c; position: relative; }
        .boss-hp-fill::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 50%; background: rgba(255,255,255,0.2); border-radius: 10px 10px 0 0; }
        .boss-blood { position: absolute; width: 6px; height: 6px; background: #8b0000; border-radius: 50%; pointer-events: none; z-index: 20; box-shadow: 0 0 5px #ff0000; }
        .boss-speech-bubble { position: absolute; top: -120px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 20px 25px; border-radius: 8px; font-family: 'MedievalSharp'; font-size: 1.1rem; width: 280px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); opacity: 0; pointer-events:none; transition: opacity 0.5s; border: 3px solid #000; }
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-20px);} }
        
        /* Auras & Effects */
        .aura-ice .avatar-frame { border-color: var(--magic-blue); box-shadow: 0 0 25px var(--magic-blue); }
        .aura-fire .avatar-frame { border-color: var(--danger-red); box-shadow: 0 0 25px var(--danger-red); }
        .aura-lightning .avatar-frame { border-color: var(--accent-glow); box-shadow: 0 0 30px var(--accent-glow); }
        .aura-shadow .avatar-frame { border-color: var(--chaos-purple); box-shadow: 0 0 35px var(--chaos-purple); }
        .aura-light .avatar-frame { border-color: #fff; box-shadow: 0 0 40px #fff; }
        .boss-hit { animation: hitBasic 0.2s; } @keyframes hitBasic { 0%{filter:brightness(10) contrast(2);} 100%{filter:brightness(1);} }

        /* CARDS - HOTFIX FLIP & BACK */
        .card-grid { display: grid; gap: 20px; perspective: 1200px; z-index: 10; } .grid-4 { grid-template-columns: repeat(4, 1fr); } .grid-5 { grid-template-columns: repeat(5, 1fr); } .grid-6 { grid-template-columns: repeat(6, 1fr); }
        .card-wrapper { width: 100px; height: 140px; position: relative; animation: cardFloat 3s infinite alternate ease-in-out; transition: transform 0.3s; }
        .card-wrapper:hover { transform: translateY(-10px) scale(1.05); z-index: 50; }
        
        .card { width: 100%; height: 100%; cursor: pointer; position: relative; transform-style: preserve-3d; transition: z-index 0.3s; }
        /* OBS: Transi√ß√£o via GSAP no JS, removida do CSS para n√£o conflitar */
        @keyframes cardFloat { 0% { transform: translateY(0); } 100% { transform: translateY(-10px); } }
        
        .face { width: 100%; height: 100%; position: absolute; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 3rem; backface-visibility: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.8); }
        .front { background: #e0e0e0; transform: rotateY(180deg); border: 2px solid #555; color: #222; }
        
        /* CORRE√á√ÉO DO VERSO (ICONE.PNG) */
        .back { 
            background: #1a1a1a; 
            background-image: url('Imagens/icone.png');
            background-size: 60%;
            background-position: center;
            background-repeat: no-repeat;
            border: 2px solid #444; 
            color: #444; 
        }
        
        .card.matched .front { border-color: #fff; box-shadow: 0 0 30px var(--accent-gold); }
        .card.chaos-glow { box-shadow: 0 0 50px var(--chaos-purple), inset 0 0 30px var(--chaos-purple); border: 2px solid var(--chaos-purple); animation: none; }
        
        /* Skins */
        .card-skin-silver .back { background-color: #2c3e50; border-color: #7f8c8d; }
        .card-skin-gold .back { background-color: #7d6608; border-color: #f1c40f; }
        .card-skin-diamond .back { background-color: #1f618d; border-color: #5dade2; }
        .card-skin-mythril .back { background-color: #0b5345; border-color: #48c9b0; }
        .card-skin-cosmic .back { background: linear-gradient(145deg, #4a235a, #000); border-color: #d2b4de; }

        /* FURY MODE */
        .card-grid.fury-active .card .front { border-color: #ff4500; box-shadow: 0 0 20px #ff4500, inset 0 0 10px #ff8c00; animation: furyBurn 0.5s infinite alternate; }
        .card-grid.fury-active .card .back { border-color: #ff4500; box-shadow: 0 0 20px #ff4500; }
        @keyframes furyBurn { 0% { box-shadow: 0 0 15px #ff4500; } 100% { box-shadow: 0 0 40px #ff4500, 0 0 20px #ffff00; filter: brightness(1.3); } }

        /* --- NOTIFICA√á√ïES & POPUPS --- */
        #magic-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 30000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .magic-alert-box { background: linear-gradient(135deg, #121212, #000); border: 2px solid var(--accent-gold); padding: 50px 80px; text-align: center; border-radius: 12px; box-shadow: 0 0 80px rgba(197, 160, 40, 0.4); max-width: 500px; display:flex; flex-direction:column; align-items:center; gap:25px; transform: scale(0.8); opacity: 0; transition: all 0.3s ease; }
        .magic-alert-box.show { transform: scale(1); opacity: 1; }
        .magic-alert-box h3 { color: var(--accent-gold); font-family: 'Cinzel'; font-size: 2rem; margin:0; letter-spacing: 2px; }
        .magic-alert-box p { color: #ddd; font-family: 'MedievalSharp'; font-size: 1.3rem; margin:0; }
        .magic-alert-btn { background: transparent; border: 1px solid var(--accent-gold); color: var(--accent-gold); padding: 15px 40px; font-family: 'Cinzel'; cursor: pointer; transition: 0.3s; font-size: 1.1rem; text-transform:uppercase; letter-spacing: 2px; } .magic-alert-btn:hover { background: var(--accent-gold); color: #000; box-shadow: 0 0 30px var(--accent-gold); }

        .notification-bar { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #000; padding: 15px 60px; border: 2px solid var(--accent-gold); font-family: 'Cinzel'; font-size: 1.3rem; color: var(--accent-gold); opacity: 0; pointer-events: none; transition: opacity 0.5s; z-index: 20000; text-shadow: 0 0 15px var(--accent-gold); box-shadow: 0 10px 50px rgba(0,0,0,1); border-radius: 4px; }
        .notification-bar.show { opacity: 1; }
        
        /* Combo VFX */
        #combo-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 5000; pointer-events: none; }
        .combo-text { font-size: 5rem; font-weight: 800; font-family: 'Cinzel'; background: linear-gradient(to bottom, #fff 20%, var(--accent-gold) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 20px var(--accent-gold)); letter-spacing: 5px; z-index: 6000; }
        .combo-text.fury { background: linear-gradient(to bottom, #fff 10%, #ff4500 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 40px #ff4500); }
        .float-score { position: absolute; font-family: 'Cinzel'; font-weight: bold; color: var(--accent-gold); text-shadow: 0 0 5px #000; pointer-events: none; z-index: 500; }

        /* QUIZ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; display: none; align-items: center; justify-content: center; perspective: 1500px; }
        .newspaper { width: 600px; max-height: 90vh; background: #d6cfc7 url('https://www.transparenttextures.com/patterns/aged-paper.png'); color: #111; padding: 40px; border: 2px solid #000; outline: 5px double #222; box-shadow: 0 0 150px rgba(0,0,0,1); transform-style: preserve-3d; opacity: 0; transform: scale(0) rotate(720deg); display: flex; flex-direction: column; }
        .newspaper.streak-glow { box-shadow: 0 0 60px var(--accent-gold), 0 0 100px rgba(197, 160, 40, 0.6); border-color: var(--accent-gold); animation: streakPulse 2s infinite ease-in-out; }
        @keyframes streakPulse { 0% { box-shadow: 0 0 40px var(--accent-gold); filter: brightness(1); } 50% { box-shadow: 0 0 80px var(--accent-gold), 0 0 30px #fff; filter: brightness(1.2); } 100% { box-shadow: 0 0 40px var(--accent-gold); filter: brightness(1); } }
        .news-header { font-family: 'Pirata One'; text-align: center; border-bottom: 4px double #111; padding-bottom: 20px; margin-bottom: 20px; } .news-title { font-size: 4.5rem; margin: 0; text-transform: uppercase; line-height: 0.9; letter-spacing: 2px; }
        .quiz-question-box { font-family: 'MedievalSharp'; font-size: 1.6rem; text-align: center; margin: 30px 0; font-weight: bold; color: #1a1a1a; padding: 25px; background: rgba(0,0,0,0.05); border: 2px dashed #555; }
        .quiz-opt-btn { background: transparent; border: 2px solid #222; padding: 18px; font-family: 'Cinzel'; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: 0.2s; text-align: center; color: #222; margin-bottom: 12px; width: 100%; } .quiz-opt-btn:hover { background: #222; color: #e3dac9; }
        .owl-fx { position: absolute; top: -300px; left: 50%; transform: translateX(-50%); font-size: 10rem; z-index: 6000; pointer-events: none; filter: drop-shadow(0 40px 30px rgba(0,0,0,0.6)); opacity: 0; }
        
        /* Config Panel */
        .avatar-selector { margin: 20px; display: flex; justify-content: center; align-items: center; gap: 20px; } .prof-img-large { width: 160px; height: 160px; max-width: 160px; max-height: 160px; border-radius: 50%; object-fit: cover; border: 4px solid var(--accent-gold); box-shadow: 0 0 30px rgba(0,0,0,0.8); } .arrow-btn { background: none; border: none; color: #555; font-size: 3.5rem; cursor: pointer; transition: 0.2s; } .arrow-btn:hover { color: var(--accent-gold); } .input-magico { background: transparent; border: none; border-bottom: 1px solid var(--accent-gold); color: #fff; font-size: 1.5rem; padding: 10px; text-align: center; width: 80%; font-family: 'Cinzel'; margin: 20px 0; outline: none; }
        .dash-header { display: flex; align-items: center; gap: 25px; margin-bottom: 25px; justify-content: center; } .dash-avatar { width: 110px; height: 110px; border-radius: 50%; border: 3px solid var(--accent-gold); background: #000; overflow: hidden; } .dash-avatar img { width: 100%; height: 100%; object-fit: cover; } .dash-info h1 { margin: 0; color: var(--accent-gold); } .dash-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; } .stat-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 2px; border: 1px solid #333; } .stat-label { font-size: 0.7rem; color: #666; text-transform: uppercase; letter-spacing: 1px; } .stat-val-big { font-size: 1.8rem; color: #fff; font-family: 'Cinzel'; } .btn-delete-save { border-color: var(--danger-red); color: var(--danger-red); opacity: 0.6; margin-top: 20px; font-size: 0.8rem; } .btn-delete-save:hover { background: rgba(139, 0, 0, 0.2); border-color: #ff3333; color: #ff3333; opacity: 1; }
        .dash-header { display: flex; align-items: center; gap: 25px; margin-bottom: 25px; justify-content: center; } .dash-avatar { width: 110px; height: 110px; border-radius: 50%; border: 3px solid var(--accent-gold); background: #000; overflow: hidden; box-sizing: border-box; } .dash-avatar img { width: 100%; height: 100%; object-fit: cover; } .dash-info h1 { margin: 0; color: var(--accent-gold); } .dash-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; } .stat-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 2px; border: 1px solid #333; } .stat-label { font-size: 0.7rem; color: #666; text-transform: uppercase; letter-spacing: 1px; } .stat-val-big { font-size: 1.8rem; color: #fff; font-family: 'Cinzel'; } .btn-delete-save { border-color: var(--danger-red); color: var(--danger-red); opacity: 0.6; margin-top: 20px; font-size: 0.8rem; } .btn-delete-save:hover { background: rgba(139, 0, 0, 0.2); border-color: #ff3333; color: #ff3333; opacity: 1; }
        .cfg-section { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; } .cfg-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: #aaa; font-family: 'Cinzel'; font-size: 1.1rem; } input[type=range] { width: 50%; accent-color: var(--accent-gold); cursor: pointer; } 
        .btn-gear { position: fixed; bottom: 30px; right: 30px; font-size: 3rem; color: rgba(255,255,255,0.3); cursor: pointer; z-index: 5000; transition: 0.3s; filter: drop-shadow(0 0 5px #000); } .btn-gear:hover { transform: rotate(90deg) scale(1.1); color: var(--accent-gold); opacity: 1; }

        #achievement-popup { position: fixed; top: 40px; left: 50%; transform: translateX(-50%) translateY(-200%); background: linear-gradient(to bottom, #d4af37, #8e6d0f); padding: 3px; border-radius: 8px; box-shadow: 0 20px 60px rgba(0,0,0,0.8); z-index: 200000; transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; }
        #achievement-popup.show { transform: translateX(-50%) translateY(0); animation: achPulse 2s infinite ease-in-out; }
        @keyframes achPulse { 0% { box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); filter: brightness(1); } 50% { box-shadow: 0 0 40px rgba(212, 175, 55, 0.9), 0 0 10px #fff; filter: brightness(1.3); } 100% { box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); filter: brightness(1); } }
        .ach-inner { background: #120821; padding: 20px 30px; border-radius: 5px; display: flex; align-items: center; gap: 20px; color: var(--accent-gold); min-width: 400px; }
        .ach-icon { font-size: 3.5rem; filter: drop-shadow(0 0 15px rgba(197, 160, 40, 0.6)); }
        .ach-text { text-align: left; }
        .ach-title { 
            font-family: 'Cinzel'; 
            font-weight: 700; 
            font-size: 1.2rem; 
            margin-bottom: 5px; 
            color: #fff; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .ach-desc { font-family: 'MedievalSharp'; font-size: 1rem; color: #ccc; }
        
        /* Grimorio */
        .grimoire-container { 
            width: 850px; max-width: 90vw; height: 720px; max-height: 85vh; 
            background: #fdf5e6 url('https://www.transparenttextures.com/patterns/aged-paper.png'); 
            border-radius: 4px 15px 15px 4px;
            border-left: 18px solid #3e2723; /* Lombada */
            box-shadow: 
                inset 25px 0 40px rgba(62, 39, 35, 0.5), /* Sombra interna da lombada */
                inset -5px 0 10px rgba(0,0,0,0.1), /* Sombra borda direita */
                5px 5px 0 #dccbb6, /* Pilha de p√°ginas 1 */
                10px 10px 0 #cbb69d, /* Pilha de p√°ginas 2 */
                16px 16px 0 #3e2723, /* Capa traseira */
                30px 30px 50px rgba(0,0,0,0.8); /* Sombra projetada */
            display: flex; flex-direction: column; padding: 50px 60px; 
            position: relative; overflow: hidden; perspective: 1500px; color: #2c1e0b; 
        } 
        .grimoire-header { text-align: center; border-bottom: 3px double #5d4037; padding-bottom: 15px; margin-bottom: 25px; } .grimoire-title { font-family: 'UnifrakturMaguntia'; font-size: 3.5rem; color: #2c1e0b; margin: 0; } .grimoire-subtitle { font-family: 'Cinzel'; font-size: 1.1rem; color: #5d4037; font-weight: bold; } .grimoire-page { flex-grow: 1; display: flex; flex-direction: column; align-items: center; opacity: 1; transform-origin: center center; backface-visibility: hidden; overflow-y: auto; padding-right: 10px; } .grimoire-intro-text { font-family: 'MedievalSharp'; font-size: 1.3rem; color: #2c1e0b; text-align: center; line-height: 1.8; margin: 60px 0; font-style: italic; } .boss-portrait { width: 200px; height: 200px; border: 5px double #5d4037; border-radius: 50%; overflow: hidden; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); background: #fff; } .boss-portrait img { width: 100%; height: 100%; object-fit: cover; } .boss-name-title { font-family: 'MedievalSharp'; font-size: 2rem; color: #8b0000; margin-bottom: 5px; } .boss-honorific { font-family: 'Cinzel'; font-size: 1.1rem; font-weight: bold; color: #555; margin-bottom: 25px; font-style: italic; border-bottom: 1px solid #ccc; padding-bottom: 10px; } .boss-lore-text { font-family: 'MedievalSharp'; font-size: 1.2rem; color: #2c1e0b; text-align: justify; line-height: 1.6; padding: 0 30px; } .grimoire-nav { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding-top: 15px; border-top: 1px solid rgba(93, 64, 55, 0.3); } .page-btn { background: none; border: none; font-family: 'UnifrakturMaguntia'; font-size: 2.5rem; color: #5d4037; cursor: pointer; transition: 0.2s; } .page-btn:hover { color: #8b0000; transform: scale(1.1); } .page-btn:disabled { color: #ccc; cursor: default; transform: none; } .page-number { font-family: 'Cinzel'; font-weight: bold; color: #555; } .grimoire-actions { margin-top: 15px; display: flex; gap: 20px; justify-content: center; } .ach-list { width: 100%; padding: 0 20px; } .ach-item { display: flex; align-items: center; gap: 20px; padding: 15px; border-bottom: 1px solid rgba(93, 64, 55, 0.3); opacity: 0.4; filter: grayscale(1); transition: 0.3s; } .ach-item.unlocked { opacity: 1; filter: grayscale(0); background: rgba(212, 175, 55, 0.15); } .ach-item-icon { font-size: 2.5rem; color: #5d4037; } .ach-item.unlocked .ach-item-icon { color: #b7950b; text-shadow: 0 0 5px rgba(183, 149, 11, 0.5); } .ach-item-text { text-align: left; } .ach-item-text h4 { margin: 0; font-family: 'Cinzel'; color: #2c1e0b; font-size: 1.1rem; font-weight: bold; } .ach-item-text p { margin: 5px 0 0 0; font-family: 'MedievalSharp'; font-size: 0.95rem; color: #555; }
        
        .grimoire-bookmark {
            position: absolute; top: -10px; right: 80px; width: 40px; height: 120px;
            background: linear-gradient(to right, #8b0000, #a00000, #8b0000);
            box-shadow: 2px 5px 10px rgba(0,0,0,0.5);
            clip-path: polygon(0 0, 100% 0, 100% 100%, 50% 80%, 0 100%);
            z-index: 100; cursor: pointer; transform-origin: top center;
        }
        .grimoire-bookmark:hover { animation: bookmarkSwing 1.5s ease-in-out infinite; }
        @keyframes bookmarkSwing { 0% { transform: rotate(0deg); } 25% { transform: rotate(8deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(-8deg); } 100% { transform: rotate(0deg); } }
        
        .grimoire-bookmark::after {
            content: '‚ú¶'; position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
            color: #ffd700; font-size: 1.2rem; text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        #exit-screen { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:99999; flex-direction:column; align-items:center; justify-content:center; color:#555; opacity:0; transition:opacity 1s; }

        /* Grimoire Stars */
        #grimoire-stars { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .g-star { position: absolute; background: #fff; border-radius: 50%; animation: starPulse 3s infinite ease-in-out; }
        @keyframes starPulse { 0%, 100% { opacity: 0.3; transform: scale(0.8); box-shadow: none; } 50% { opacity: 1; transform: scale(1.3); box-shadow: 0 0 15px #fff, 0 0 8px #ffd700; } }

        /* Menu Particles */
        .menu-particle { position: fixed; width: 4px; height: 4px; background: radial-gradient(circle, #fff, var(--accent-gold)); border-radius: 50%; pointer-events: none; z-index: 9999; box-shadow: 0 0 8px var(--accent-gold); mix-blend-mode: screen; }

        /* Mist Layer */
        #mist-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, transparent 0%, rgba(200, 220, 255, 0.1) 40%, rgba(255, 255, 255, 0.4) 100%);
            backdrop-filter: blur(5px) grayscale(0.5);
            z-index: 25000; pointer-events: none; opacity: 0; transition: opacity 1.5s ease-in-out;
            mix-blend-mode: hard-light;
        }
        #mist-layer.active { opacity: 1; }
    </style>
</head>
<body>
    <!-- SVG Filter for Chromatic Aberration -->
    <svg style="display: none;">
        <defs>
            <filter id="chromatic-aberration">
                <feColorMatrix type="matrix" values="1 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 0" in="SourceGraphic" result="red"/>
                <feOffset in="red" dx="3" dy="0" result="red_offset"/>
                <feColorMatrix type="matrix" values="0 0 0 0 0  0 1 0 0 0  0 0 0 0 0  0 0 0 1 0" in="SourceGraphic" result="green"/>
                <feColorMatrix type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 1 0 0  0 0 0 1 0" in="SourceGraphic" result="blue"/>
                <feOffset in="blue" dx="-3" dy="0" result="blue_offset"/>
                <feBlend mode="screen" in="red_offset" in2="green" result="rg"/>
                <feBlend mode="screen" in="rg" in2="blue_offset" result="rgb"/>
            </filter>
            <filter id="gravitational-distortion">
                <feTurbulence type="fractalNoise" baseFrequency="0.03" numOctaves="3" seed="1" result="noise">
                    <animate attributeName="baseFrequency" values="0.03;0.05;0.03" dur="3s" repeatCount="indefinite" />
                </feTurbulence>
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="20" xChannelSelector="R" yChannelSelector="G" />
                <feGaussianBlur stdDeviation="0.5" />
            </filter>
        </defs>
    </svg>

    <div id="dynamic-bg-layer" class="env-default"></div>
    <canvas id="magic-canvas"></canvas>
    <div id="vfx-container"></div>
    <div id="fx-overlay"></div>
    <div id="combo-pulse-layer"></div>
    <div id="time-warning-layer"></div>
    <div id="fade-layer"></div>
    <div id="mist-layer"></div>
    <canvas id="portal-canvas"></canvas>
    <div id="black-hole"></div>
    
    <div id="crack-fx">
        <svg id="crack-svg" viewBox="0 0 500 500"><path class="crack-path" d="M250 250 L300 150 L320 100 M250 250 L150 200 L100 180 M250 250 L200 350 L180 400 M250 250 L350 300 L400 320 M250 250 L280 220 L350 200 M250 250 L220 280 L150 300"></path></svg>
    </div>

    <div id="combo-container"></div>
    <div class="notification-bar" id="notif-bar">Mensagem</div>
    <div style="display:none;" id="motes"></div>

    <div id="magic-alert-modal">
        <div class="magic-alert-box" id="magic-modal-content">
            </div>
    </div>

    <div id="modal-delete-confirm" class="modal-overlay" style="z-index: 35000;">
        <div class="magic-alert-box show" style="border-color: var(--danger-red); box-shadow: 0 0 60px rgba(139, 0, 0, 0.5);">
            <h3 style="color: var(--danger-red); text-shadow: 0 0 10px var(--danger-red);" data-lang="del_title">O VAZIO AGUARDA</h3>
            <p style="margin: 15px 0; text-align: center; color: #ccc; font-family: 'MedievalSharp';"><span data-lang="del_msg">Deseja banir este Mago para o esquecimento eterno?</span><br><span style="font-size: 0.9rem; color: #888;" data-lang="del_warn">(Todo o progresso ser√° perdido)</span></p>
            <div style="display: flex; gap: 20px; margin-top: 15px;">
                <div class="magic-alert-btn" style="border-color: var(--danger-red); color: var(--danger-red);" onclick="executeDeleteSlot()" data-lang="del_btn_ban">BANIR</div>
                <div class="magic-alert-btn" onclick="playS('click'); closeDeleteModal()" data-lang="del_btn_cancel">CANCELAR</div>
            </div>
        </div>
    </div>

    <div id="modal-quiz" class="modal-overlay">
        <div class="newspaper" id="quiz-paper">
            <div class="news-header"><div class="news-title" data-lang="quiz_paper_name">O Profeta Arcano</div><div class="news-subtitle"><span data-lang="quiz_edition">EDI√á√ÉO EXTRA</span><span data-lang="quiz_academy">ACADEMIA</span><span data-lang="quiz_urgent">URGENTE</span></div></div>
            <div class="news-content"><div class="headline" data-lang="quiz_timeout_title">TEMPO ESGOTADO!</div><div class="sub-headline" data-lang="quiz_desc">Responda para evitar a expuls√£o eminente.</div><div class="quiz-question-box"><p id="quiz-q">Pergunta...</p></div><div id="quiz-ops"></div></div>
            <div class="news-footer" data-lang="quiz_footer">O CONSELHO AGUARDA SUA RESPOSTA.</div>
        </div>
    </div>

    <div id="achievement-popup"><div class="ach-inner"><div class="ach-icon" id="ach-pop-icon">üèÜ</div><div class="ach-text"><div class="ach-title" id="ach-pop-title">Conquista!</div><div class="ach-desc" id="ach-pop-desc">Desc.</div></div></div></div>
    <div class="owl-fx" id="fx-owl">ü¶â</div>
    
    <audio id="ost-menu" src="Sons/musica_menu.mp3" loop></audio> 
    <audio id="ost-game" src="Sons/musica_jogo.mp3" loop></audio>
    <audio id="amb-menu" src="Sons/ambience_menu.mp3" loop></audio>

    <div id="screen-intro">
        <div class="intro-container">
            <div class="magic-overlay"></div>
            <video id="intro-video" muted playsinline preload="auto" loop autoplay><source src="Videos/intro.mp4" type="video/mp4"></video>
            <div id="start-btn-intro" onclick="playIntroSound()" data-lang="intro_start">INICIAR JORNADA</div>
            <div id="skip-text" onclick="endIntro()" data-lang="intro_skip">PULAR INTRO</div>
        </div>
    </div>

    <div id="screen-menu" class="screen">
        <div class="menu-overlay"></div>
        <div class="menu-card">
            <div class="title-glow-fx"></div><div class="beta-badge">BETA PATCH 2.0</div>
            <div class="menu-options-container">
                <div class="magic-menu-card disabled" id="btn-continue" onclick="playS('click'); continuarJogo()"><div class="card-icon">üìú</div><div class="card-label" data-lang="menu_continue">Continuar</div></div>
                <div class="magic-menu-card" onclick="playS('click'); novoJogo()"><div class="card-icon">‚ú®</div><div class="card-label" data-lang="menu_play">Modo Hist√≥ria</div></div>
                <div class="magic-menu-card" id="btn-ngplus" style="display:none; border-color:var(--danger-red);" onclick="playS('click'); iniciarNewGamePlus()"><div class="card-icon" style="color:var(--danger-red);">üî•</div><div class="card-label" style="color:var(--danger-red);">Despertar Arcano</div></div>
                <div class="magic-menu-card" id="btn-infinite" style="display:none; border-color:var(--chaos-purple);" onclick="playS('click'); openInfiniteMenu()"><div class="card-icon" style="color:var(--chaos-purple);">‚ôæÔ∏è</div><div class="card-label" style="color:var(--chaos-purple);" data-lang="menu_infinite">Infinito</div></div>
                <div class="magic-menu-card" id="btn-grimoire-menu" style="display:none; border-color:var(--accent-gold);" onclick="playS('click'); toggleGrimoireWithMist('open')"><div class="lock-icon" style="display:none;">üîí</div><div class="card-icon" style="color:var(--accent-gold);">üìñ</div><div class="card-label" style="color:var(--accent-gold);" data-lang="menu_grimoire">Grim√≥rio</div></div>
                <div class="magic-menu-card" onclick="playS('click'); abrirPerfilMenu()"><div class="card-icon">üßô‚Äç‚ôÇÔ∏è</div><div class="card-label" data-lang="menu_profile">Perfil</div></div>
                <div class="magic-menu-card" onclick="playS('click'); openConfigMenu('menu')"><div class="card-icon">‚öôÔ∏è</div><div class="card-label" data-lang="menu_options">Op√ß√µes</div></div>
            </div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="hud-top">
            <div class="profile-card-hud" id="hud-avatar-container"><div class="avatar-frame"><img id="hud-av-img" src="" alt="Av"></div><div class="player-info"><div class="p-name" id="hud-name">Player</div><div class="p-lvl"><span data-lang="hud_lvl">N√≠vel</span> <span id="hud-lvl">1</span></div></div></div>
            <div class="stats-card-hud"><span><span data-lang="hud_stage">Fase</span> <b class="val-gold" id="ui-fase">1</b></span><span id="box-tempo"><span data-lang="hud_time">Tempo</span> <b class="val-gold" id="ui-tempo">60</b></span><span><span data-lang="hud_pts">Pts</span> <b class="val-blue" id="ui-score">0</b></span></div>
        </div>
        <div class="game-area">
            <div class="boss-panel">
                <div id="boss-speech" class="boss-speech-bubble">...</div>
                <div id="boss-vis" class="boss-img"><img id="boss-img-tag" src="" alt="Boss"></div>
                <div id="boss-n">BOSS</div>
                <div class="boss-hp-bg"><div class="boss-hp-fill" id="hp-bar"></div></div>
            </div>
            <div class="card-grid grid-4" id="board"></div>
        </div>
        <div class="btn-gear" onclick="playS('click'); openConfigMenu('game')">‚öôÔ∏è</div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="panel-glass">
            <h2 style="color:var(--accent-gold)" data-lang="profile_title">REGISTRO M√ÅGICO</h2>
            <div id="profile-edit">
                <div class="avatar-selector"><button class="arrow-btn" onclick="playS('click'); mudarAvatar(-1)">‚ùÆ</button><img id="prof-av-edit" class="prof-img-large" src=""><button class="arrow-btn" onclick="playS('click'); mudarAvatar(1)">‚ùØ</button></div>
                <div class="frame-selector" style="display:flex; align-items:center; justify-content:center; gap:15px; margin-bottom:20px;">
                    <button class="arrow-btn" onclick="playS('click'); mudarFrame(-1)" style="font-size:2rem;">‚ùÆ</button>
                    <div style="text-align:center; width:200px;"><div id="frame-name" style="font-family:'Cinzel'; color:var(--accent-gold); font-size:1.2rem;">Padr√£o</div><div id="frame-req" style="font-size:0.8rem; color:#666;">Desbloqueado</div></div>
                    <button class="arrow-btn" onclick="playS('click'); mudarFrame(1)" style="font-size:2rem;">‚ùØ</button>
                </div>
                <input type="text" id="prof-name-input" class="input-magico" placeholder="Seu Nome"><br><br>
                <div class="btn-main" onclick="playS('click'); salvarPerfil()" data-lang="btn_save">Salvar</div>
                <div class="btn-main" style="margin-top:10px; opacity:0.7;" onclick="playS('click'); navegar('screen-menu')" data-lang="btn_back">Voltar</div>
            </div>
            <div id="profile-dash" style="display:none;">
                <div class="dash-header"><div class="dash-avatar"><img id="dash-av-img" src=""></div><div class="dash-info"><h1 id="dash-name">Nome</h1><div id="dash-title">Aprendiz</div></div></div>
                <div class="dash-stats-grid"><div class="stat-box"><div class="stat-label" data-lang="stat_lvl">N√çVEL</div><div class="stat-val-big" id="dash-lvl">1</div></div><div class="stat-box"><div class="stat-label" data-lang="stat_record">RECORDE</div><div class="stat-val-big" id="dash-score">0</div></div></div>
                <div class="btn-main" onclick="playS('click'); editarPerfil()" data-lang="btn_edit">Editar</div>
                <div class="btn-main" onclick="playS('click'); navegar('screen-menu')" data-lang="btn_back">Voltar</div>
            </div>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <div class="panel-glass">
            <h2 style="color:var(--accent-gold)" data-lang="settings_title">OP√á√ïES</h2>
            <div class="cfg-section"><h3 data-lang="settings_audio">√ÅUDIO</h3><div class="cfg-row"><span data-lang="settings_music">M√∫sica</span><input type="range" min="0" max="1" step="0.1" id="rng-musica" oninput="setAudio('m', this.value)"></div><div class="cfg-row"><span data-lang="settings_sfx">Efeitos</span><input type="range" min="0" max="1" step="0.1" id="rng-sfx" oninput="setAudio('s', this.value)"></div></div>
            <div class="btn-main" onclick="playS('click'); voltarConfig()" data-lang="btn_back">Voltar</div>
            <div id="btn-quit-match" class="btn-main" style="border-color:var(--combo-orange); color:var(--combo-orange); display:none; margin-top:10px;" onclick="playS('click'); sairParaMenu()" data-lang="btn_quit">Voltar ao Menu Principal</div>
        </div>
    </div>

    <div id="screen-credits" class="screen" style="background:radial-gradient(circle at center, #1a0b2e 0%, #000000 100%); z-index:20005; display:none;">
        <div id="grimoire-stars"></div>
        <div class="grimoire-container">
            <div class="grimoire-bookmark" onclick="playS('click')"></div>
            <div class="grimoire-header"><h1 class="grimoire-title">Grim√≥rio das Lendas</h1><div class="grimoire-subtitle">Os Desafios Superados</div></div>
            <div id="book-content" class="grimoire-page"></div>
            <div class="grimoire-nav"><button class="page-btn" id="prev-btn" onclick="prevPage()">‚ùÆ</button><div class="page-number">P√°gina <span id="page-num">1</span></div><button class="page-btn" id="next-btn" onclick="nextPage()">‚ùØ</button></div>
        </div>
        <div class="grimoire-actions"><div class="btn-main" style="width:250px; background:rgba(0,0,0,0.8); border:1px solid var(--accent-gold); color:var(--accent-gold); box-shadow:0 0 20px rgba(197, 160, 40, 0.3); border-radius: 50px;" onclick="playS('click'); toggleGrimoireWithMist('close')">Voltar ao Menu</div></div>
    </div>

    <div id="modal-infinite" class="modal-overlay">
        <div class="panel-glass" style="width: 500px; position: relative;">
            <div class="btn-close-modal" onclick="document.getElementById('modal-infinite').style.display='none'">‚úñ</div>
            <h2 style="color:var(--chaos-purple); text-shadow: 0 0 10px var(--chaos-purple);">MODO INFINITO</h2>
            <div style="margin: 20px 0; font-family: 'MedievalSharp'; color: #ccc;">Sobreviva o m√°ximo que puder.<br>A dificuldade aumenta a cada passo.</div>
            <div class="ranking-box"><h3 style="color:var(--accent-gold); border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:10px;">HALL DAS LENDAS</h3><div id="infinite-ranking-list" style="max-height: 200px; overflow-y: auto; text-align: left; padding: 5px;"></div></div>
            <div class="btn-main" style="border-color:var(--chaos-purple); color:var(--chaos-purple);" onclick="playS('click'); startInfiniteRun()">INICIAR RUN</div>
        </div>
    </div>

    <div id="modal-ngplus" class="modal-overlay">
        <div class="panel-glass" style="width: 500px; position: relative; border-color: var(--danger-red); box-shadow: 0 0 50px rgba(139, 0, 0, 0.3);">
            <div class="btn-close-modal" onclick="document.getElementById('modal-ngplus').style.display='none'">‚úñ</div>
            <h2 style="color:var(--danger-red); text-shadow: 0 0 10px var(--danger-red);">NEW GAME +</h2>
            <div style="margin: 20px 0; font-family: 'MedievalSharp'; color: #ccc;">O desafio definitivo aguarda.<br><br><span style="color:#aaa; font-size:0.95rem;">üî• Tempo Reduzido (45s)<br>üÉè Tabuleiro Expandido (24 Cartas)</span></div>
            <div class="btn-main" style="border-color:var(--danger-red); color:var(--danger-red);" onclick="confirmNewGamePlus()">INICIAR PESADELO</div>
        </div>
    </div>

    <div id="screen-slots" class="screen" style="display:none; background: #050505; z-index: 30000;">
        <div class="panel-glass" style="width: 800px; max-width: 95%;">
            <h2 style="color:var(--accent-gold); margin-bottom: 10px;" data-lang="slots_title">SELECIONE UM PERFIL</h2>
            <div class="slots-container" id="slots-list" style="display:flex; gap:20px; justify-content:center; margin-top:30px; flex-wrap: wrap;"></div>
            <div class="btn-main" style="margin-top: 30px; width: 200px; margin-left: auto; margin-right: auto;" onclick="playS('click'); navegar('screen-menu')" data-lang="btn_back">Voltar</div>
        </div>
    </div>

    <div id="exit-screen"><div style="font-family:'Cinzel'; font-size:2rem; margin-bottom:20px; color:var(--accent-gold); text-shadow:0 0 10px var(--accent-gold);">At√© logo, Mago.</div></div>

    <script>
        /**
         * Arcane Academy [BETA] - Patch 2.0
         * Refatora√ß√£o para Performance e Manutenibilidade
         */

        let ipcRenderer; 
        try { ipcRenderer = require('electron').ipcRenderer; } catch(e) {}

        // --- 1. CONSTANTES E DADOS ---
        const CONFIG_DEFAULTS = {
            MUSIC_VOL: 0.2,
            SFX_VOL: 0.5,
            PARTICLES: true
        };

        const UI = {
            screens: {},
            hud: {},
            boss: {},
            modal: {},
            init() {
                // Cache de elementos frequentes
                this.screens.menu = document.getElementById('screen-menu');
                this.screens.game = document.getElementById('screen-game');
                this.screens.profile = document.getElementById('screen-profile');
                this.screens.settings = document.getElementById('screen-settings');
                this.hud.score = document.getElementById('ui-score');
                this.hud.tempo = document.getElementById('ui-tempo');
                this.hud.fase = document.getElementById('ui-fase');
                this.board = document.getElementById('board');
            }
        };

        const avatares = [ { file: "mago_aprendiz.png", color: "#3498db" }, { file: "feiticeira_natureza.png", color: "#2ecc71" }, { file: "guerreiro_magico.png", color: "#e74c3c" }, { file: "mago_sabio.png", color: "#9b59b6" }, { file: "feiticeira_lua.png", color: "#00d2ff" } ];
        
        const molduras = [
            { name: "Padr√£o", req: "Desbloqueado", unlock: p => true, apply: (el, c) => { el.style.border = `4px solid ${c}`; el.style.boxShadow = `0 0 20px ${c}`; } },
            { name: "Veterano", req: "N√≠vel 10", unlock: p => p.lvl >= 10, apply: (el, c) => { el.style.border = `4px double #cd7f32`; el.style.boxShadow = `0 0 15px #cd7f32`; } },
            { name: "Elite", req: "N√≠vel 25", unlock: p => p.lvl >= 25, apply: (el, c) => { el.style.border = `4px solid #c0c0c0`; el.style.boxShadow = `0 0 20px #c0c0c0`; } },
            { name: "Mestre", req: "N√≠vel 50", unlock: p => p.lvl >= 50, apply: (el, c) => { el.style.border = `4px solid #ffd700`; el.style.boxShadow = `0 0 25px #ffd700`; } },
            { name: "Lenda", req: "Grim√≥rio", unlock: p => p.grimoireUnlocked, apply: (el, c) => { el.style.border = `4px double #fff`; el.style.boxShadow = `0 0 30px #fff, inset 0 0 10px #fff`; } },
            { name: "Vazio", req: "Infinito", unlock: p => p.infiniteUnlocked, apply: (el, c) => { el.style.border = `4px dashed #6c3483`; el.style.boxShadow = `0 0 20px #6c3483`; } }
        ];
        
        const titulos = ["Aprendiz", "Novato", "Estudante", "Adepto", "Feiticeiro", "Mago", "Bruxo", "Encantador", "Mestre", "Gr√£o-Mestre", "Arquimago", "Auror", "Lenda", "Semideus", "Divindade Arcana"];
        
        const bosses = [
            { n:"Glacia", title:"A Sentinela do Inverno", file:"fada_gelo.png", color:"#00d2ff", lore:"Antigamente uma fada que trazia o orvalho da manh√£, Glacia foi corrompida quando um estudante tentou aprisionar o frio em um frasco. Agora, ela protege o Pico de Cristal, acreditando que qualquer estranho √© um ladr√£o de ess√™ncia √°rtica.", env:"env-glacia", phrases:["Voc√™ vai congelar!", "Minha neve ser√° seu t√∫mulo.", "Sinta o abra√ßo g√©lido.", "O inverno n√£o perdoa.", "Congele onde est√°!", "Sua alma ser√° gelo.", "A nevasca te cegar√°.", "Protegerei o Pico!"], missPhrases:["Sua mente congelou?", "Est√° tremendo?", "T√£o fr√°gil...", "Errou de novo?"] },
            { n:"Thalros", title:"O Tit√£ de Pedra", file:"golem_pedra.png", color:"#d35400", lore:"Thalros n√£o foi constru√≠do para lutar, mas para servir de biblioteca viva para as primeiras runas de prote√ß√£o. Com o tempo, o musgo cobriu suas escrituras e ele esqueceu os comandos de desativa√ß√£o. Ele esmaga qualquer um que considere uma amea√ßa ao conhecimento antigo.", env:"env-thalros", phrases:["Esmagar intruso!", "Sua magia √© fraca contra rocha.", "Volte ao p√≥!", "Acesso negado.", "Runa de prote√ß√£o ativa.", "Voc√™ √© fr√°gil.", "A montanha n√£o se move.", "Intruso detectado."], missPhrases:["Cabe√ßa dura.", "N√£o aprende?", "Fraco.", "Esmagar erro."] },
            { n:"Umbra", title:"O Eco do Abismo", file:"espectro_sombras.png", color:"#8e44ad", lore:"Umbra √© a am√°lgama dos medos deixados para tr√°s por alunos que falharam. Ela n√£o possui forma f√≠sica constante, habitando as sombras dos corredores proibidos e alimentando-se da hesita√ß√£o de quem ousa atravess√°-los.", env:"env-umbra", phrases:["Seu medo tem cheiro doce...", "Abrace a escurid√£o.", "N√£o h√° luz aqui.", "Voc√™ est√° sozinho...", "A luz est√° morrendo.", "Seus pesadelos s√£o reais.", "Junte-se ao vazio.", "Ningu√©m ouvir√° seus gritos."], missPhrases:["O medo cega.", "Sua mente falha.", "Desista.", "Perdido..."] },
            { n:"Ferrum", title:"O Golem de Ferro", file:"gargula_ferro.png", color:"#7f8c8d", lore:"Forjado durante a Grande Guerra M√°gica para ser indestrut√≠vel. Ele √© uma m√°quina de guerra movida por um feiti√ßo de sangue que o obriga a guardar o port√£o principal at√© que seu mestre ‚Äî morto h√° s√©culos ‚Äî o dispense.", env:"env-ferrum", phrases:["Exterm√≠nio: Ativado.", "Carne √© fraca. A√ßo √© eterno.", "Eliminar intruso.", "Protocolo de defesa.", "Sem miseric√≥rdia.", "Alvo travado.", "Sua magia falhar√°.", "O port√£o permanece fechado."], missPhrases:["Ineficiente.", "Falha detectada.", "Erro.", "Recalculando..."] },
            { n:"Solari", title:"A F√™nix Renascida", file:"fenix_fogo.png", color:"#e67e22", lore:"Solari surge apenas quando a magia da academia est√° inst√°vel. Sua luz √© t√£o intensa que pode cegar os impuros. Para os her√≥is, derrot√°-la n√£o √© um ato de viol√™ncia, mas um teste de resist√™ncia ao calor absoluto.", env:"env-solari", phrases:["Queime na verdade!", "O fogo purifica.", "Cinzas √†s cinzas.", "A chama eterna!", "N√£o h√° sombra sob minha luz.", "Renascerei das suas cinzas.", "O calor √© insuport√°vel?", "Purifica√ß√£o iminente."], missPhrases:["A luz ofusca?", "Cego?", "Tente focar.", "Queime seu erro."] },
            { n:"Aurelius", title:"O Drag√£o da Gan√¢ncia", file:"dragao_dourado.png", color:"#f1c40f", lore:"Um drag√£o que se apaixonou pelos tesouros da escola. A magia acumulada fundiu o ouro de sua toca diretamente em suas escamas. Ele v√™ cada item do seu invent√°rio como uma joia que deve pertencer a ele.", env:"env-aurelius", phrases:["Meu tesouro!", "Vou derreter sua armadura.", "Ladr√£ozinho!", "Tudo o que brilha √© meu.", "N√£o toque no meu ouro!", "Voc√™ pagar√° com a vida.", "Gan√¢ncia √© virtude.", "Vou te transformar em est√°tua dourada."], missPhrases:["N√£o toque!", "Tolo.", "Isso n√£o √© seu.", "M√£os desajeitadas."] },
            { n:"Malakor", title:"O Feiticeiro Sombrio", file:"feiticeiro_trevas.png", color:"#2c3e50", lore:"O maior vil√£o da hist√≥ria da academia. Malakor foi o diretor mais brilhante, mas sua obsess√£o pela imortalidade o corrompeu. Agora ele √© uma casca de poder arcano, drenando a magia da ilha para sustentar sua exist√™ncia.", env:"env-malakor", phrases:["Eu vi a verdade.", "Sua magia √© pat√©tica.", "Curve-se!", "Eu sou o diretor eterno!", "Conhecimento proibido.", "Sua mente √© fraca.", "A morte √© apenas o come√ßo.", "Testemunhe o verdadeiro poder."], missPhrases:["Pat√©tico.", "Mente fraca.", "Desapontador.", "Estude mais."] },
            { n:"Sertis", title:"A Serpente do Veneno", file:"basilisco.png", color:"#27ae60", lore:"Nos esgotos, o descarte de po√ß√µes falhas criou Sertis. Esta serpente colossal sofreu muta√ß√µes qu√≠micas, desenvolvendo um veneno que n√£o apenas mata o corpo, mas corrompe a pr√≥pria mana da v√≠tima.", env:"env-sertis", phrases:["Ssssil√™ncio...", "Sinta o veneno.", "N√£o olhe meus olhos.", "O veneno corre...", "Sssufocante...", "Apodre√ßa.", "Minhas presas te acharam.", "T√≥xico..."], missPhrases:["Confuso?", "Tonto...", "O veneno age.", "Sssseu fim..."] },
            { n:"Trion", title:"A Quimera Ca√≥tica", file:"quimera.png", color:"#c0392b", lore:"Um experimento de fus√£o falho. Trion possui tr√™s mentes em um corpo, cada uma lutando pelo controle. O le√£o ruge por for√ßa, o lobo por instinto e a serpente por mal√≠cia. Seus ataques s√£o imprevis√≠veis.", env:"env-trion", phrases:["Rugido! Uivo! Sibilado!", "Caos encarnado!", "Despeda√ßar!", "Tr√™s mentes, um prop√≥sito!", "A presa foge!", "Ca√ßar! Matar! Devorar!", "Qual cabe√ßa te comer√°?", "Instinto puro!"], missPhrases:["Perdido?", "Qual deles?", "Errado!", "Presa f√°cil."] },
            { n:"Gaiaos", title:"O Esp√≠rito da Terra", file:"elemental_terra.png", color:"#795548", lore:"Gaiaos √© a pr√≥pria ilha se levantando contra os magos. Ele sente a dor da minera√ß√£o de cristais e v√™ a academia como um parasita. Ele representa a f√∫ria final da natureza contra a manipula√ß√£o m√°gica.", env:"env-gaiaos", phrases:["A natureza cobra.", "Retorne ao solo!", "F√∫ria antiga.", "A ilha sangra.", "Magos s√£o parasitas.", "Sinta o peso do mundo.", "Ra√≠zes te prender√£o.", "A terra reclama o que √© dela."], missPhrases:["Perdido?", "A terra rejeita.", "Saia!", "Trope√ßou?"] }
        ];

        const items = ['‚öîÔ∏è', 'üõ°Ô∏è', 'üß™', 'üìú', 'üíé', 'üíç', 'üîÆ', 'üóùÔ∏è', 'üåô', 'üî•', '‚ö°', 'üëÅÔ∏è', 'üï∏Ô∏è', 'üëë', 'ü©∏', '‚öñÔ∏è'];
        
        // BASE DE DADOS EXPANDIDA (50 PERGUNTAS)
        const triviaDB = [
            // Geral & Alquimia
            {p:"Qual destes n√£o √© um elemento cl√°ssico?", o:["Fogo","Vento","Metal"], r:2},
            {p:"O que alquimistas buscavam?", o:["Pedra Filosofal","Ouro L√≠quido","Vida Eterna"], r:0},
            {p:"Qual metal √© t√≥xico para fadas?", o:["Ouro","Ferro Frio","Prata"], r:1},
            {p:"O que √© um Grim√≥rio?", o:["Livro de Receitas","Livro M√°gico","Di√°rio"], r:1},
            {p:"Qual a forma de um c√≠rculo m√°gico?", o:["Quadrado","Triangular","Redondo"], r:2},
            {p:"O que √© Mana?", o:["Energia M√°gica","Moeda","Comida"], r:0},
            {p:"Qual joia armazena mais magia?", o:["Diamante","Cristal","Carv√£o"], r:1},
            {p:"Transmuta√ß√£o altera o qu√™?", o:["A Forma","O Tempo","A Alma"], r:0},
            {p:"Qual destes √© um ingrediente de po√ß√£o?", o:["Raiz de Mandr√°gora","Pedra de Cal√ßada","Vidro"], r:0},
            {p:"Onde po√ß√µes s√£o preparadas?", o:["Forno","Caldeir√£o","Frasco"], r:1},

            // Criaturas
            {p:"Qual criatura renasce das cinzas?", o:["Drag√£o","F√™nix","Grifo"], r:1},
            {p:"Qual criatura petrifica com o olhar?", o:["Basilisco","Medusa","G√≥rgona"], r:0},
            {p:"O que o Lobisomem teme?", o:["Prata","Alho","Luz"], r:0},
            {p:"Qual criatura guarda tesouros?", o:["Duende","Drag√£o","Sereia"], r:1},
            {p:"O que √© um Centauro?", o:["Meio Homem Meio Cavalo","Meio Peixe","Meio Bode"], r:0},
            {p:"Qual criatura canta para atrair marinheiros?", o:["Harpia","Sereia","Banshee"], r:1},
            {p:"O que √© um Golem?", o:["Ser Artificial","Fantasma","Dem√¥nio"], r:0},
            {p:"Qual criatura chupa sangue?", o:["Zumbi","Vampiro","M√∫mia"], r:1},
            {p:"O que √© um Grifo?", o:["Le√£o e √Åguia","Lobo e Urso","Cobra e P√°ssaro"], r:0},
            {p:"Qual criatura vive em vulc√µes?", o:["Salamandra","Yeti","Kraken"], r:0},

            // Ferramentas & Magia
            {p:"Qual destes √© uma ferramenta de adivinha√ß√£o?", o:["Bola de Cristal","Varinha","Caldeir√£o"], r:0},
            {p:"O que bruxas usam para voar?", o:["Tapetes","Vassouras","Arbustos"], r:1},
            {p:"Qual √© o s√≠mbolo da realeza?", o:["Coroa","Cetro","Anel"], r:0},
            {p:"Necromancia lida com o qu√™?", o:["Vida","Mortos","Plantas"], r:1},
            {p:"Piromancia controla o qu√™?", o:["Gelo","Fogo","Raio"], r:1},
            {p:"O que faz uma Varinha?", o:["Canaliza Magia","Gera Ouro","Corta Pedra"], r:0},
            {p:"Qual carta prev√™ a morte?", o:["O Louco","A Torre","A Morte"], r:2},
            {p:"O que s√£o Runas?", o:["Alfabeto M√°gico","Pedras","Moedas"], r:0},
            {p:"Qual po√ß√£o cura feridas?", o:["Veneno","Elixir de Vida","Po√ß√£o de Cura"], r:2},
            {p:"O que reflete feiti√ßos?", o:["Espelho M√°gico","Escudo de Madeira","√Ågua"], r:0},

            // Lore do Jogo (Bosses)
            {p:"Quem √© a Sentinela do Inverno?", o:["Glacia","Sertis","Umbra"], r:0},
            {p:"De que √© feito Thalros?", o:["Carne","Pedra","Ferro"], r:1},
            {p:"Onde vive Sertis?", o:["Torre","Esgotos","Floresta"], r:1},
            {p:"Qual o pecado de Aurelius?", o:["Ira","Gan√¢ncia","Pregui√ßa"], r:1},
            {p:"Quantas cabe√ßas tem Trion?", o:["Uma","Duas","Tr√™s"], r:2},
            {p:"Quem foi o diretor corrompido?", o:["Malakor","Merlin","Gandalf"], r:0},
            {p:"O que Ferrum guarda?", o:["O Port√£o","O Tesouro","A Biblioteca"], r:0},
            {p:"Qual elemento de Solari?", o:["Gelo","Fogo","Sombra"], r:1},
            {p:"O que Umbra representa?", o:["Medo","Coragem","Sabedoria"], r:0},
            {p:"Gaiaos √© o esp√≠rito de qu√™?", o:["Ar","Terra","√Ågua"], r:1},

            // Mec√¢nicas do Jogo
            {p:"Qual a cor da magia do caos neste jogo?", o:["Azul","Roxo","Verde"], r:1},
            {p:"Quantos segundos tem a fase?", o:["50","60","90"], r:1},
            {p:"O que acontece se o tempo acabar?", o:["Game Over","Quiz","Nada"], r:1},
            {p:"Qual item d√° XP extra?", o:["L√°grima de F√™nix","Ouro","Carta"], r:0},
            {p:"Quantas cartas tem no tabuleiro?", o:["12","16","20"], r:1},
            {p:"Qual o nome da Academia?", o:["Arcane Academy","Hogwarts","Luna Nova"], r:0},
            {p:"O que o modo F√∫ria faz?", o:["Triplica Pontos","Para o Tempo","Mata Boss"], r:0},
            {p:"O que quebra seu combo?", o:["Errar Par","Acertar Par","Nada"], r:0},
            {p:"Qual n√≠vel libera skins de Diamante?", o:["10","20","40"], r:2},
            {p:"Qual boss √© um Drag√£o?", o:["Aurelius","Solari","Trion"], r:0}
        ];

        // 50 Achievements (Resumidos para caber, l√≥gica mantida)
        const achievementsDB = [
            {id:'win_1',icon:'‚ú®',title:'Iniciado',desc:'Ven√ßa a Fase 1.'}, {id:'win_5',icon:'üî•',title:'Intermedi√°rio',desc:'Ven√ßa a Fase 5.'}, {id:'win_10',icon:'üëë',title:'O Fim do In√≠cio',desc:'Complete o Modo Hist√≥ria.'},
            {id:'lvl_5',icon:'üìú',title:'Estudante',desc:'Alcance N√≠vel 5.'}, {id:'lvl_10',icon:'üìò',title:'Adepto',desc:'Alcance N√≠vel 10.'}, {id:'lvl_25',icon:'üßô‚Äç‚ôÇÔ∏è',title:'Mago',desc:'Alcance N√≠vel 25.'}, {id:'lvl_50',icon:'üîÆ',title:'Arquimago',desc:'Alcance N√≠vel 50.'}, {id:'lvl_100',icon:'üåü',title:'Lenda',desc:'Alcance N√≠vel 100.'},
            {id:'combo_3',icon:'‚ö°',title:'R√°pido',desc:'Combo 3x.'}, {id:'combo_5',icon:'üå©Ô∏è',title:'Rel√¢mpago',desc:'Combo 5x.'}, {id:'combo_10',icon:'üî•',title:'Impar√°vel',desc:'Combo 10x.'}, {id:'score_1k',icon:'üíé',title:'Tesouro',desc:'1k pts.'}, {id:'score_5k',icon:'üëë',title:'Magnata',desc:'5k pts.'},
            {id:'kill_glacia',icon:'‚ùÑÔ∏è',title:'Quebra-Gelo',desc:'Derrote Glacia.'}, {id:'kill_thalros',icon:'ü™®',title:'Demolidor',desc:'Derrote Thalros.'}, {id:'kill_umbra',icon:'üåë',title:'Iluminado',desc:'Derrote Umbra.'}, {id:'kill_ferrum',icon:'‚öôÔ∏è',title:'Ferrugem',desc:'Derrote Ferrum.'}, {id:'kill_solari',icon:'‚òÄÔ∏è',title:'Extintor',desc:'Derrote Solari.'},
            {id:'kill_aurelius',icon:'üêâ',title:'Matador',desc:'Derrote Aurelius.'}, {id:'kill_malakor',icon:'‚ò†Ô∏è',title:'Justi√ßa',desc:'Derrote Malakor.'}, {id:'kill_sertis',icon:'üêç',title:'Ant√≠doto',desc:'Derrote Sertis.'}, {id:'kill_trion',icon:'ü¶Å',title:'Domador',desc:'Derrote Trion.'}, {id:'kill_gaiaos',icon:'üåç',title:'Terra',desc:'Derrote Gaiaos.'},
            {id:'quiz_win',icon:'üß†',title:'S√°bio',desc:'Acerte Quiz.'}, {id:'chaos_survivor',icon:'üåÄ',title:'Ordem',desc:'Ven√ßa no Caos.'}, {id:'low_hp',icon:'‚ù§Ô∏è‚Äçü©π',title:'Fio',desc:'Ven√ßa com 1 HP.'}, {id:'speedster',icon:'üëü',title:'Ligeiro',desc:'Ven√ßa < 25s.'}, {id:'veteran_10',icon:'üéñÔ∏è',title:'Veterano I',desc:'10 Jogos.'}, {id:'veteran_50',icon:'üèÖ',title:'Veterano II',desc:'50 Jogos.'},
            {id:'infinite_15',icon:'‚ôæÔ∏è',title:'Eterno',desc:'Fase 15 Infinito.'}, {id:'completionist',icon:'üìñ',title:'Historiador',desc:'Grim√≥rio Completo.'}, {id:'collector',icon:'üÉè',title:'Colecionador',desc:'Todas Skins.'}, {id:'fashion',icon:'üßô‚Äç‚ôÄÔ∏è',title:'Estiloso',desc:'Todos Avatares.'}
        ];

        // --- 2. GERENCIAMENTO DE √ÅUDIO ---
        const sfx = { flip:new Audio('Sons/flip.mp3'), match:new Audio('Sons/match.mp3'), win:new Audio('Sons/win.mp3'), click:new Audio('Sons/click.mp3'), chaos:new Audio('Sons/chaos.mp3'), swear:new Audio('Sons/raio.mp3'), achievement:new Audio('Sons/win.mp3'), alohomora:new Audio('Sons/alohomora.mp3'), combo:new Audio('Sons/combo.mp3'), expelliarmus:new Audio('Sons/expelliarmus.mp3'), thunder:new Audio('Sons/raio.mp3'), owl:new Audio('Sons/owl.mp3'), paper:new Audio('Sons/paper.mp3'), teleport:new Audio('Sons/teleport.mp3'), bookOpen:new Audio('Sons/paper.mp3') };
        class AudioManager { 
            constructor(){this.bgMusic=null;this.gameMusic=null;this.ambMenu=null;}
            init(){this.bgMusic=document.getElementById('ost-menu');this.gameMusic=document.getElementById('ost-game');this.ambMenu=document.getElementById('amb-menu');this.bgMusic.volume=0.2;this.gameMusic.volume=0.2;if(this.ambMenu)this.ambMenu.volume=0.3;}
            playMenu(){if(this.gameMusic)this.gameMusic.pause();if(this.bgMusic){this.bgMusic.currentTime=0;this.bgMusic.play().catch(()=>{});}if(this.ambMenu){this.ambMenu.currentTime=0;this.ambMenu.play().catch(()=>{});}} 
            playGame(){if(this.bgMusic)this.bgMusic.pause();if(this.ambMenu)this.ambMenu.pause();if(this.gameMusic){this.gameMusic.currentTime=0;this.gameMusic.play().catch(()=>{});}} 
            stopAll(){if(this.bgMusic)this.bgMusic.pause();if(this.gameMusic)this.gameMusic.pause();if(this.ambMenu)this.ambMenu.pause();} 
            updateVolume(){if(this.bgMusic)this.bgMusic.volume=cfg.m;if(this.gameMusic)this.gameMusic.volume=cfg.m;if(this.ambMenu)this.ambMenu.volume=cfg.s*0.6;} 
        } 
        const audioManager = new AudioManager();

        // --- 3. ESTADO GLOBAL ---
        let currentSlotPrefix = "";
        const DB = {
            getItem: (k) => { if(k==='aa_cfg') return localStorage.getItem(k); return localStorage.getItem(currentSlotPrefix + k); },
            setItem: (k,v) => { if(k==='aa_cfg') return localStorage.setItem(k,v); return localStorage.setItem(currentSlotPrefix + k, v); },
            removeItem: (k) => { if(k==='aa_cfg') return localStorage.removeItem(k); return localStorage.removeItem(currentSlotPrefix + k); }
        };

        let globalData = null;
        let prof = null;
        let justUnlockedGrimoire = false;
        let pendingDeleteId = null;

        function initProfileData() {
            globalData = JSON.parse(DB.getItem('aa_global')) || { achievements: [], infiniteHighScores: [] };
            prof = JSON.parse(DB.getItem('aa_prof')) || { nome: "Aprendiz", av: 0, lvl: 1, xp: 0, maxScore: 0, totalGames: 0, quizStreak: 0, grimoireUnlocked: false, ngPlusUnlocked: false, infiniteUnlocked: false, wins: 0, bossKills: {}, playTime: 0 };
            if(typeof prof.frame === 'undefined') prof.frame = 0;
            if(typeof prof.wins === 'undefined') prof.wins = 0;
            if(typeof prof.bossKills === 'undefined') prof.bossKills = {};
            if(typeof prof.playTime === 'undefined') prof.playTime = 0;
            if(typeof prof.levelRecords === 'undefined') prof.levelRecords = {};
            if(!globalData.achievements) globalData.achievements = [];
        }

        let cfg = JSON.parse(localStorage.getItem('aa_cfg')) || { m: CONFIG_DEFAULTS.MUSIC_VOL, s: CONFIG_DEFAULTS.SFX_VOL, part: CONFIG_DEFAULTS.PARTICLES };
        let game = { fase: 1, score: 0, infiniteMode: false, chaosActive: false, ngPlus: false };
        
        let cartas=[], pares=0, total=0, travado=false, hp=0, hpMax=0, combo=0, missCombo=0, tempo=0, timer=null, chaosTimer=null, tauntTimer=null, lastScreen='screen-menu', currentBossIndex=0;
        let afkTimer, lastMatch = 0, currentBookPage = 0, bleedInterval = null, chaosInternalTimer = null, speechHideTimer = null, typewriterTimer = null;

        // --- 4. INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            UI.init();
            audioManager.init();
            initWeatherSystem(); 
            initProfileData();
            updateProfUI(); 
            applySettings(); 
            checkSave();
            checkAchievements('startup');
            initAudioVisualizer();
            
            const vid = document.getElementById('intro-video'); vid.muted=true; vid.loop=true; vid.play().catch(()=>{});
            gsap.to("#start-btn-intro", { opacity: 1, duration: 1, delay: 0.5 });
            document.addEventListener("mousemove", (e) => {
                resetAFKTimer();
                // Menu Particles
                if(document.getElementById('screen-menu').style.display !== 'none' && cfg.part) {
                    createMenuParticle(e.clientX, e.clientY);
                }
            }); resetAFKTimer();
        });

        function initSlots() {
            const c = document.getElementById('slots-list'); c.innerHTML = '';
            for(let i=1; i<=3; i++) {
                const pKey = `slot_${i}_aa_prof`;
                const pData = JSON.parse(localStorage.getItem(pKey));
                let html = '';
                if(pData) {
                    const av = avatares[pData.av] || avatares[0];
                    html = `<div class="btn-delete-slot" onclick="event.stopPropagation(); deleteSlot(${i})">‚úñ</div>
                            <img src="Imagens/Personagens/${av.file}" class="slot-avatar" style="border-color:${av.color}; width:80px; height:80px;">
                            <div class="slot-info"><div class="slot-name">${pData.nome}</div><div>N√≠vel ${pData.lvl}</div></div>`;
                } else {
                    html = `<div class="slot-avatar" style="background:#111; display:flex; align-items:center; justify-content:center; font-size:2rem; color:#333;">+</div>
                            <div class="slot-info"><div class="slot-name" style="color:#666;">Novo Jogo</div><div>Slot ${i}</div></div>`;
                }
                const div = document.createElement('div'); div.className = 'slot-card'; div.id = `slot-card-${i}`; div.innerHTML = html;
                div.onclick = () => loadSlot(i); c.appendChild(div);
            }
            
            // Anima√ß√£o de Entrada (Stagger)
            gsap.fromTo(".slot-card", 
                { y: 50, opacity: 0, scale: 0.8 }, 
                { y: 0, opacity: 1, scale: 1, duration: 0.6, stagger: 0.15, ease: "back.out(1.5)", delay: 0.1, clearProps: "transform,opacity,scale" }
            );
        }

        function deleteSlot(i) {
            pendingDeleteId = i;
            playS('click');
            document.getElementById('modal-delete-confirm').style.display = 'flex';
        }

        function closeDeleteModal() { document.getElementById('modal-delete-confirm').style.display = 'none'; pendingDeleteId = null; }

        function executeDeleteSlot() {
            const i = pendingDeleteId;
            closeDeleteModal();
            if (i === null) return;

            const el = document.getElementById(`slot-card-${i}`);
            if(el) {
                playS('chaos'); // Som de destrui√ß√£o
                
                // Efeito de Part√≠culas (Desintegra√ß√£o)
                const rect = el.getBoundingClientRect();
                for(let j=0; j<40; j++) {
                    const p = document.createElement('div');
                    p.style.cssText = `position:fixed; left:${rect.left + Math.random() * rect.width}px; top:${rect.top + Math.random() * rect.height}px; width:${Math.random()*5+2}px; height:${Math.random()*5+2}px; background:#555; border-radius:50%; z-index:30001; pointer-events:none;`;
                    document.body.appendChild(p);
                    gsap.to(p, { x: (Math.random()-0.5)*150, y: (Math.random()-0.5)*150, opacity: 0, scale: 0, duration: 0.6 + Math.random()*0.4, ease: "power2.out", onComplete: () => p.remove() });
                }

                // Anima√ß√£o do Card
                gsap.to(el, {
                    scale: 0.9, opacity: 0, filter: "grayscale(1) blur(10px)", duration: 0.5, ease: "power2.in",
                    onComplete: () => {
                        localStorage.removeItem(`slot_${i}_aa_prof`); localStorage.removeItem(`slot_${i}_aa_save`); localStorage.removeItem(`slot_${i}_aa_global`); initSlots();
                    }
                });
            } else {
                localStorage.removeItem(`slot_${i}_aa_prof`); localStorage.removeItem(`slot_${i}_aa_save`); localStorage.removeItem(`slot_${i}_aa_global`); initSlots();
            }
        }

        function loadSlot(i) {
            playS('click');
            const fade = document.getElementById('fade-layer');
            fade.style.zIndex = 40000; // Garante prioridade sobre a tela de slots
            fade.classList.add('fade-active');

            setTimeout(() => {
                currentSlotPrefix = `slot_${i}_`;
                initProfileData();
                updateProfUI(); checkSave(); checkAchievements('startup');
                document.getElementById('screen-slots').style.display = 'none';
                
                navegar('screen-profile');
                if(prof.nome!=="Aprendiz"){document.getElementById('profile-edit').style.display='none';document.getElementById('profile-dash').style.display='block';}else{document.getElementById('profile-edit').style.display='block';document.getElementById('profile-dash').style.display='none';}
                
                setTimeout(() => {
                    fade.classList.remove('fade-active');
                    setTimeout(() => { fade.style.zIndex = ''; }, 800);
                }, 200);
            }, 800);
        }

        // --- 5. NAVEGA√á√ÉO E FLUXO ---
        function playIntroSound() { const vid=document.getElementById('intro-video'); vid.muted=false; vid.loop=false; vid.currentTime=0; vid.play(); document.getElementById('start-btn-intro').style.display='none'; document.getElementById('skip-text').style.display='block'; vid.onended=endIntro; }
        function endIntro() { document.getElementById('intro-video').pause(); gsap.to('#screen-intro', {opacity:0, duration:1, onComplete:()=>{ document.getElementById('screen-intro').style.display='none'; navegar('screen-menu'); audioManager.playMenu(); animateMenuEntrance(); }}); }
        
        function navegar(id) { document.querySelectorAll('.screen').forEach(s=>{s.classList.remove('active');s.style.display='none';}); const t=document.getElementById(id); if(t){t.style.display='flex';setTimeout(()=>t.classList.add('active'),10);} }
        
        function novoJogo(isNgPlus = false) { if(prof.nome==="Aprendiz"){notificar("Configure seu perfil!");abrirPerfilMenu();return;} DB.removeItem('aa_save'); game={fase:1,score:0,infiniteMode:false,chaosActive:false, ngPlus: isNgPlus}; prof.totalGames++; DB.setItem('aa_prof',JSON.stringify(prof)); checkAchievements('game_start'); audioManager.playGame(); transitionFase(1); }
        function iniciarNewGamePlus() { playS('click'); document.getElementById('modal-ngplus').style.display = 'flex'; }
        function confirmNewGamePlus() { document.getElementById('modal-ngplus').style.display = 'none'; novoJogo(true); }
        function continuarJogo() { const s=JSON.parse(DB.getItem('aa_save')); if(s){game=s;audioManager.playGame();transitionFase(game.fase);} }

        function transitionFase(f) {
            playS('teleport');
            playPortalEffect(() => {
                UI.screens.menu.style.display = 'none'; navegar('screen-game'); 
                try { carregarFase(f); } catch(e) { console.error(e); sairParaMenu(); }
            });
        }

        function carregarFase(f) {
            game.fase = f; UI.hud.fase.innerText = f; UI.hud.score.innerText = game.score; UI.board.innerHTML = '';
            let bIdx = (f-1)%bosses.length; if(game.infiniteMode) bIdx = Math.floor(Math.random()*bosses.length); currentBossIndex = bIdx; const b = bosses[bIdx];
            document.getElementById('boss-img-tag').src = `Imagens/Monstros/${b.file}`; document.getElementById('boss-n').innerText = b.n; document.getElementById('boss-n').style.textShadow = "0 0 20px " + b.color; document.getElementById('dynamic-bg-layer').className = b.env;
            
            let n = 16;
            if (game.ngPlus) n = 24;
            if (game.infiniteMode) { n = 16; if(f > 5) n = 20; if(f > 10) n = 24; } // Dificuldade Progressiva no Infinito
            
            const p=n/2; hpMax=p; hp=p; updateHP(); total=p; pares=0; cartas=[]; travado=false; combo=0; missCombo=0;
            clearInterval(bleedInterval); // Limpa sangramento anterior
            
            let gridClass = 'grid-4'; if(n===20) gridClass='grid-5'; if(n===24) gridClass='grid-6';
            const rewards = getRewards(prof.lvl);
            UI.board.className = `card-grid ${gridClass} ${rewards.cardSkin}`;
            game.startTime = Date.now();
            
            let deck = items.slice(0, p); deck = [...deck, ...deck].sort(()=>Math.random()-0.5);
            deck.forEach(icon => {
                const wrapper = document.createElement('div'); wrapper.className = 'card-wrapper';
                const c = document.createElement('div'); c.className = 'card'; 
                c.dataset.icon = icon; 
                c.innerHTML = `<div class="face front">${icon}</div><div class="face back"></div>`;
                c.onclick = () => cardClick(c, icon); 
                wrapper.appendChild(c);
                UI.board.appendChild(wrapper);
            });
            clearInterval(timer); startTimer(game.ngPlus ? 45 : 60); // NG+ tem 45s
            scheduleNextChaos(); scheduleTaunt(); if(!game.infiniteMode) DB.setItem('aa_save', JSON.stringify(game));
        }

        function cardClick(c, val) {
            if(travado || game.chaosActive || c.classList.contains('flipped')) return;
            
            playS('flip');
            // Eleva a carta visualmente durante o giro
            c.parentElement.style.zIndex = "100";
            c.classList.add('flipped'); cartas.push({el:c, v:val});
            
            gsap.to(c, {rotateY: 180, duration: 0.5, ease: "back.out(1.5)"});
            
            if(cartas.length === 2) {
                travado = true; const [c1, c2] = cartas;
                if(c1.v === c2.v) {
                    playS('match'); c1.el.classList.add('matched'); c2.el.classList.add('matched'); pares++; hp--; updateHP(); missCombo=0;
                    const now = Date.now(); if(now-lastMatch < 3000) { combo++; showCombo(combo); } else { combo=1; } lastMatch = now;
                    
                    // FURY SYSTEM
                    let isFury = combo >= 3;
                    if(isFury) {
                        UI.board.classList.add('fury-active');
                        if(combo === 5) notificar("F√öRIA ARCANA ATIVADA!");
                    }

                    // Boss Shake & Flash FX
                    gsap.fromTo(".boss-hp-bg", {x:-5}, {x:5, duration:0.05, repeat:5, yoyo:true, clearProps:"x"});
                    gsap.fromTo("#hp-bar", {filter:"brightness(2)"}, {filter:"brightness(1)", duration:0.3, clearProps:"filter"});

                    let pts = Math.floor(100*combo); 
                    if(isFury) pts *= 3; // Triplo de pontos na F√∫ria
                    
                    game.score+=pts; document.getElementById('ui-score').innerText=game.score; showFloatScore(c1.el, pts);
                    if(cfg.part) createMagicBurst(c1.el.getBoundingClientRect().left, c1.el.getBoundingClientRect().top);
                    cartas=[]; travado=false;
                    if(pares === total) { clearInterval(timer); document.getElementById('time-warning-layer').classList.remove('active'); clearTimeout(chaosTimer); clearTimeout(tauntTimer); setTimeout(() => { playS('win'); finishStage(); }, 1000); }
                } else {
                    if(combo >= 2) triggerComboBreaker(); // S√≥ ativa se realmente quebrar um combo (sequ√™ncia >= 2)
                    combo=0; 
                    missCombo++;
                    if(missCombo >= 3) { triggerBossReaction('miss'); missCombo = 0; }

                    UI.board.classList.remove('fury-active');
                    setTimeout(()=>{
                        gsap.to([c1.el, c2.el], {
                            rotateY: 0, duration: 0.4, ease: "power2.inOut",
                            onComplete: () => { c1.el.parentElement.style.zIndex = ""; c2.el.parentElement.style.zIndex = ""; }
                        });
                        c1.el.classList.remove('flipped'); c2.el.classList.remove('flipped'); cartas=[]; travado=false;
                    }, 1000);
                }
            }
        }

        function finishStage() {
            if(game.startTime) {
                const timeSpent = (Date.now() - game.startTime) / 1000;
                if(!prof.levelRecords) prof.levelRecords = {};
                if(!prof.levelRecords[game.fase] || timeSpent < prof.levelRecords[game.fase]) {
                    prof.levelRecords[game.fase] = timeSpent;
                }
            }
            const xpGained = 100 + (game.score/10); prof.xp += xpGained;
            let msg = `Vit√≥ria! +${Math.floor(xpGained)} XP.`;
            if(game.score > prof.maxScore) prof.maxScore = game.score;
            
            const bName = bosses[currentBossIndex].n; prof.bossKills[bName] = (prof.bossKills[bName] || 0) + 1;
            
            // Limpeza de intervalos (Sangramento, etc)
            clearInterval(bleedInterval);

            // 2¬∞ ZERAMENTO DO JOGO (Fase 10 - Gaiaos)
            if(game.fase >= 10 && !game.infiniteMode) {
                prof.xp += 2000; // B√¥nus de Zeramento
                if(prof.xp >= prof.lvl*100 && prof.lvl < 100) { prof.xp=0; prof.lvl++; checkAchievements('levelup'); }
                DB.setItem('aa_prof', JSON.stringify(prof));
                updateProfUI();
                completeGame();
                return;
            }

            if(prof.xp >= prof.lvl*100 && prof.lvl < 100) { prof.xp=0; prof.lvl++; msg = `LEVEL UP! N√≠vel ${prof.lvl}!`; checkAchievements('levelup'); triggerLevelUpFX(); }
            DB.setItem('aa_prof', JSON.stringify(prof)); updateProfUI();
            
            notificar(msg);
            playS('win');
            
            setTimeout(() => {
                transitionFase(game.fase+1);
            }, 3000);
        }

        function completeGame() {
            playS('win');
            prof.wins = (prof.wins || 0) + 1;
            
            // Desbloqueia Grim√≥rio
            if(!prof.grimoireUnlocked) {
                prof.grimoireUnlocked = true;
                prof.ngPlusUnlocked = true; // Desbloqueia NG+
                prof.infiniteUnlocked = true; // Desbloqueia Infinito
                DB.setItem('aa_prof', JSON.stringify(prof));
                notificar("GRIM√ìRIO DESBLOQUEADO!");
                justUnlockedGrimoire = true; // Flag para anima√ß√£o
            } else {
                notificar("A JORNADA EST√Å COMPLETA!");
            }
            
            // 1¬∞ MECANISMO DE SAVE: Limpa o save da run atual pois o jogo foi conclu√≠do
            DB.removeItem('aa_save');
            checkSave();

            // Transi√ß√£o para o Grim√≥rio (Tela Final)
            toggleGrimoireWithMist('open', true);
        }

        function openInfiniteMenu() {
            const list = document.getElementById('infinite-ranking-list'); list.innerHTML = '';
            const scores = globalData.infiniteHighScores.sort((a,b) => b.score - a.score).slice(0, 10);
            if(scores.length === 0) list.innerHTML = `<div style="text-align:center; color:#666; font-style:italic;">Nenhum registro encontrado.</div>`;
            else scores.forEach((s, i) => {
                const color = i === 0 ? '#ffd700' : (i === 1 ? '#c0c0c0' : (i === 2 ? '#cd7f32' : '#aaa'));
                list.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:1.1rem;"><span style="color:${color}; font-weight:bold;">#${i+1} ${s.name}</span><span style="font-family:'Cinzel';">${s.score} pts (Fase ${s.fase})</span></div>`;
            });
            document.getElementById('modal-infinite').style.display = 'flex';
        }

        function startInfiniteRun() {
            document.getElementById('modal-infinite').style.display = 'none'; DB.removeItem('aa_save');
            game = { fase: 1, score: 0, infiniteMode: true, chaosActive: false, ngPlus: false };
            prof.totalGames++; DB.setItem('aa_prof', JSON.stringify(prof));
            audioManager.playGame(); transitionFase(1);
        }

        function gameOverInfinite() {
            playS('chaos'); // Som do Vazio
            const bh = document.getElementById('black-hole');
            const allCards = Array.from(document.querySelectorAll('.card-wrapper'));
            
            gsap.to(bh, { opacity: 1, scale: 2.5, duration: 1.5, ease: "power2.out" });
            allCards.forEach(w => {
                const rect = w.getBoundingClientRect();
                const dx = (window.innerWidth/2) - (rect.left + rect.width/2);
                const dy = (window.innerHeight/2) - (rect.top + rect.height/2);
                gsap.to(w, { x: dx, y: dy, scale: 0, rotation: 1080, opacity: 0, duration: 1.2, ease: "power4.in", delay: Math.random()*0.3 });
            });

            setTimeout(() => {
                const entry = { name: prof.nome, score: game.score, fase: game.fase, date: new Date().toLocaleDateString() };
                globalData.infiniteHighScores.push(entry); DB.setItem('aa_global', JSON.stringify(globalData));
                notificar("O Vazio consumiu tudo...");
                gsap.to(bh, { scale: 0, opacity: 0, duration: 0.5, delay: 0.5 });
                setTimeout(() => { sairParaMenu(); setTimeout(() => openInfiniteMenu(), 500); }, 2000);
            }, 2000);
        }

        // --- 6. MEC√ÇNICAS E UTILIT√ÅRIOS ---
        function startTimer(t) { 
            tempo=t; UI.hud.tempo.innerText=tempo; 
            document.getElementById('time-warning-layer').classList.remove('active');
            timer=setInterval(()=>{
                tempo--; UI.hud.tempo.innerText=tempo;
                prof.playTime = (prof.playTime || 0) + 1;
                if(tempo<=10) document.getElementById('time-warning-layer').classList.add('active');
                if(tempo<=0){ clearInterval(timer); document.getElementById('time-warning-layer').classList.remove('active'); quiz("Tempo Esgotado!"); }
            },1000); 
        }
        function updateHP() { 
            const pct = hp/hpMax;
            document.getElementById('hp-bar').style.width = (pct*100)+'%'; 
            
            // Sistema de Sangramento (Low HP)
            if(pct <= 0.3 && pct > 0) {
                if(!bleedInterval) bleedInterval = setInterval(spawnBossBleed, 200);
            } else {
                clearInterval(bleedInterval); bleedInterval = null;
            }
        }
        
        // Intervalo de Caos ajustado para 45s - 90s para n√£o frustrar o jogador
        function scheduleNextChaos() { clearTimeout(chaosTimer); const time = Math.random()*(90000-45000)+45000; chaosTimer = setTimeout(() => { triggerChaosShuffle(); scheduleNextChaos(); }, time); }
        function triggerChaosShuffle() {
            const validCards = Array.from(document.querySelectorAll('.card:not(.flipped):not(.matched)')); if(validCards.length<2) return;
            const wrappers = validCards.map(c => c.parentElement);
            game.chaosActive = true; playS('chaos'); notificar("O Vazio embaralha o destino...");
            validCards.forEach(c => c.classList.add('chaos-glow'));
            
            const bh = document.getElementById('black-hole');
            gsap.to(bh, { opacity: 1, scale: 1.5, duration: 0.5, ease: "back.out" });

            wrappers.forEach(w => {
                const rect = w.getBoundingClientRect();
                const dx = (window.innerWidth/2) - (rect.left + rect.width/2);
                const dy = (window.innerHeight/2) - (rect.top + rect.height/2);
                gsap.to(w, { x: dx, y: dy, scale: 0, rotation: 720, opacity: 0, duration: 0.8, ease: "power2.in", delay: Math.random()*0.1 });
            });

            chaosInternalTimer = setTimeout(() => {
                const icons = validCards.map(c => c.dataset.icon).sort(() => Math.random() - 0.5);
                validCards.forEach((c, i) => { c.dataset.icon = icons[i]; c.querySelector('.front').innerText = icons[i]; });
                
                gsap.to(wrappers, { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1, duration: 0.6, ease: "back.out(1.2)", stagger: 0.02, clearProps:"all", onComplete: () => { 
                    validCards.forEach(c => c.classList.remove('chaos-glow')); game.chaosActive = false; 
                    gsap.to(bh, { opacity: 0, scale: 0, duration: 0.5 });
                }});
            }, 1000);
        }

        function quiz(msg) { 
            clearInterval(timer); document.getElementById('time-warning-layer').classList.remove('active'); 
            
            // HOTFIX: Parar Mec√¢nicas de Caos e Resetar Visual
            clearTimeout(chaosTimer); clearTimeout(tauntTimer); clearTimeout(chaosInternalTimer);
            gsap.killTweensOf(".card-wrapper"); gsap.killTweensOf(".card"); gsap.killTweensOf("#black-hole");
            
            // Reseta o tabuleiro para estado limpo
            gsap.set(".card-wrapper", { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1, clearProps: "all" });
            gsap.set("#black-hole", { scale: 0, opacity: 0 });
            document.querySelectorAll('.chaos-glow').forEach(c => c.classList.remove('chaos-glow'));
            game.chaosActive = false;

            const m=document.getElementById('modal-quiz'); 
            const p=document.getElementById('quiz-paper'); 
            
            // Efeito Visual de Streak Alto (Brilho Dourado)
            if(prof.quizStreak >= 3) p.classList.add('streak-glow');
            else p.classList.remove('streak-glow');

            const q=triviaDB[Math.floor(Math.random()*triviaDB.length)]; 
            document.getElementById('quiz-q').innerText=q.p; 
            const c=document.getElementById('quiz-ops'); c.innerHTML=''; 
            q.o.forEach((op, i)=>{ const d=document.createElement('button'); d.className='quiz-opt-btn'; d.innerText=op; d.onclick=()=>{playS('click');if(i===q.r)quizSuccess();else quizFail();}; c.appendChild(d); }); 
            m.style.display='flex'; playS('paper'); 
            gsap.fromTo(p, {scale:0, rotation:-720, opacity:0}, {scale:1, rotation:0, opacity:1, duration:1, ease:"back.out"}); 
        }
        function quizSuccess() { 
            document.getElementById('modal-quiz').style.display='none'; 
            
            // Sistema de Streak (3 acertos = Item Raro)
            prof.quizStreak = (prof.quizStreak || 0) + 1;
            if(prof.quizStreak % 3 === 0) {
                notificar("Streak x3! Item Raro: L√°grima de F√™nix (+500 XP)");
                prof.xp += 500; playS('achievement');
            }
            
            finishStage();
        }
        function quizFail() { 
            if(game.infiniteMode) {
                document.getElementById('modal-quiz').style.display='none';
                gameOverInfinite();
                return;
            }
            prof.quizStreak = 0; DB.setItem('aa_prof', JSON.stringify(prof));
            playS('thunder'); 
            document.getElementById('modal-quiz').style.display='none'; 
            gsap.fromTo("#fx-overlay", {backgroundColor:"#fff", opacity:0.8}, {opacity:0, duration:0.8}); // Clar√£o
            gsap.to(".game-area", {x:"+=20", yoyo:true, repeat:10, duration:0.05, clearProps:"x"}); // Tremor
            if(game.fase > 1) { notificar("Falha cr√≠tica! -1 Fase"); setTimeout(() => transitionFase(game.fase - 1), 1500); }
            else { notificar("Expulso da Academia!"); setTimeout(() => sairParaMenu(), 1500); }
        }

        function playS(k, rate=1){
            if(sfx[k]){
                const s = sfx[k].cloneNode();
                if(k === 'paper' || k === 'bookOpen') s.playbackRate = 0.9 + Math.random() * 0.2; // Varia√ß√£o de pitch para realismo
                else s.playbackRate = rate;
                s.play().catch(()=>{});
            }
        }
        function notificar(msg){const b=document.getElementById('notif-bar');b.innerText=msg;b.classList.add('show');setTimeout(()=>b.classList.remove('show'),2500);}
        function showCombo(v){
            if(v<2)return;
            const c=document.getElementById('combo-container');
            const isFury = v >= 5;
            const scale = Math.min(1 + (v * 0.15), 3); // Cresce conforme o combo
            c.innerHTML=`<div class="combo-text ${isFury?'fury':''}">x${v}</div>`;
            playS('combo');
            gsap.fromTo(".combo-text",{scale:0, rotation:-15}, {scale:scale, rotation:0, duration:0.4, ease:"elastic.out(1, 0.5)", onComplete:()=>{ gsap.to(".combo-text", {opacity:0, duration:0.3, delay:0.3, onComplete:()=>c.innerHTML=''}); }});
        }
        function showFloatScore(el,pts){const r=el.getBoundingClientRect();const f=document.createElement('div');f.innerText="+"+pts;f.className='float-score';f.style.left=(r.left+r.width/2)+'px';f.style.top=r.top+'px';document.body.appendChild(f);gsap.to(f,{y:-50,opacity:0,duration:1,onComplete:()=>f.remove()});}
        
        function checkSave(){
            const s=DB.getItem('aa_save'); const b=document.getElementById('btn-continue');
            if(s) b.classList.remove('disabled'); else b.classList.add('disabled');
            
            // Verifica Grim√≥rio (S√≥ aparece se desbloqueado)
            const g=document.getElementById('btn-grimoire-menu'); 
            if(prof.grimoireUnlocked) {
                g.style.display='flex';
                if(justUnlockedGrimoire) g.classList.add('glow-gold');
            } else { g.style.display='none'; g.classList.remove('glow-gold'); }

            const ng=document.getElementById('btn-ngplus'); if(prof.ngPlusUnlocked) ng.style.display='flex'; else ng.style.display='none';
            const inf=document.getElementById('btn-infinite'); if(prof.infiniteUnlocked) inf.style.display='flex'; else inf.style.display='none';
            if(document.getElementById('screen-menu').style.display !== 'none') animateMenuEntrance();
        }
        
        function fecharJogo() { playS('click'); document.getElementById('exit-screen').style.display='flex'; setTimeout(()=>document.getElementById('exit-screen').style.opacity=1,10); setTimeout(()=>{ if(ipcRenderer)ipcRenderer.send('app-quit'); else window.close(); },2000); }
        function sairParaMenu() { clearInterval(timer); clearInterval(bleedInterval); document.getElementById('time-warning-layer').classList.remove('active'); clearTimeout(chaosTimer); clearTimeout(chaosInternalTimer); DB.setItem('aa_prof', JSON.stringify(prof)); audioManager.playMenu(); navegar('screen-menu'); checkSave(); document.getElementById('dynamic-bg-layer').className='env-default'; }
        function closeMagicAlert() { document.getElementById('magic-modal-content').classList.remove('show'); setTimeout(()=>document.getElementById('magic-alert-modal').style.display='none',300); }
        
        function abrirPerfilMenu(){ initSlots(); navegar('screen-slots'); }
        function salvarPerfil(){const n=document.getElementById('prof-name-input').value;if(n)prof.nome=n;DB.setItem('aa_prof',JSON.stringify(prof));updateProfUI();abrirPerfilMenu();}
        function salvarPerfil(){
            const n=document.getElementById('prof-name-input').value; if(n)prof.nome=n;
            if(!molduras[prof.frame].unlock(prof)) prof.frame = 0;
            DB.setItem('aa_prof',JSON.stringify(prof)); updateProfUI(); abrirPerfilMenu();
        }
        function editarPerfil(){document.getElementById('profile-dash').style.display='none';document.getElementById('profile-edit').style.display='block';}
        function mudarAvatar(d){prof.av=(prof.av+d+avatares.length)%avatares.length;updateProfUI();}
        function mudarFrame(d){prof.frame=(prof.frame+d+molduras.length)%molduras.length;updateProfUI();}
        
        function updateProfUI(){
            const a=avatares[prof.av]; const c=a.color; const glow=`0 0 20px ${c}`;
            const m = molduras[prof.frame];
            const isLocked = !m.unlock(prof);

            // UI do Seletor
            const fName = document.getElementById('frame-name');
            const fReq = document.getElementById('frame-req');
            if(fName) {
                fName.innerText = m.name; fName.style.color = isLocked ? '#555' : 'var(--accent-gold)';
                fReq.innerText = isLocked ? `Bloqueado (${m.req})` : m.req; fReq.style.color = isLocked ? '#880000' : '#666';
            }
            
            const pEdit = document.getElementById('prof-av-edit');
            pEdit.src=`Imagens/Personagens/${a.file}`; 
            pEdit.style.borderColor = c; pEdit.style.boxShadow = glow;
            if(isLocked) { pEdit.style.border = "4px solid #333"; pEdit.style.boxShadow = "none"; }
            else m.apply(pEdit, c);
            
            // Para HUD e Dash, usa apenas moldura v√°lida
            const validM = m.unlock(prof) ? m : molduras[0];
            
            document.getElementById('dash-av-img').src=`Imagens/Personagens/${a.file}`; 
            const dashAv = document.querySelector('.dash-avatar');
            dashAv.style.borderColor = c; dashAv.style.boxShadow = glow;
            validM.apply(dashAv, c);
            
            document.getElementById('hud-av-img').src=`Imagens/Personagens/${a.file}`; 
            const hudFrame = document.querySelector('#hud-avatar-container .avatar-frame');
            hudFrame.style.borderColor = c; hudFrame.style.boxShadow = glow;
            validM.apply(hudFrame, c);
            
            document.getElementById('dash-name').innerText=prof.nome; document.getElementById('hud-name').innerText=prof.nome; document.getElementById('dash-lvl').innerText=prof.lvl; document.getElementById('hud-lvl').innerText=prof.lvl; document.getElementById('dash-title').innerText=titulos[Math.min(Math.floor((prof.lvl-1)/5),titulos.length-1)];
        }
        function openConfigMenu(o){lastScreen=o==='game'?'screen-game':'screen-menu';const q=document.getElementById('btn-quit-match'); if(o==='game')q.style.display='block'; else q.style.display='none'; navegar('screen-settings');}
        function voltarConfig(){navegar(lastScreen);}
        function applySettings(){
            audioManager.updateVolume();
            document.getElementById('rng-musica').value=cfg.m;
            document.getElementById('rng-sfx').value=cfg.s;
            // document.getElementById('chk-part').checked=cfg.part; // Elemento n√£o existe no HTML original, removido para evitar erro
            setGfx('part',cfg.part);
        }
        function setGfx(t,v){cfg[t]=v;if(t==='part')document.body.classList.toggle('no-particles',!v);DB.setItem('aa_cfg',JSON.stringify(cfg));}
        function setAudio(t,v){if(t==='m')cfg.m=v;if(t==='s')cfg.s=v;DB.setItem('aa_cfg',JSON.stringify(cfg));audioManager.updateVolume();}
        function deletarSave() { if(confirm("Apagar tudo?")) { DB.removeItem('aa_prof'); DB.removeItem('aa_save'); location.reload(); } }

        function animateMenuEntrance() {
            const visibleCards = Array.from(document.querySelectorAll('.magic-menu-card')).filter(c => window.getComputedStyle(c).display !== 'none');
            
            // Anima√ß√£o de entrada em sequ√™ncia (Stagger)
            gsap.from(visibleCards, {
                y: 100, opacity: 0, scale: 0.8,
                duration: 0.8, stagger: 0.1, ease: "back.out(1.2)",
                clearProps: "all"
            });
        }

        function createMenuParticle(x, y) {
            const p = document.createElement('div');
            p.className = 'menu-particle';
            p.style.left = x + 'px';
            p.style.top = y + 'px';
            document.body.appendChild(p);
            
            gsap.to(p, {
                x: (Math.random() - 0.5) * 60,
                y: (Math.random() - 0.5) * 60 + 30,
                opacity: 0, scale: 0, duration: 1 + Math.random(), ease: "power1.out", onComplete: () => p.remove()
            });
        }

        // --- 7. VFX E ANIMA√á√ïES ---
        function triggerLevelUpFX() {
            const av = document.getElementById('hud-avatar-container');
            const rect = av.getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;

            // 1. Onda de Choque
            const wave = document.createElement('div'); wave.className = 'levelup-shockwave';
            wave.style.left = cx + 'px'; wave.style.top = cy + 'px'; wave.style.width = '0px'; wave.style.height = '0px';
            document.body.appendChild(wave);
            gsap.to(wave, { width: 400, height: 400, x: -200, y: -200, opacity: 1, duration: 0.1, onComplete: () => { gsap.to(wave, { opacity: 0, duration: 0.5, onComplete: ()=>wave.remove() }); } });

            // 2. Explos√£o de Part√≠culas
            for(let i=0; i<40; i++) {
                const p = document.createElement('div'); p.className = 'magic-spark'; p.style.left = cx + 'px'; p.style.top = cy + 'px';
                p.style.backgroundColor = ['#ffd700', '#fff', '#00a8cc', '#ff4500'][Math.floor(Math.random()*4)]; document.body.appendChild(p);
                const angle = Math.random() * Math.PI * 2; const dist = Math.random() * 150 + 50;
                gsap.to(p, { x: Math.cos(angle) * dist, y: Math.sin(angle) * dist, opacity: 0, scale: 0, duration: 1 + Math.random(), ease: "power2.out", onComplete: ()=>p.remove() });
            }
        }
        
        function triggerComboBreaker() {
            playS('thunder');
            const crack = document.getElementById('crack-fx');
            gsap.fromTo(crack, {opacity: 1, scale: 0.8}, {opacity: 0, scale: 1.2, duration: 0.8, ease: "power2.out"});
            gsap.to(".game-area", {x:"+=15", yoyo:true, repeat:5, duration:0.05, clearProps:"x"});
            gsap.fromTo("#fx-overlay", {backgroundColor:"#ff0000", opacity:0.3}, {opacity:0, duration:0.5});
        }

        function spawnBossBleed() {
            const bar = document.querySelector('.boss-hp-bg');
            if(!bar) return;
            const rect = bar.getBoundingClientRect();
            const p = document.createElement('div'); p.className = 'boss-blood';
            // Posi√ß√£o aleat√≥ria ao longo da barra
            p.style.left = (rect.left + Math.random() * rect.width) + 'px';
            p.style.top = (rect.top + rect.height - 5) + 'px';
            document.body.appendChild(p);
            gsap.to(p, {y: 50 + Math.random()*50, opacity: 0, scale: 0.5, duration: 1, ease: "power1.in", onComplete: ()=>p.remove()});
        }

        function initWeatherSystem(){
            const c=document.getElementById('magic-canvas'); 
            const ctx=c.getContext('2d');
            c.width=window.innerWidth; c.height=window.innerHeight;
            
            const hour = new Date().getHours();
            const isNight = hour >= 18 || hour < 6;
            const type = isNight ? 'snow' : 'rain';
            
            let ps=[]; 
            const count = isNight ? 80 : 120;

            class WeatherParticle {
                constructor() { this.reset(true); }
                reset(init=false) {
                    this.x = Math.random() * c.width;
                    this.y = init ? Math.random() * c.height : -10;
                    if (type === 'snow') {
                        this.vx = (Math.random()-0.5)*0.5; this.vy = 1+Math.random()*1.5;
                        this.s = 2+Math.random()*2; this.a = 0.3+Math.random()*0.5;
                    } else {
                        this.vx = 0.5; this.vy = 15+Math.random()*10;
                        this.l = 15+Math.random()*15; this.a = 0.1+Math.random()*0.2;
                    }
                }
                update() { this.x+=this.vx; this.y+=this.vy; if(this.y>c.height||this.x>c.width) this.reset(); }
                draw() {
                    ctx.beginPath();
                    if (type === 'snow') {
                        ctx.fillStyle=`rgba(255,255,255,${this.a})`; ctx.arc(this.x,this.y,this.s,0,Math.PI*2); ctx.fill();
                    } else {
                        ctx.strokeStyle=`rgba(174,194,224,${this.a})`; ctx.lineWidth=1.5;
                        ctx.moveTo(this.x,this.y); ctx.lineTo(this.x+this.vx,this.y+this.l); ctx.stroke();
                    }
                }
            }

            for(let i=0;i<count;i++) ps.push(new WeatherParticle());
            function ani(){ ctx.clearRect(0,0,c.width,c.height); ps.forEach(p=>{p.update();p.draw();}); requestAnimationFrame(ani); }
            ani();
        }
        
        function playPortalEffect(callback) {
            const cvs = document.getElementById('portal-canvas');
            const ctx = cvs.getContext('2d');
            cvs.width = window.innerWidth; cvs.height = window.innerHeight;
            cvs.classList.add('active');
            document.body.classList.add('chromatic-active'); // Ativa distor√ß√£o
            
            let radius = 0;
            const maxRadius = Math.sqrt(cvs.width**2 + cvs.height**2);
            let rotation = 0;
            let midCalled = false;
            
            function render() {
                ctx.clearRect(0, 0, cvs.width, cvs.height);
                const cx = cvs.width / 2; const cy = cvs.height / 2;
                
                rotation += 0.15;
                radius += maxRadius / 60; // Velocidade de expans√£o (Mais suave/delicado)
                
                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate(rotation);
                
                // Gradiente M√°gico (Branco -> Azul -> Roxo -> Transparente)
                const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, radius);
                gradient.addColorStop(0, '#fff'); 
                gradient.addColorStop(0.3, 'rgba(197, 160, 40, 0.8)'); // Ouro (Accent Gold)
                gradient.addColorStop(0.6, 'rgba(0, 168, 204, 0.4)'); // Magic Blue suave
                gradient.addColorStop(1, 'transparent');
                
                ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fillStyle = gradient; ctx.fill();
                
                // Runas/Linhas de Energia girando
                ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 4;
                for(let i=0; i<6; i++) { ctx.beginPath(); ctx.arc(0, 0, radius * (0.4 + i*0.1), i, Math.PI + i); ctx.stroke(); }
                
                ctx.restore();
                
                // Momento de cobertura total (Tela Branca/Cheia)
                if (radius > maxRadius * 1.2) {
                    if (!midCalled) {
                        midCalled = true;
                        if (callback) callback(); // Troca a cena
                        cvs.classList.remove('active'); // Fade out via CSS
                        document.body.classList.remove('chromatic-active'); // Remove distor√ß√£o
                        setTimeout(() => ctx.clearRect(0,0,cvs.width,cvs.height), 500);
                    }
                } else {
                    requestAnimationFrame(render);
                }
            }
            render();
        }

        function showBossSpeech(text) {
            const bb = document.getElementById('boss-speech');
            if(!bb) return;
            clearTimeout(speechHideTimer);
            bb.innerText = text;
            bb.style.opacity = 1;
            bb.style.top = "-140px";
            gsap.killTweensOf(bb);
            gsap.fromTo(bb, {y: 20}, {y: 0, duration: 0.3});
            speechHideTimer = setTimeout(() => bb.style.opacity = 0, 4000);
        }

        function triggerBossReaction(type) {
            const b = bosses[currentBossIndex];
            if(!b) return;
            let pool = b.phrases;
            if(type === 'miss' && b.missPhrases) pool = b.missPhrases;
            const p = pool[Math.floor(Math.random() * pool.length)];
            showBossSpeech(p);
            clearTimeout(tauntTimer); scheduleTaunt(); // Reseta timer de taunt aleat√≥rio
        }

        function scheduleTaunt(){
            clearTimeout(tauntTimer);
            const t=Math.random()*5000+10000;
            tauntTimer=setTimeout(()=>{
                const b=bosses[currentBossIndex];
                if(b){
                    let pIdx;
                    // Evita repetir a mesma frase duas vezes seguidas
                    do { pIdx = Math.floor(Math.random()*b.phrases.length); } while(pIdx === b.lastPhraseIdx && b.phrases.length > 1);
                    b.lastPhraseIdx = pIdx;
                    showBossSpeech(b.phrases[pIdx]);
                }
                scheduleTaunt();
            },t);
        }
        
        function resetAFKTimer() {
            clearTimeout(afkTimer);
            afkTimer = setTimeout(triggerObliviate, 180000); // 3 minutos
        }

        function triggerObliviate() {
            playS('chaos'); // Som m√°gico/ca√≥tico
            const flash = document.createElement('div');
            flash.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:99999;opacity:0;pointer-events:none;";
            document.body.appendChild(flash);
            
            gsap.to(flash, {opacity: 1, duration: 1.5, ease: "power2.in", onComplete: () => {
                sairParaMenu(); // Reseta para o menu
                gsap.to(flash, {opacity: 0, duration: 2, delay: 0.5, onComplete: () => flash.remove()});
            }});
        }
        
        let achievementQueue = [];
        let isAchQueueRunning = false;

        function checkAchievements(t){
            achievementsDB.forEach(a=>{
                if(globalData.achievements.includes(a.id)) return;
                let u=false;
                
                // N√≠veis
                if(a.id==='lvl_5' && prof.lvl>=5) u=true;
                if(a.id==='lvl_10' && prof.lvl>=10) u=true;
                if(a.id==='lvl_25' && prof.lvl>=25) u=true;
                if(a.id==='lvl_50' && prof.lvl>=50) u=true;
                if(a.id==='lvl_100' && prof.lvl>=100) u=true;
                
                // Jogos
                if(a.id==='veteran_10' && prof.totalGames>=10) u=true;
                if(a.id==='veteran_50' && prof.totalGames>=50) u=true;
                
                // Pontua√ß√£o
                if(a.id==='score_1k' && prof.maxScore>=1000) u=true;
                if(a.id==='score_5k' && prof.maxScore>=5000) u=true;
                
                // Bosses (Corre√ß√£o de Rastreamento)
                if(a.id.startsWith('kill_')) {
                    const bTarget = a.id.split('_')[1]; // ex: glacia
                    // Busca case-insensitive nas chaves de bossKills (que est√£o Capitalizadas: Glacia)
                    const bKey = Object.keys(prof.bossKills).find(k => k.toLowerCase() === bTarget);
                    if(bKey && prof.bossKills[bKey] > 0) u=true;
                }

                // Progress√£o & Especiais
                if(a.id==='win_1' && prof.levelRecords && prof.levelRecords[1]) u=true;
                if(a.id==='win_5' && prof.levelRecords && prof.levelRecords[5]) u=true;
                if(a.id==='win_10' && prof.levelRecords && prof.levelRecords[10]) u=true;
                if(a.id==='completionist' && prof.grimoireUnlocked) u=true;
                if(a.id==='infinite_15' && globalData.infiniteHighScores.some(s => s.fase >= 15)) u=true;

                if(u){ globalData.achievements.push(a.id); DB.setItem('aa_global',JSON.stringify(globalData)); showAch(a); }
            });
        }
        
        function showAch(a){
            achievementQueue.push(a);
            processAchQueue();
        }

        function processAchQueue() {
            if(isAchQueueRunning || achievementQueue.length === 0) return;
            isAchQueueRunning = true;
            const a = achievementQueue.shift();
            
            const p=document.getElementById('achievement-popup');
            document.getElementById('ach-pop-icon').innerText=a.icon;
            document.getElementById('ach-pop-title').innerText=a.title;
            document.getElementById('ach-pop-desc').innerText=a.desc;
            
            playS('achievement');
            p.classList.add('show');
            
            // 4s vis√≠vel + tempo de transi√ß√£o
            setTimeout(()=>{
                p.classList.remove('show');
                setTimeout(() => {
                    isAchQueueRunning = false;
                    processAchQueue();
                }, 600); // Espera a anima√ß√£o de sa√≠da (transition transform 0.6s)
            }, 4000);
        }

        function initGrimoireStars() {
            const c = document.getElementById('grimoire-stars');
            if(!c) return;
            c.innerHTML = '';
            for(let i=0; i<80; i++) {
                const s = document.createElement('div');
                s.className = 'g-star';
                s.style.left = Math.random()*100 + '%';
                s.style.top = Math.random()*100 + '%';
                const size = Math.random()*3 + 1;
                s.style.width = size + 'px';
                s.style.height = size + 'px';
                s.style.animationDelay = Math.random()*3 + 's';
                s.style.animationDuration = (2 + Math.random()*3) + 's';
                c.appendChild(s);
            }
        }

        function toggleGrimoireWithMist(action, fromGame = false) {
            const mist = document.getElementById('mist-layer');
            mist.classList.add('active');
            playS('teleport', 0.6); // Som suave de teleporte/n√©voa

            setTimeout(() => {
                if (action === 'open') {
                    const g = document.getElementById('btn-grimoire-menu'); if(g) g.classList.remove('glow-gold');
                    if(fromGame) {
                        document.getElementById('screen-game').style.display = 'none';
                        document.getElementById('dynamic-bg-layer').className = 'env-default';
                    }
                    justUnlockedGrimoire = false;
                    navegar('screen-credits'); 
                    currentBookPage = 0; 
                    renderBookPage(); 
                    initGrimoireStars();
                    if(fromGame && justUnlockedGrimoire) triggerGrimoireUnlockFX();
                } else {
                    sairParaMenu();
                }
                setTimeout(() => mist.classList.remove('active'), 800);
            }, 1500);
        }

        function renderBookPage(dir=0) { 
            const c = document.getElementById('book-content'); const pNum = document.getElementById('page-num');
            if(dir!==0) playS('paper');
            clearTimeout(typewriterTimer);
            
            // Configura√ß√£o para efeito 3D de 4 segundos (2s saida + 2s entrada) para sincronizar com o √°udio
            const duration = 2.0;

            let out={opacity:0,duration:0.3};
            if(dir!==0) gsap.set(c, {transformOrigin: "left center"});
            if(dir===1) out={rotationY:-90,opacity:0,duration:duration,ease:"power1.in"};
            if(dir===-1) out={rotationY:90,opacity:0,duration:duration,ease:"power1.in"};

            gsap.to(c, {...out, onComplete:()=>{
                if(dir!==0) createBookDust();
                let textToType = null; let targetId = null;

                if(currentBookPage===0) {
                    c.innerHTML=`<div class="grimoire-intro-text" id="type-target"></div>`;
                    textToType = "O Grim√≥rio Sagrado."; targetId = "type-target";
                }
                else if(currentBookPage<=10) { 
                    const b=bosses[currentBookPage-1]; 
                    c.innerHTML=`<div class="boss-portrait"><img src="Imagens/Monstros/${b.file}"></div><h2>${b.n}</h2><p id="type-target"></p>`; 
                    textToType = b.lore; targetId = "type-target";
                }
                else if(currentBookPage===11) {
                    // P√ÅGINA DO CRIADOR (NOVA)
                    c.innerHTML = `
                        <div class="grimoire-header" style="border-bottom: 2px solid var(--accent-gold); margin-bottom: 30px;"><h1 class="grimoire-title" style="font-size:3rem;">O Criador</h1></div>
                        <div style="text-align:center; display:flex; flex-direction:column; align-items:center; height:100%; justify-content:center;">
                            <div style="width:140px; height:140px; border-radius:50%; border:4px double var(--accent-gold); overflow:hidden; margin-bottom:20px; box-shadow:0 0 20px rgba(0,0,0,0.4); background:#000;">
                                <img src="Imagens/Personagens/mago_sabio.png" style="width:100%; height:100%; object-fit:cover;">
                            </div>
                            <div style="font-family:'Cinzel'; font-size:1.8rem; color:#8b0000; margin-bottom:10px; font-weight:bold;">Davi Eduardo</div>
                            <div style="font-family:'Cinzel'; font-size:1rem; color:#555; margin-bottom:30px; text-transform:uppercase; letter-spacing:2px;">Dev Junior e Junior Game Designer</div>
                            <p id="type-target" style="font-family:'MedievalSharp'; font-size:1.3rem; color:#2c1e0b; line-height:1.8; max-width:85%; font-style:italic;"></p>
                        </div>
                    `;
                    textToType = "Este √© meu primeiro projeto solo, desenvolvido e criado com muita dedica√ß√£o. Obrigado por completar esta jornada e desvendar os segredos da Arcane Academy."; 
                    targetId = "type-target";
                }
                else if(currentBookPage===12) {
                    // ESTAT√çSTICAS (NOVA P√ÅGINA)
                    let favBoss = "Nenhum"; let maxKills = 0;
                    for(let b in prof.bossKills) { if(prof.bossKills[b] > maxKills) { maxKills = prof.bossKills[b]; favBoss = b; } }
                    
                    const hours = Math.floor(prof.playTime / 3600);
                    const mins = Math.floor((prof.playTime % 3600) / 60);
                    const timeStr = `${hours}h ${mins}m`;

                    c.innerHTML = `
                        <div class="grimoire-header"><h1 class="grimoire-title">Estat√≠sticas</h1><div class="grimoire-subtitle">Seus Feitos</div></div>
                        <div style="display:flex; flex-direction:column; gap:30px; width:100%; padding:20px;">
                            <div class="stat-box" style="background:rgba(93, 64, 55, 0.1); border-color:#5d4037;"><div class="stat-label" style="color:#5d4037;">Vit√≥rias Totais</div><div class="stat-val-big" style="color:#2c1e0b;">${prof.wins}</div></div>
                            <div class="stat-box" style="background:rgba(93, 64, 55, 0.1); border-color:#5d4037;"><div class="stat-label" style="color:#5d4037;">Inimigo Favorito</div><div class="stat-val-big" style="color:#8b0000; font-size:1.5rem;">${favBoss} <span style="font-size:1rem; color:#555;">(${maxKills}x)</span></div></div>
                            <div class="stat-box" style="background:rgba(93, 64, 55, 0.1); border-color:#5d4037;"><div class="stat-label" style="color:#5d4037;">Tempo de Jogo</div><div class="stat-val-big" style="color:#2c1e0b;">${timeStr}</div></div>
                            <div class="stat-box" style="background:rgba(93, 64, 55, 0.1); border-color:#5d4037;"><div class="stat-label" style="color:#5d4037;">Maior Combo</div><div class="stat-val-big" style="color:#2c1e0b;">${prof.maxScore} pts</div></div>
                        </div>
                    `;
                    gsap.from(".stat-box", {opacity:0, y:20, stagger:0.1, duration:0.5});
                }
                else if(currentBookPage===13) { 
                    let h = `<div class="grimoire-header"><h1 class="grimoire-title">Cron√¥nimo</h1><div class="grimoire-subtitle">Recordes de Tempo</div></div>`;
                    h += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; padding:0 20px; max-height:550px; overflow-y:auto;">`;
                    for(let i=1; i<=10; i++) {
                        const t = prof.levelRecords ? prof.levelRecords[i] : null;
                        const tStr = t ? t.toFixed(2) + 's' : '--';
                        const b = bosses[i-1];
                        const bName = b ? b.n : 'Fase '+i;
                        h += `<div class="stat-box" style="background:rgba(93, 64, 55, 0.1); border-color:#5d4037; padding:10px; display:flex; flex-direction:column; align-items:center;"><div style="font-size:0.8rem; color:#5d4037; margin-bottom:5px;">Fase ${i} - ${bName}</div><div style="font-family:'Cinzel'; font-size:1.4rem; color:${t?'#8b0000':'#555'}; font-weight:bold;">${tStr}</div></div>`;
                    }
                    h += `</div>`;
                    c.innerHTML = h;
                    gsap.from(".stat-box", {opacity:0, scale:0.9, stagger:0.05, duration:0.4});
                }
                else if(currentBookPage===14) { 
                    let h=`<div class="grimoire-header"><h1 class="grimoire-title">Conquistas</h1><div class="grimoire-subtitle">Seus Trof√©us</div></div><div class="ach-list">`; 
                    achievementsDB.forEach(a=>{ 
                        h+=`<div class="ach-item ${globalData.achievements.includes(a.id)?'unlocked':''}"><div class="ach-item-icon">${a.icon}</div><div class="ach-item-text"><h4>${a.title}</h4><p>${a.desc}</p></div></div>`; 
                    }); 
                    c.innerHTML=h+'</div>'; 
                    gsap.from(".ach-item", {opacity:0, y:10, stagger:0.03, duration:0.4, clearProps:"all"});
                }
                
                pNum.innerText=currentBookPage+1; 
                
                if(dir===1) gsap.fromTo(c,{rotationY:90,opacity:0},{rotationY:0,opacity:1,duration:duration,ease:"power1.out"});
                else if(dir===-1) gsap.fromTo(c,{rotationY:-90,opacity:0},{rotationY:0,opacity:1,duration:duration,ease:"power1.out"});
                else gsap.to(c,{opacity:1,duration:0.3});

                if(textToType && targetId) setTimeout(() => typeWriterEffect(document.getElementById(targetId), textToType), 200);
            }});
        }

        function createBookDust() {
            const container = document.getElementById('vfx-container');
            const rect = document.querySelector('.grimoire-container').getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.bottom - 50;
            
            for(let i=0; i<25; i++) {
                const p = document.createElement('div');
                p.style.cssText = `position:fixed; left:${cx}px; top:${cy}px; width:${Math.random()*4+2}px; height:${Math.random()*4+2}px; background:radial-gradient(circle, #ffd700, transparent); border-radius:50%; z-index:20005; pointer-events:none; opacity:1;`;
                container.appendChild(p);
                
                gsap.to(p, { x: (Math.random()-0.5)*300, y: -50 - Math.random()*150, opacity: 0, scale: 0, duration: 1.5 + Math.random(), ease: "power2.out", onComplete: () => p.remove() });
            }
        }

        function typeWriterEffect(el, text, i = 0) {
            if (!el) return;
            if (i === 0) el.textContent = "";
            el.textContent = text.substring(0, i + 1);
            if (i < text.length - 1) {
                typewriterTimer = setTimeout(() => typeWriterEffect(el, text, i + 1), 15 + Math.random() * 15);
            }
        }

        function nextPage(){if(currentBookPage<14){currentBookPage++;renderBookPage(1);}} function prevPage(){if(currentBookPage>0){currentBookPage--;renderBookPage(-1);}}
        function getRewards(lvl) { let cardSkin = ''; let aura = ''; let hitEffect = 'boss-hit'; if (lvl >= 80) { cardSkin = 'card-skin-cosmic'; aura = 'aura-light'; hitEffect = 'boss-hit-void'; } else if (lvl >= 60) { cardSkin = 'card-skin-mythril'; aura = 'aura-shadow'; hitEffect = 'boss-hit-shock'; } else if (lvl >= 40) { cardSkin = 'card-skin-diamond'; aura = 'aura-lightning'; hitEffect = 'boss-hit-fire'; } else if (lvl >= 20) { cardSkin = 'card-skin-gold'; aura = 'aura-fire'; hitEffect = 'boss-hit-ice'; } else if (lvl >= 5) { cardSkin = 'card-skin-silver'; aura = 'aura-ice'; } return { cardSkin, aura, hitEffect }; }
        function createMagicBurst(x, y) { const container = document.getElementById('vfx-container'); const count = 12; const colors = ['#d4af37', '#00d2ff', '#ffffff']; for (let i = 0; i < count; i++) { const spark = document.createElement('div'); spark.classList.add('magic-spark'); spark.style.left = x + 'px'; spark.style.top = y + 'px'; spark.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]; container.appendChild(spark); const angle = Math.random() * Math.PI * 2; const distance = Math.random() * 60 + 30; const destX = Math.cos(angle) * distance; const destY = Math.sin(angle) * distance; gsap.to(spark, { x: destX, y: destY, opacity: 0, scale: 0, duration: 0.6, ease: "power2.out", onComplete: () => spark.remove() }); } }
        function initAudioVisualizer() { gsap.to(".magic-menu-card", { boxShadow: "0 15px 40px -5px rgba(0, 210, 255, 0.4)", borderColor: "rgba(0, 210, 255, 0.6)", duration: 2.5, repeat: -1, yoyo: true, stagger: { each: 0.3, from: "center" }, ease: "sine.inOut" }); }
        
        function triggerGrimoireUnlockFX() {
            const container = document.getElementById('vfx-container');
            const rect = document.querySelector('.grimoire-container').getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;
            
            // Part√≠culas Douradas
            for(let i=0; i<60; i++) {
                const p = document.createElement('div');
                p.style.cssText = `position:fixed; left:${cx}px; top:${cy}px; width:${Math.random()*6+2}px; height:${Math.random()*6+2}px; background:radial-gradient(circle, #ffd700, #b8860b); border-radius:50%; z-index:20000; pointer-events:none; box-shadow:0 0 10px #ffd700;`;
                container.appendChild(p);
                
                const angle = Math.random() * Math.PI * 2;
                const dist = 100 + Math.random() * 300;
                
                gsap.to(p, {
                    x: Math.cos(angle) * dist,
                    y: Math.sin(angle) * dist,
                    opacity: 0,
                    scale: 0,
                    duration: 1.5 + Math.random(),
                    ease: "power2.out",
                    onComplete: () => p.remove()
                });
            }
            
            // Flash de Luz
            const flash = document.createElement('div');
            flash.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; opacity:0.8; z-index:19999; pointer-events:none; mix-blend-mode:overlay;";
            document.body.appendChild(flash);
            gsap.to(flash, {opacity:0, duration:1, onComplete:()=>flash.remove()});
        }
    
    </script>
</body>
</html>