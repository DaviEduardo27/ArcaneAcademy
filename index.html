<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcane Academy [DEMO] - Patch 2.1</title>
    
    <!-- Open Graph / Discord & WhatsApp Preview -->
    <meta property="og:title" content="Arcane Academy [DEMO] - Patch 2.1">
    <meta property="og:description" content="Embarque em uma jornada mágica, enfrente chefes lendários e complete seu Grimório neste jogo de memória e estratégia.">
    <meta property="og:image" content="Imagens/CapaGame.jpg">
    <meta property="og:type" content="website">
    <meta name="theme-color" content="#c5a028">

    <link rel="icon" type="image/x-icon" href="icone.ico">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=MedievalSharp&family=Pirata+One&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <style>
        /* --- VISUAL CORE --- */
        :root {
            --bg-deep: #050505; --accent-gold: #c5a028; --accent-glow: #ffd700; --danger-red: #8b0000;
            --magic-blue: #00a8cc; --combo-orange: #d35400; --chaos-purple: #6c3483; --panel-bg: rgba(5, 5, 8, 0.95);
            --paper-color: #e3dac9; --ink-color: #1a1a1a; --glass-dark: rgba(0, 0, 0, 0.9);
            --rew-silver: #bdc3c7; --rew-mythril: #1abc9c; --rew-cosmic: #8e44ad;
        }
        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; outline: none; margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Cinzel', serif; color: #d0d0d0; cursor: default; }

        /* --- BACKGROUNDS --- */
        #dynamic-bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background-size: cover; background-position: center; transition: opacity 1s ease, filter 1s ease; opacity: 0.6; filter: contrast(1.1) saturate(0.9); }
        .env-default { background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%); }
        .env-glacia{background-image:url('Imagens/Fundos/bg_glacia.jpg');} .env-thalros{background-image:url('Imagens/Fundos/bg_thalros.jpg');} 
        .env-umbra{background-image:url('Imagens/Fundos/bg_umbra.jpg');} .env-ferrum{background-image:url('Imagens/Fundos/bg_ferrum.jpg');} 
        .env-solari{background-image:url('Imagens/Fundos/bg_solari.jpg');} .env-aurelius{background-image:url('Imagens/Fundos/bg_aurelius.jpg');} 
        .env-malakor{background-image:url('Imagens/Fundos/bg_malakor.jpg');} .env-sertis{background-image:url('Imagens/Fundos/bg_sertis.jpg');} 
        .env-trion{background-image:url('Imagens/Fundos/bg_trion.jpg');} .env-gaiaos{background-image:url('Imagens/Fundos/bg_gaiaos.jpg');}

        /* --- VFX --- */
        #magic-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        #combo-pulse-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 0%, #000 100%); z-index: 2; transition: background 0.2s ease; pointer-events: none; mix-blend-mode: overlay; }
        #vfx-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; }
        .magic-spark { position: absolute; width: 8px; height: 8px; background: #fff; border-radius: 50%; box-shadow: 0 0 15px #fff, 0 0 30px var(--accent-gold); pointer-events: none; }
        .spell-projectile { position: absolute; width: 50px; height: 50px; border-radius: 50%; background: radial-gradient(circle, #fff, var(--magic-blue)); box-shadow: 0 0 30px var(--magic-blue), 0 0 60px #fff; z-index: 9000; pointer-events: none; mix-blend-mode: screen; }
        #fx-overlay, #fade-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 8000; opacity: 0; }
        #fade-layer { background: #000; z-index: 10000; transition: opacity 0.8s; }
        .fade-active { opacity: 1 !important; pointer-events: all !important; }
        .levelup-shockwave { position: absolute; border: 3px solid var(--accent-gold); border-radius: 50%; pointer-events: none; z-index: 9999; box-shadow: 0 0 30px var(--accent-gold), inset 0 0 20px var(--accent-gold); opacity: 0; }
        #time-warning-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9000; opacity: 0; transition: opacity 0.5s; box-shadow: inset 0 0 0 rgba(255,0,0,0); }
        #time-warning-layer.active { opacity: 1; animation: timePulse 1s infinite ease-in-out; }
        @keyframes timePulse { 0% { box-shadow: inset 0 0 30px rgba(255, 0, 0, 0.3); } 50% { box-shadow: inset 0 0 100px rgba(255, 0, 0, 0.8); } 100% { box-shadow: inset 0 0 30px rgba(255, 0, 0, 0.3); } }
        
        #portal-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 15000; pointer-events: none; opacity: 0; transition: opacity 0.5s; }
        #portal-canvas.active { opacity: 1; }
        
        /* Combo Breaker Crack */
        #crack-fx { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9500; pointer-events: none; opacity: 0; display: flex; align-items: center; justify-content: center; mix-blend-mode: overlay; }
        #crack-svg { width: 80%; height: 80%; filter: drop-shadow(0 0 10px rgba(0,0,0,0.8)); }
        .crack-path { fill: none; stroke: rgba(255, 255, 255, 0.8); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; vector-effect: non-scaling-stroke; }
        
        /* BLACK HOLE FX */
        #black-hole {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            width: 150px; height: 150px; border-radius: 50%;
            background: #000;
            box-shadow: 0 0 30px #4b0082, 0 0 60px #800080, inset 0 0 40px rgba(255,255,255,0.1);
            z-index: 9000; pointer-events: none; opacity: 0;
        }
        #black-hole::before { content: ''; position: absolute; top: -20%; left: -20%; width: 140%; height: 140%; border-radius: 50%; border: 2px solid rgba(108, 52, 131, 0.5); border-top-color: transparent; border-bottom-color: transparent; animation: bhSpin 2s linear infinite; filter: url(#gravitational-distortion); }
        #black-hole::after { content: ''; position: absolute; top: -40%; left: -40%; width: 180%; height: 180%; border-radius: 50%; border: 2px dashed rgba(75, 0, 130, 0.3); animation: bhSpin 4s linear infinite reverse; filter: url(#gravitational-distortion); }
        @keyframes bhSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Chromatic Aberration Class */
        .chromatic-active { animation: chromaticShake 0.2s infinite; filter: url(#chromatic-aberration); }
        @keyframes chromaticShake { 0% { transform: translate(1px, 0); } 50% { transform: translate(-1px, 0); } 100% { transform: translate(1px, 0); } }
        .time-turner-fx { animation: timeRewind 1.5s ease-in-out; } @keyframes timeRewind { 0% { filter: sepia(0); } 50% { filter: sepia(1) hue-rotate(-50deg) blur(2px); } 100% { filter: sepia(0); } }
        
        /* --- SCREENS --- */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.5s; z-index: 10; }
        .screen.active { display: flex; opacity: 1; z-index: 50; }

        /* --- INTRO FIX (FULLSCREEN + VINHETA) --- */
        #screen-intro { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: radial-gradient(ellipse at center, #1a2639 0%, #000000 100%); z-index: 20000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .intro-container { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* Efeito Teto Mágico: Azul profundo nas bordas, transparente no centro */
        .magic-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: radial-gradient(circle at center, transparent 40%, rgba(0, 0, 0, 0.6) 100%); 
            pointer-events: none; z-index: 20001; 
        }
        
        /* Video Centralizado (Cinema Mode) */
        #intro-video { 
            width: auto; height: auto; 
            max-width: 85vw; max-height: 85vh;
            border-radius: 20px;
            box-shadow: 0 0 60px rgba(0, 168, 204, 0.3);
            opacity: 1; 
            z-index: 20000; 
        }
        
        #start-btn-intro { z-index: 20002; position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%); background: linear-gradient(180deg, rgba(10, 20, 30, 0.95), #000); border: 1px solid rgba(0, 168, 204, 0.5); color: var(--accent-gold); padding: 18px 50px; font-family: 'Cinzel'; font-size: 1.4rem; letter-spacing: 4px; text-transform: uppercase; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); backdrop-filter: blur(5px); box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); opacity: 1; text-shadow: 0 0 10px rgba(197, 160, 40, 0.5); border-radius: 50px; }
        #start-btn-intro:hover { background: linear-gradient(180deg, rgba(20, 40, 60, 1), #050505); border-color: var(--magic-blue); box-shadow: 0 0 50px rgba(0, 168, 204, 0.6), inset 0 0 20px rgba(0, 168, 204, 0.2); color: #fff; transform: translateX(-50%) scale(1.05) translateY(-5px); text-shadow: 0 0 20px var(--magic-blue); }
        #skip-text { position: absolute; bottom: 30px; right: 40px; z-index: 20002; font-family: 'Cinzel'; color: rgba(255,255,255,0.4); font-size: 0.9rem; letter-spacing: 3px; cursor: pointer; display: none; text-transform: uppercase; }

        /* --- MENU --- */
        #screen-menu { 
            background: url('Imagens/CapaGame.jpg') no-repeat center center;
            background-size: cover; 
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
        }
        .menu-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, rgba(10, 16, 26, 0.3) 0%, rgba(0, 0, 0, 0.9) 100%); z-index: 1; pointer-events: none; }
        
        .menu-card { width: 100%; height: 100%; background: transparent; border: none; box-shadow: none; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; z-index: 2; padding-top: 60px; }
        .title-glow-fx { position: absolute; top: 0; width: 100%; height: 40%; background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent); pointer-events: none; z-index: 5; }
        .beta-badge { position: absolute; top: 30px; right: 40px; font-family: 'Cinzel'; font-size: 1.2rem; font-weight: bold; color: rgba(255, 255, 255, 0.8); letter-spacing: 4px; z-index: 100; text-shadow: 0 0 10px rgba(0, 168, 204, 0.8); }
        
        /* Carrossel */
        .menu-options-container { width: 95%; max-width: 1600px; padding: 0; display: flex; justify-content: center; align-items: center; gap: 30px; z-index: 2000; min-height: auto; border: none; position: relative; flex-wrap: wrap; align-content: center; }
        
        .magic-menu-card { 
            width: 220px; height: 340px; flex-shrink: 0; 
            background: linear-gradient(160deg, rgba(18, 22, 30, 0.95), rgba(8, 10, 14, 0.98)); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7); 
            border-radius: 4px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 25px; 
            cursor: pointer; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); 
            position: relative; backdrop-filter: blur(12px); opacity: 1; pointer-events: auto; 
            transform: translateY(0); animation: cardFloatMenu 5s ease-in-out infinite; text-align: center; 
            overflow: hidden;
        }

        /* Inner Border & Accents */
        .magic-menu-card::after { content: ''; position: absolute; top: 6px; left: 6px; right: 6px; bottom: 6px; border: 1px solid rgba(197, 160, 40, 0.15); pointer-events: none; transition: all 0.4s ease; }
        .magic-menu-card::before { 
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: 
                linear-gradient(135deg, var(--accent-gold) 0%, transparent 10%) top left,
                linear-gradient(225deg, var(--accent-gold) 0%, transparent 10%) top right,
                linear-gradient(45deg, var(--accent-gold) 0%, transparent 10%) bottom left,
                linear-gradient(315deg, var(--accent-gold) 0%, transparent 10%) bottom right;
            background-size: 20px 20px; background-repeat: no-repeat; opacity: 0.2; transition: opacity 0.4s ease;
        }
        
        /* Variação na animação para parecer orgânico */
        .magic-menu-card:nth-child(odd) { animation-duration: 5.5s; animation-delay: 0.5s; }
        .magic-menu-card:nth-child(even) { animation-duration: 4.8s; animation-delay: 0s; }

        @keyframes cardFloatMenu { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        
        .card-icon { font-size: 4rem; color: #7a8b99; transition: 0.4s; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); }
        .card-label { font-family: 'Cinzel'; font-size: 1.1rem; font-weight: 600; color: #7a8b99; text-transform: uppercase; letter-spacing: 3px; transition: 0.4s; margin-top: 5px; width: 100%; text-align: center; position: relative; z-index: 2; }
        
        .magic-menu-card:hover { 
            transform: translateY(-15px) scale(1.05) !important; 
            background: linear-gradient(160deg, rgba(25, 30, 45, 0.95), rgba(12, 14, 18, 0.98)); 
            border-color: var(--accent-gold); 
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 30px rgba(197, 160, 40, 0.15); 
            z-index: 100; animation: none; 
        }
        .magic-menu-card:hover::after { border-color: var(--accent-gold); box-shadow: inset 0 0 15px rgba(197, 160, 40, 0.1); }
        .magic-menu-card:hover::before { opacity: 1; }
        .magic-menu-card:hover .card-icon { color: #fff; filter: drop-shadow(0 0 20px var(--magic-blue)); transform: scale(1.1); }
        .magic-menu-card:hover .card-label { color: var(--accent-gold); text-shadow: 0 0 15px rgba(197, 160, 40, 0.6); }
        .magic-menu-card:active { transform: translateY(-25px) scale(0.95); filter: brightness(1.3); }
        .magic-menu-card.disabled { opacity: 0.3; filter: grayscale(1); pointer-events: none; display:none; }

        /* Special Buttons Hover */
        #btn-ngplus:hover { border-color: var(--danger-red); } #btn-ngplus:hover::after { border-color: var(--danger-red); } #btn-ngplus:hover .card-icon { filter: drop-shadow(0 0 15px var(--danger-red)); } #btn-ngplus:hover .card-label { color: var(--danger-red); text-shadow: 0 0 10px var(--danger-red); }
        #btn-infinite:hover { border-color: var(--chaos-purple); } #btn-infinite:hover::after { border-color: var(--chaos-purple); } #btn-infinite:hover .card-icon { filter: drop-shadow(0 0 15px var(--chaos-purple)); } #btn-infinite:hover .card-label { color: var(--chaos-purple); text-shadow: 0 0 10px var(--chaos-purple); }

        .nav-zone { display: none; }

        /* --- UI & HUD --- */
        .panel-glass { background: linear-gradient(135deg, #1a1a1a, #050505); border: 2px solid var(--accent-gold); padding: 50px; border-radius: 8px; text-align: center; width: 600px; max-width: 90%; box-shadow: 0 0 100px rgba(0,0,0,0.9); }
        .btn-main { background: rgba(0,0,0,0.7); border: 1px solid rgba(197, 160, 40, 0.4); color: var(--accent-gold); font-family: 'Cinzel'; font-size: 1.2rem; padding: 18px 0; cursor: pointer; transition: 0.3s; width: 100%; text-transform: uppercase; letter-spacing: 4px; margin-top: 15px; }
        .btn-main:hover { background: rgba(197, 160, 40, 0.15); border-color: var(--accent-gold); box-shadow: 0 0 25px rgba(197, 160, 40, 0.3); transform: scale(1.02); }
        .btn-main:active { transform: scale(0.98); }
        
        .hud-top { position: absolute; top: 0; left: 0; width: 100%; padding: 30px 50px; display: flex; justify-content: space-between; align-items: flex-start; z-index: 100; pointer-events: none; }
        .profile-card-hud, .stats-card-hud { pointer-events: auto; background: rgba(15, 18, 25, 0.9); padding: 12px 30px; border-radius: 6px; backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .profile-card-hud { display: flex; align-items: center; gap: 20px; border-left: 4px solid var(--accent-gold); }
        .avatar-frame { width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--accent-gold); background: #000; overflow: hidden; } .avatar-frame img { width: 100%; height: 100%; object-fit: cover; }
        .stats-card-hud { display: flex; gap: 50px; font-family: 'Cinzel'; font-size: 1.3rem; }
        .val-gold { color: var(--accent-gold); font-weight:bold; } .val-blue { color: var(--magic-blue); font-weight:bold; }
        
        .game-area { display: flex; align-items: center; justify-content: center; gap: 80px; width: 100%; height: 100%; transform-style: preserve-3d; z-index: 10; }
        .boss-panel { width: 350px; text-align: center; position: relative; }
        .boss-img { width: 300px; height: 300px; margin: 0 auto; animation: float 5s infinite ease-in-out; } .boss-img img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 20px 40px rgba(0,0,0,0.8)); }
        
        #boss-n { font-size: 2.2rem; margin-top: 15px; font-weight: bold; color: #fff; text-shadow: 0 0 15px var(--accent-gold); letter-spacing: 4px; font-family: 'Cinzel'; text-transform: uppercase; border-bottom: 2px solid var(--accent-gold); padding-bottom: 5px; display: inline-block; }
        
        .boss-hp-bg { width: 100%; height: 18px; background: #0a0a0a; margin-top: 20px; border-radius: 10px; border: 2px solid var(--accent-gold); box-shadow: 0 0 20px rgba(0,0,0,0.8); position: relative; overflow: hidden; }
        .boss-hp-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #8b0000, #e74c3c); transition: 0.3s; box-shadow: 0 0 15px #e74c3c; position: relative; }
        .boss-hp-fill::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 50%; background: rgba(255,255,255,0.2); border-radius: 10px 10px 0 0; }
        .boss-blood { position: absolute; width: 6px; height: 6px; background: #8b0000; border-radius: 50%; pointer-events: none; z-index: 20; box-shadow: 0 0 5px #ff0000; }
        .boss-speech-bubble { position: absolute; top: -120px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 20px 25px; border-radius: 8px; font-family: 'MedievalSharp'; font-size: 1.1rem; width: 280px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); opacity: 0; pointer-events:none; transition: opacity 0.5s; border: 3px solid #000; }
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-20px);} }
        
        /* Auras & Effects */
        .aura-ice .avatar-frame { border-color: var(--magic-blue); box-shadow: 0 0 25px var(--magic-blue); }
        .aura-fire .avatar-frame { border-color: var(--danger-red); box-shadow: 0 0 25px var(--danger-red); }
        .aura-lightning .avatar-frame { border-color: var(--accent-glow); box-shadow: 0 0 30px var(--accent-glow); }
        .aura-shadow .avatar-frame { border-color: var(--chaos-purple); box-shadow: 0 0 35px var(--chaos-purple); }
        .aura-light .avatar-frame { border-color: #fff; box-shadow: 0 0 40px #fff; }
        .boss-hit { animation: hitBasic 0.2s; } @keyframes hitBasic { 0%{filter:brightness(10) contrast(2);} 100%{filter:brightness(1);} }

        /* CARDS - HOTFIX FLIP & BACK */
        .card-grid { display: grid; gap: 20px; perspective: 1200px; z-index: 10; } .grid-4 { grid-template-columns: repeat(4, 1fr); } .grid-5 { grid-template-columns: repeat(5, 1fr); } .grid-6 { grid-template-columns: repeat(6, 1fr); }
        .card-wrapper { width: 100px; height: 140px; position: relative; animation: cardFloat 3s infinite alternate ease-in-out; transition: transform 0.3s; }
        .card-wrapper:hover { transform: translateY(-10px) scale(1.05); z-index: 50; }
        
        .card { width: 100%; height: 100%; cursor: pointer; position: relative; transform-style: preserve-3d; transition: z-index 0.3s; }
        /* OBS: Transição via GSAP no JS, removida do CSS para não conflitar */
        @keyframes cardFloat { 0% { transform: translateY(0); } 100% { transform: translateY(-10px); } }
        
        .face { width: 100%; height: 100%; position: absolute; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 3rem; backface-visibility: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.8); overflow: hidden; }
        .front { background: #e0e0e0; transform: rotateY(180deg); border: 2px solid #555; color: #222; transition: border-color 0.3s, box-shadow 0.3s; }
        .face.front img { width: 150%; height: 150%; object-fit: contain; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3)); pointer-events: none; }
        
        /* CORREÇÃO DO VERSO (ICONE.PNG) */
        .back { 
            background: #1a1a1a; 
            background-image: url('Imagens/icone.png');
            background-size: 60%;
            background-position: center;
            background-repeat: no-repeat;
            border: 2px solid #444; 
            color: #444; 
        }
        
        .card.matched .front { border-color: #fff; box-shadow: 0 0 30px var(--accent-gold); }
        .card.chaos-glow { box-shadow: 0 0 50px var(--chaos-purple), inset 0 0 30px var(--chaos-purple); border: 2px solid var(--chaos-purple); animation: none; }
        
        /* Skins */
        .card-skin-silver .back { background-color: #2c3e50; border-color: #7f8c8d; }
        .card-skin-gold .back { background-color: #7d6608; border-color: #f1c40f; }
        .card-skin-diamond .back { background-color: #1f618d; border-color: #5dade2; }
        .card-skin-mythril .back { background-color: #0b5345; border-color: #48c9b0; }
        .card-skin-cosmic .back { background: linear-gradient(145deg, #4a235a, #000); border-color: #d2b4de; }

        /* FURY MODE */
        .card-grid.fury-active .card .front { border-color: #ff4500; box-shadow: 0 0 20px #ff4500, inset 0 0 10px #ff8c00; animation: furyBurn 0.5s infinite alternate; }
        .card-grid.fury-active .card .back { border-color: #ff4500; box-shadow: 0 0 20px #ff4500; }
        @keyframes furyBurn { 0% { box-shadow: 0 0 15px #ff4500; } 100% { box-shadow: 0 0 40px #ff4500, 0 0 20px #ffff00; filter: brightness(1.3); } }

        /* --- NOTIFICAÇÕES & POPUPS --- */
        #magic-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 30000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .magic-alert-box { background: linear-gradient(135deg, #121212, #000); border: 2px solid var(--accent-gold); padding: 50px 80px; text-align: center; border-radius: 12px; box-shadow: 0 0 80px rgba(197, 160, 40, 0.4); max-width: 500px; display:flex; flex-direction:column; align-items:center; gap:25px; transform: scale(0.8); opacity: 0; transition: all 0.3s ease; }
        .magic-alert-box.show { transform: scale(1); opacity: 1; }
        .magic-alert-box h3 { color: var(--accent-gold); font-family: 'Cinzel'; font-size: 2rem; margin:0; letter-spacing: 2px; }
        .magic-alert-box p { color: #ddd; font-family: 'MedievalSharp'; font-size: 1.3rem; margin:0; }
        .magic-alert-btn { background: transparent; border: 1px solid var(--accent-gold); color: var(--accent-gold); padding: 15px 40px; font-family: 'Cinzel'; cursor: pointer; transition: 0.3s; font-size: 1.1rem; text-transform:uppercase; letter-spacing: 2px; } .magic-alert-btn:hover { background: var(--accent-gold); color: #000; box-shadow: 0 0 30px var(--accent-gold); }

        .notification-bar { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #000; padding: 15px 60px; border: 2px solid var(--accent-gold); font-family: 'Cinzel'; font-size: 1.3rem; color: var(--accent-gold); opacity: 0; pointer-events: none; transition: opacity 0.5s; z-index: 20000; text-shadow: 0 0 15px var(--accent-gold); box-shadow: 0 10px 50px rgba(0,0,0,1); border-radius: 4px; }
        .notification-bar.show { opacity: 1; }
        
        /* Combo VFX */
        #combo-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 5000; pointer-events: none; }
        .combo-text { font-size: 5rem; font-weight: 800; font-family: 'Cinzel'; background: linear-gradient(to bottom, #fff 20%, var(--accent-gold) 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 20px var(--accent-gold)); letter-spacing: 5px; z-index: 6000; }
        .combo-text.fury { background: linear-gradient(to bottom, #fff 10%, #ff4500 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 40px #ff4500); }
        .float-score { position: absolute; font-family: 'Cinzel'; font-weight: bold; color: var(--accent-gold); text-shadow: 0 0 5px #000; pointer-events: none; z-index: 500; }

        /* QUIZ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; display: none; align-items: center; justify-content: center; perspective: 1500px; }
        .newspaper { width: 600px; max-height: 90vh; background: #d6cfc7 url('https://www.transparenttextures.com/patterns/aged-paper.png'); color: #111; padding: 40px; border: 2px solid #000; outline: 5px double #222; box-shadow: 0 0 150px rgba(0,0,0,1); transform-style: preserve-3d; opacity: 0; transform: scale(0) rotate(720deg); display: flex; flex-direction: column; }
        .newspaper.streak-glow { box-shadow: 0 0 60px var(--accent-gold), 0 0 100px rgba(197, 160, 40, 0.6); border-color: var(--accent-gold); animation: streakPulse 2s infinite ease-in-out; }
        @keyframes streakPulse { 0% { box-shadow: 0 0 40px var(--accent-gold); filter: brightness(1); } 50% { box-shadow: 0 0 80px var(--accent-gold), 0 0 30px #fff; filter: brightness(1.2); } 100% { box-shadow: 0 0 40px var(--accent-gold); filter: brightness(1); } }
        .news-header { font-family: 'Pirata One'; text-align: center; border-bottom: 4px double #111; padding-bottom: 20px; margin-bottom: 20px; } .news-title { font-size: 4.5rem; margin: 0; text-transform: uppercase; line-height: 0.9; letter-spacing: 2px; }
        .quiz-question-box { font-family: 'MedievalSharp'; font-size: 1.6rem; text-align: center; margin: 30px 0; font-weight: bold; color: #1a1a1a; padding: 25px; background: rgba(0,0,0,0.05); border: 2px dashed #555; }
        .quiz-opt-btn { background: transparent; border: 2px solid #222; padding: 18px; font-family: 'Cinzel'; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: 0.2s; text-align: center; color: #222; margin-bottom: 12px; width: 100%; } .quiz-opt-btn:hover { background: #222; color: #e3dac9; }
        .owl-fx { position: absolute; top: -300px; left: 50%; transform: translateX(-50%); font-size: 10rem; z-index: 6000; pointer-events: none; filter: drop-shadow(0 40px 30px rgba(0,0,0,0.6)); opacity: 0; }
        
        /* Config Panel */
        .avatar-selector { margin: 20px; display: flex; justify-content: center; align-items: center; gap: 20px; } .prof-img-large { width: 160px; height: 160px; max-width: 160px; max-height: 160px; border-radius: 50%; object-fit: cover; border: 4px solid var(--accent-gold); box-shadow: 0 0 30px rgba(0,0,0,0.8); } .arrow-btn { background: none; border: none; color: #555; font-size: 3.5rem; cursor: pointer; transition: 0.2s; } .arrow-btn:hover { color: var(--accent-gold); } .input-magico { background: transparent; border: none; border-bottom: 1px solid var(--accent-gold); color: #fff; font-size: 1.5rem; padding: 10px; text-align: center; width: 80%; font-family: 'Cinzel'; margin: 20px 0; outline: none; }
        .dash-header { display: flex; align-items: center; gap: 25px; margin-bottom: 25px; justify-content: center; } .dash-avatar { width: 110px; height: 110px; border-radius: 50%; border: 3px solid var(--accent-gold); background: #000; overflow: hidden; } .dash-avatar img { width: 100%; height: 100%; object-fit: cover; } .dash-info h1 { margin: 0; color: var(--accent-gold); } .dash-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; } .stat-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 2px; border: 1px solid #333; } .stat-label { font-size: 0.7rem; color: #666; text-transform: uppercase; letter-spacing: 1px; } .stat-val-big { font-size: 1.8rem; color: #fff; font-family: 'Cinzel'; } .btn-delete-save { border-color: var(--danger-red); color: var(--danger-red); opacity: 0.6; margin-top: 20px; font-size: 0.8rem; } .btn-delete-save:hover { background: rgba(139, 0, 0, 0.2); border-color: #ff3333; color: #ff3333; opacity: 1; }
        .dash-header { display: flex; align-items: center; gap: 25px; margin-bottom: 25px; justify-content: center; } .dash-avatar { width: 110px; height: 110px; border-radius: 50%; border: 3px solid var(--accent-gold); background: #000; overflow: hidden; box-sizing: border-box; } .dash-avatar img { width: 100%; height: 100%; object-fit: cover; } .dash-info h1 { margin: 0; color: var(--accent-gold); } .dash-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; } .stat-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 2px; border: 1px solid #333; } .stat-label { font-size: 0.7rem; color: #666; text-transform: uppercase; letter-spacing: 1px; } .stat-val-big { font-size: 1.8rem; color: #fff; font-family: 'Cinzel'; } .btn-delete-save { border-color: var(--danger-red); color: var(--danger-red); opacity: 0.6; margin-top: 20px; font-size: 0.8rem; } .btn-delete-save:hover { background: rgba(139, 0, 0, 0.2); border-color: #ff3333; color: #ff3333; opacity: 1; }
        .cfg-section { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; } .cfg-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: #aaa; font-family: 'Cinzel'; font-size: 1.1rem; } input[type=range] { width: 50%; accent-color: var(--accent-gold); cursor: pointer; } 
        .btn-gear { position: fixed; bottom: 30px; right: 30px; font-size: 3rem; color: rgba(255,255,255,0.3); cursor: pointer; z-index: 5000; transition: 0.3s; filter: drop-shadow(0 0 5px #000); } .btn-gear:hover { transform: rotate(90deg) scale(1.1); color: var(--accent-gold); opacity: 1; }

        #achievement-popup { position: fixed; top: 40px; left: 50%; transform: translateX(-50%) translateY(-200%); background: linear-gradient(to bottom, #d4af37, #8e6d0f); padding: 3px; border-radius: 8px; box-shadow: 0 20px 60px rgba(0,0,0,0.8); z-index: 200000; transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; }
        #achievement-popup.show { transform: translateX(-50%) translateY(0); animation: achPulse 2s infinite ease-in-out; }
        @keyframes achPulse { 0% { box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); filter: brightness(1); } 50% { box-shadow: 0 0 40px rgba(212, 175, 55, 0.9), 0 0 10px #fff; filter: brightness(1.3); } 100% { box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); filter: brightness(1); } }
        .ach-inner { background: #120821; padding: 20px 30px; border-radius: 5px; display: flex; align-items: center; gap: 20px; color: var(--accent-gold); min-width: 400px; }
        .ach-icon { font-size: 3.5rem; filter: drop-shadow(0 0 15px rgba(197, 160, 40, 0.6)); }
        .ach-text { text-align: left; }
        .ach-title { 
            font-family: 'Cinzel'; 
            font-weight: 700; 
            font-size: 1.2rem; 
            margin-bottom: 5px; 
            color: #fff; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .ach-desc { font-family: 'MedievalSharp'; font-size: 1rem; color: #ccc; }
        
        /* Grimorio */
        .grimoire-container { 
            width: 850px; max-width: 90vw; height: 720px; max-height: 85vh; 
            background: #fdf5e6 url('https://www.transparenttextures.com/patterns/aged-paper.png'); 
            border-radius: 4px 15px 15px 4px;
            border-left: 18px solid #3e2723; /* Lombada */
            box-shadow: 
                inset 25px 0 40px rgba(62, 39, 35, 0.5), /* Sombra interna da lombada */
                inset -5px 0 10px rgba(0,0,0,0.1), /* Sombra borda direita */
                5px 5px 0 #dccbb6, /* Pilha de páginas 1 */
                10px 10px 0 #cbb69d, /* Pilha de páginas 2 */
                16px 16px 0 #3e2723, /* Capa traseira */
                30px 30px 50px rgba(0,0,0,0.8); /* Sombra projetada */
            display: flex; flex-direction: column; padding: 50px 60px; 
            position: relative; overflow: hidden; perspective: 1500px; color: #2c1e0b; 
        } 
        .grimoire-header { text-align: center; border-bottom: 3px double #5d4037; padding-bottom: 15px; margin-bottom: 25px; } .grimoire-title { font-family: 'UnifrakturMaguntia'; font-size: 3.5rem; color: #2c1e0b; margin: 0; } .grimoire-subtitle { font-family: 'Cinzel'; font-size: 1.1rem; color: #5d4037; font-weight: bold; } .grimoire-page { flex-grow: 1; display: flex; flex-direction: column; align-items: center; opacity: 1; transform-origin: center center; backface-visibility: hidden; overflow-y: auto; padding-right: 10px; } .grimoire-intro-text { font-family: 'MedievalSharp'; font-size: 1.3rem; color: #2c1e0b; text-align: center; line-height: 1.8; margin: 60px 0; font-style: italic; } .boss-portrait { width: 200px; height: 200px; border: 5px double #5d4037; border-radius: 50%; overflow: hidden; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); background: #fff; } .boss-portrait img { width: 100%; height: 100%; object-fit: cover; } .boss-name-title { font-family: 'MedievalSharp'; font-size: 2rem; color: #8b0000; margin-bottom: 5px; } .boss-honorific { font-family: 'Cinzel'; font-size: 1.1rem; font-weight: bold; color: #555; margin-bottom: 25px; font-style: italic; border-bottom: 1px solid #ccc; padding-bottom: 10px; } .boss-lore-text { font-family: 'MedievalSharp'; font-size: 1.2rem; color: #2c1e0b; text-align: justify; line-height: 1.6; padding: 0 30px; } .grimoire-nav { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding-top: 15px; border-top: 1px solid rgba(93, 64, 55, 0.3); } .page-btn { background: none; border: none; font-family: 'UnifrakturMaguntia'; font-size: 2.5rem; color: #5d4037; cursor: pointer; transition: 0.2s; } .page-btn:hover { color: #8b0000; transform: scale(1.1); } .page-btn:disabled { color: #ccc; cursor: default; transform: none; } .page-number { font-family: 'Cinzel'; font-weight: bold; color: #555; } .grimoire-actions { margin-top: 15px; display: flex; gap: 20px; justify-content: center; } .ach-list { width: 100%; padding: 0 20px; } .ach-item { display: flex; align-items: center; gap: 20px; padding: 15px; border-bottom: 1px solid rgba(93, 64, 55, 0.3); opacity: 0.4; filter: grayscale(1); transition: 0.3s; } .ach-item.unlocked { opacity: 1; filter: grayscale(0); background: rgba(212, 175, 55, 0.15); } .ach-item-icon { font-size: 2.5rem; color: #5d4037; } .ach-item.unlocked .ach-item-icon { color: #b7950b; text-shadow: 0 0 5px rgba(183, 149, 11, 0.5); } .ach-item-text { text-align: left; } .ach-item-text h4 { margin: 0; font-family: 'Cinzel'; color: #2c1e0b; font-size: 1.1rem; font-weight: bold; } .ach-item-text p { margin: 5px 0 0 0; font-family: 'MedievalSharp'; font-size: 0.95rem; color: #555; }
        
        .grimoire-bookmark {
            position: absolute; top: -10px; right: 80px; width: 40px; height: 120px;
            background: linear-gradient(to right, #8b0000, #a00000, #8b0000);
            box-shadow: 2px 5px 10px rgba(0,0,0,0.5);
            clip-path: polygon(0 0, 100% 0, 100% 100%, 50% 80%, 0 100%);
            z-index: 100; cursor: pointer; transform-origin: top center;
        }
        .grimoire-bookmark:hover { animation: bookmarkSwing 1.5s ease-in-out infinite; }
        @keyframes bookmarkSwing { 0% { transform: rotate(0deg); } 25% { transform: rotate(8deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(-8deg); } 100% { transform: rotate(0deg); } }
        
        .grimoire-bookmark::after {
            content: '✦'; position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
            color: #ffd700; font-size: 1.2rem; text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        #exit-screen { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:99999; flex-direction:column; align-items:center; justify-content:center; color:#555; opacity:0; transition:opacity 1s; }

        /* Grimoire Stars */
        #grimoire-stars { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .g-star { position: absolute; background: #fff; border-radius: 50%; animation: starPulse 3s infinite ease-in-out; }
        @keyframes starPulse { 0%, 100% { opacity: 0.3; transform: scale(0.8); box-shadow: none; } 50% { opacity: 1; transform: scale(1.3); box-shadow: 0 0 15px #fff, 0 0 8px #ffd700; } }

        /* Menu Particles */
        .menu-particle { position: fixed; width: 4px; height: 4px; background: radial-gradient(circle, #fff, var(--accent-gold)); border-radius: 50%; pointer-events: none; z-index: 9999; box-shadow: 0 0 8px var(--accent-gold); mix-blend-mode: screen; }

        /* Mist Layer */
        #mist-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, transparent 0%, rgba(200, 220, 255, 0.1) 40%, rgba(255, 255, 255, 0.4) 100%);
            backdrop-filter: blur(5px) grayscale(0.5);
            z-index: 25000; pointer-events: none; opacity: 0; transition: opacity 1.5s ease-in-out;
            mix-blend-mode: hard-light;
        }
        #mist-layer.active { opacity: 1; }

        /* --- NEW PROFILE SCREEN STYLES --- */
        .profile-screen-bg { background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%); overflow: hidden; }
        .glass-panel-premium { background: rgba(10, 12, 16, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(197, 160, 40, 0.3); box-shadow: 0 0 80px rgba(0,0,0,0.8), inset 0 0 30px rgba(0,0,0,0.5); border-radius: 16px; width: 1100px; max-width: 95%; padding: 40px; display: flex; flex-direction: column; position: relative; z-index: 10; }
        .profile-header { text-align: center; margin-bottom: 30px; }
        .profile-page-title { font-family: 'Cinzel', serif; font-size: 2.5rem; color: var(--accent-gold); text-transform: uppercase; letter-spacing: 6px; margin: 0; text-shadow: 0 0 15px rgba(197, 160, 40, 0.5); }
        .profile-divider { height: 2px; width: 150px; background: linear-gradient(90deg, transparent, var(--accent-gold), transparent); margin: 10px auto 0; }
        .profile-content { display: flex; gap: 50px; align-items: center; }
        @media (max-width: 800px) { .profile-content { flex-direction: column; gap: 30px; } }
        
        /* Left Column */
        .profile-identity-section { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .avatar-display-wrapper { position: relative; width: 220px; height: 220px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
        .avatar-glow-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle, rgba(197, 160, 40, 0.2) 0%, transparent 70%); animation: pulseGlow 3s infinite ease-in-out; z-index: 0; }
        .avatar-frame-large { width: 180px; height: 180px; border-radius: 50%; overflow: hidden; border: 4px solid var(--accent-gold); box-shadow: 0 0 30px rgba(0,0,0,0.8); z-index: 1; position: relative; background: #000; transition: all 0.3s ease; }
        .avatar-frame-large img { width: 100%; height: 100%; object-fit: cover; }
        .player-identity { text-align: center; width: 100%; }
        .player-name { font-family: 'Cinzel', serif; font-size: 2rem; color: #fff; margin: 10px 0 5px; text-shadow: 0 2px 5px rgba(0,0,0,0.8); }
        .player-name-input { background: rgba(255,255,255,0.05); border: none; border-bottom: 2px solid var(--accent-gold); color: #fff; font-family: 'Cinzel', serif; font-size: 1.8rem; text-align: center; width: 100%; padding: 5px; margin: 10px 0; outline: none; }
        .player-title { font-family: 'MedievalSharp', cursive; font-size: 1.2rem; color: var(--magic-blue); letter-spacing: 2px; text-transform: uppercase; }
        
        /* Controls */
        .avatar-controls { display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 10px; width: 100%; position: relative; z-index: 20; }
        .magic-arrow-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: var(--accent-gold); width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .magic-arrow-btn:hover { background: var(--accent-gold); color: #000; box-shadow: 0 0 10px var(--accent-gold); }
        .control-label { font-family: 'Cinzel'; font-size: 0.9rem; color: #aaa; }
        .frame-info { text-align: center; min-width: 120px; }
        .frame-info span { display: block; color: var(--accent-gold); font-family: 'Cinzel'; font-size: 1rem; }
        .frame-info small { display: block; color: #666; font-size: 0.75rem; }
        
        /* Right Column */
        .profile-stats-section { flex: 1.5; display: flex; flex-direction: column; gap: 25px; }
        .level-progress-container { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
        .level-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-family: 'Cinzel'; }
        .level-label { color: #aaa; font-size: 0.9rem; letter-spacing: 1px; }
        .level-value { color: var(--accent-gold); font-size: 1.2rem; font-weight: bold; }
        .xp-bar-track { width: 100%; height: 10px; background: #111; border-radius: 5px; overflow: hidden; box-shadow: inset 0 0 5px #000; position: relative; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--magic-blue), #00d2ff); box-shadow: 0 0 10px var(--magic-blue); transition: width 1s ease-out; }
        .xp-text { text-align: right; font-size: 0.8rem; color: #666; margin-top: 5px; font-family: 'MedievalSharp'; }
        
        .stats-grid-premium { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card-premium { background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(0,0,0,0.2)); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 15px; transition: transform 0.2s; }
        .stat-card-premium:hover { transform: translateY(-2px); border-color: var(--accent-gold); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .stat-icon { font-size: 2rem; filter: drop-shadow(0 0 5px rgba(255,255,255,0.2)); }
        .stat-details { display: flex; flex-direction: column; }
        .stat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-family: 'Cinzel'; font-size: 1.4rem; color: #fff; font-weight: bold; }
        
        /* Buttons */
        .profile-actions { margin-top: 10px; display: flex; justify-content: flex-end; }
        .action-group { display: flex; gap: 15px; }
        .btn-premium { background: linear-gradient(180deg, rgba(20, 30, 40, 0.9), #050505); border: 1px solid var(--accent-gold); color: var(--accent-gold); padding: 12px 30px; font-family: 'Cinzel'; font-size: 1rem; letter-spacing: 2px; cursor: pointer; transition: all 0.3s ease; border-radius: 4px; display: flex; align-items: center; gap: 10px; text-transform: uppercase; }
        .btn-premium:hover { background: var(--accent-gold); color: #000; box-shadow: 0 0 20px rgba(197, 160, 40, 0.4); transform: translateY(-2px); }
        .btn-secondary { border-color: #555; color: #aaa; }
        .btn-secondary:hover { background: #333; color: #fff; border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .btn-save { border-color: var(--magic-blue); color: var(--magic-blue); }
        .btn-save:hover { background: var(--magic-blue); color: #fff; box-shadow: 0 0 20px var(--magic-blue); }

        /* FOOTER INFO */
        .game-footer { position: fixed; bottom: 5px; width: 100%; text-align: center; font-family: 'Cinzel', serif; font-size: 0.75rem; color: rgba(255, 255, 255, 0.25); z-index: 20005; pointer-events: none; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 1px 2px #000; }

        /* FIX: Settings Screen Z-Index & Interaction */
        #screen-settings { z-index: 20000 !important; }
        #screen-settings .panel-glass { pointer-events: auto !important; }
        #screen-settings .btn-main { pointer-events: auto !important; cursor: pointer; }
    </style>
</head>
<body>
    <!-- SVG Filter for Chromatic Aberration -->
    <svg style="display: none;">
        <defs>
            <filter id="chromatic-aberration">
                <feColorMatrix type="matrix" values="1 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 0" in="SourceGraphic" result="red"/>
                <feOffset in="red" dx="3" dy="0" result="red_offset"/>
                <feColorMatrix type="matrix" values="0 0 0 0 0  0 1 0 0 0  0 0 0 0 0  0 0 0 1 0" in="SourceGraphic" result="green"/>
                <feColorMatrix type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 1 0 0  0 0 0 1 0" in="SourceGraphic" result="blue"/>
                <feOffset in="blue" dx="-3" dy="0" result="blue_offset"/>
                <feBlend mode="screen" in="red_offset" in2="green" result="rg"/>
                <feBlend mode="screen" in="rg" in2="blue_offset" result="rgb"/>
            </filter>
            <filter id="gravitational-distortion">
                <feTurbulence type="fractalNoise" baseFrequency="0.03" numOctaves="3" seed="1" result="noise">
                    <animate attributeName="baseFrequency" values="0.03;0.05;0.03" dur="3s" repeatCount="indefinite" />
                </feTurbulence>
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="20" xChannelSelector="R" yChannelSelector="G" />
                <feGaussianBlur stdDeviation="0.5" />
            </filter>
        </defs>
    </svg>

    <div id="dynamic-bg-layer" class="env-default"></div>
    <canvas id="magic-canvas"></canvas>
    <div id="vfx-container"></div>
    <div id="fx-overlay"></div>
    <div id="combo-pulse-layer"></div>
    <div id="time-warning-layer"></div>
    <div id="fade-layer"></div>
    <div id="mist-layer"></div>
    <canvas id="portal-canvas"></canvas>
    <div id="black-hole"></div>
    
    <div id="crack-fx">
        <svg id="crack-svg" viewBox="0 0 500 500"><path class="crack-path" d="M250 250 L300 150 L320 100 M250 250 L150 200 L100 180 M250 250 L200 350 L180 400 M250 250 L350 300 L400 320 M250 250 L280 220 L350 200 M250 250 L220 280 L150 300"></path></svg>
    </div>

    <div id="combo-container"></div>
    <div class="notification-bar" id="notif-bar">Mensagem</div>
    <div style="display:none;" id="motes"></div>

    <div id="magic-alert-modal">
        <div class="magic-alert-box" id="magic-modal-content">
            </div>
    </div>

    <div id="modal-delete-confirm" class="modal-overlay" style="z-index: 35000;">
        <div class="magic-alert-box show" style="border-color: var(--danger-red); box-shadow: 0 0 60px rgba(139, 0, 0, 0.5);">
            <h3 style="color: var(--danger-red); text-shadow: 0 0 10px var(--danger-red);" data-lang="del_title">O VAZIO AGUARDA</h3>
            <p style="margin: 15px 0; text-align: center; color: #ccc; font-family: 'MedievalSharp';"><span data-lang="del_msg">Deseja banir este Mago para o esquecimento eterno?</span><br><span style="font-size: 0.9rem; color: #888;" data-lang="del_warn">(Todo o progresso será perdido)</span></p>
            <div style="display: flex; gap: 20px; margin-top: 15px;">
                <div class="magic-alert-btn" style="border-color: var(--danger-red); color: var(--danger-red);" onclick="executeDeleteSlot()" data-lang="del_btn_ban">BANIR</div>
                <div class="magic-alert-btn" onclick="playS('click'); closeDeleteModal()" data-lang="del_btn_cancel">CANCELAR</div>
            </div>
        </div>
    </div>

    <div id="modal-quiz" class="modal-overlay">
        <div class="newspaper" id="quiz-paper">
            <div class="news-header"><div class="news-title" data-lang="quiz_paper_name">O Profeta Arcano</div><div class="news-subtitle"><span data-lang="quiz_edition">EDIÇÃO EXTRA</span><span data-lang="quiz_academy">ACADEMIA</span><span data-lang="quiz_urgent">URGENTE</span></div></div>
            <div class="news-content"><div class="headline" data-lang="quiz_timeout_title">TEMPO ESGOTADO!</div><div class="sub-headline" data-lang="quiz_desc">Responda para evitar a expulsão eminente.</div><div class="quiz-question-box"><p id="quiz-q">Pergunta...</p></div><div id="quiz-ops"></div></div>
            <div class="news-footer" data-lang="quiz_footer">O CONSELHO AGUARDA SUA RESPOSTA.</div>
        </div>
    </div>

    <div id="achievement-popup"><div class="ach-inner"><div class="ach-icon" id="ach-pop-icon">🏆</div><div class="ach-text"><div class="ach-title" id="ach-pop-title">Conquista!</div><div class="ach-desc" id="ach-pop-desc">Desc.</div></div></div></div>
    <div class="owl-fx" id="fx-owl">🦉</div>
    
    <audio id="ost-menu" src="Sons/musica_menu.mp3" loop></audio> 
    <audio id="ost-game" src="Sons/musica_jogo.mp3" loop></audio>
    <audio id="amb-menu" src="Sons/ambience_menu.mp3" loop></audio>

    <div id="screen-intro">
        <div class="intro-container">
            <div class="magic-overlay"></div>
            <video id="intro-video" muted playsinline preload="auto" loop autoplay><source src="Videos/intro.mp4" type="video/mp4"></video>
            <div id="start-btn-intro" onclick="playIntroSound()" data-lang="intro_start">INICIAR JORNADA</div>
            <div id="skip-text" onclick="endIntro()" data-lang="intro_skip">PULAR INTRO</div>
        </div>
    </div>

    <div id="screen-menu" class="screen">
        <div class="menu-overlay"></div>
        <div class="menu-card">
            <div class="title-glow-fx"></div><div class="beta-badge">DEMO PATCH 2.1</div>
            <div class="menu-options-container">
                <div class="magic-menu-card disabled" id="btn-continue" onclick="playS('click'); continuarJogo()"><div class="card-icon">📜</div><div class="card-label" data-lang="menu_continue">Continuar</div></div>
                <div class="magic-menu-card" onclick="playS('click'); novoJogo()"><div class="card-icon">✨</div><div class="card-label" data-lang="menu_play">Modo História</div></div>
                <div class="magic-menu-card" id="btn-ngplus" style="display:none; border-color:var(--danger-red);" onclick="playS('click'); iniciarNewGamePlus()"><div class="card-icon" style="color:var(--danger-red);">🔥</div><div class="card-label" style="color:var(--danger-red);">Despertar Arcano</div></div>
                <div class="magic-menu-card" id="btn-infinite" style="display:none; border-color:var(--chaos-purple);" onclick="playS('click'); openInfiniteMenu()"><div class="card-icon" style="color:var(--chaos-purple);">♾️</div><div class="card-label" style="color:var(--chaos-purple);" data-lang="menu_infinite">Infinito</div></div>
                <div class="magic-menu-card" id="btn-grimoire-menu" style="display:none; border-color:var(--accent-gold);" onclick="playS('click'); toggleGrimoireWithMist('open')"><div class="lock-icon" style="display:none;">🔒</div><div class="card-icon" style="color:var(--accent-gold);">📖</div><div class="card-label" style="color:var(--accent-gold);" data-lang="menu_grimoire">Grimório</div></div>
                <div class="magic-menu-card" onclick="playS('click'); abrirPerfilMenu()"><div class="card-icon">🧙‍♂️</div><div class="card-label" data-lang="menu_profile">Perfil</div></div>
                <div class="magic-menu-card" onclick="playS('click'); openConfigMenu('menu')"><div class="card-icon">⚙️</div><div class="card-label" data-lang="menu_options">Opções</div></div>
            </div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="hud-top">
            <div class="profile-card-hud" id="hud-avatar-container"><div class="avatar-frame"><img id="hud-av-img" src="" alt="Av"></div><div class="player-info"><div class="p-name" id="hud-name">Player</div><div class="p-lvl"><span data-lang="hud_lvl">Nível</span> <span id="hud-lvl">1</span></div></div></div>
            <div class="stats-card-hud"><span><span data-lang="hud_stage">Fase</span> <b class="val-gold" id="ui-fase">1</b></span><span id="box-tempo"><span data-lang="hud_time">Tempo</span> <b class="val-gold" id="ui-tempo">60</b></span><span><span data-lang="hud_pts">Pts</span> <b class="val-blue" id="ui-score">0</b></span></div>
        </div>
        <div class="game-area">
            <div class="boss-panel">
                <div id="boss-speech" class="boss-speech-bubble">...</div>
                <div id="boss-vis" class="boss-img"><img id="boss-img-tag" src="" alt="Boss"></div>
                <div id="boss-n">BOSS</div>
                <div class="boss-hp-bg"><div class="boss-hp-fill" id="hp-bar"></div></div>
            </div>
            <div class="card-grid grid-4" id="board"></div>
        </div>
        <div class="btn-gear" onclick="playS('click'); openConfigMenu('game')">⚙️</div>
    </div>

    <div id="screen-profile" class="screen profile-screen-bg">
        <div class="glass-panel-premium">
            <div class="profile-header">
                <h2 class="profile-page-title" data-lang="profile_title">Registro Mágico</h2>
                <div class="profile-divider"></div>
            </div>
            <div class="profile-content">
                <!-- Left Column: Avatar & Identity -->
                <div class="profile-identity-section">
                    <div class="avatar-display-wrapper">
                        <div class="avatar-glow-ring"></div>
                        <div class="avatar-frame-large" id="profile-avatar-frame">
                            <img id="dash-av-img" src="" alt="Avatar">
                            <img id="prof-av-edit" src="" alt="Avatar Edit" style="display:none;">
                        </div>
                    </div>
                    <div id="avatar-controls" class="avatar-controls" style="display:none;">
                        <button class="magic-arrow-btn" onclick="playS('click'); mudarAvatar(-1)">❮</button><span class="control-label">Avatar</span><button class="magic-arrow-btn" onclick="playS('click'); mudarAvatar(1)">❯</button>
                    </div>
                    <div id="frame-controls" class="avatar-controls" style="display:none;">
                        <button class="magic-arrow-btn" onclick="playS('click'); mudarFrame(-1)">❮</button><div class="frame-info"><span id="frame-name">Padrão</span><small id="frame-req">Desbloqueado</small></div><button class="magic-arrow-btn" onclick="playS('click'); mudarFrame(1)">❯</button>
                    </div>
                    <div class="player-identity">
                        <h1 id="dash-name" class="player-name">Nome do Jogador</h1>
                        <input type="text" id="prof-name-input" class="player-name-input" placeholder="Seu Nome" style="display:none;">
                        <div id="dash-title" class="player-title">Aprendiz</div>
                    </div>
                </div>
                <!-- Right Column: Stats & Details -->
                <div class="profile-stats-section">
                    <div class="level-progress-container">
                        <div class="level-info"><span class="level-label" data-lang="stat_lvl">Nível Arcano</span><span class="level-value" id="dash-lvl">1</span></div>
                        <div class="xp-bar-track"><div class="xp-bar-fill" id="dash-xp-bar" style="width: 0%"></div></div>
                        <div class="xp-text"><span id="dash-xp-current">0</span> / <span id="dash-xp-next">100</span> XP</div>
                    </div>
                    <div class="stats-grid-premium">
                        <div class="stat-card-premium"><div class="stat-icon">🏆</div><div class="stat-details"><span class="stat-label" data-lang="stat_record">Recorde</span><span class="stat-value" id="dash-score">0</span></div></div>
                        <div class="stat-card-premium"><div class="stat-icon">⚔️</div><div class="stat-details"><span class="stat-label">Vitórias</span><span class="stat-value" id="dash-wins">0</span></div></div>
                        <div class="stat-card-premium"><div class="stat-icon">🕹️</div><div class="stat-details"><span class="stat-label">Partidas</span><span class="stat-value" id="dash-games">0</span></div></div>
                        <div class="stat-card-premium"><div class="stat-icon">⏳</div><div class="stat-details"><span class="stat-label">Tempo</span><span class="stat-value" id="dash-time">0h</span></div></div>
                    </div>
                    <div class="profile-actions">
                        <div id="view-mode-btns" class="action-group">
                            <button id="btn-prof-play" class="btn-premium" style="display:none; border-color:var(--magic-blue); color:var(--magic-blue);" onclick="playS('click'); enterGameFromProfile()"><span class="btn-icon">✨</span> Jogar</button>
                            <button class="btn-premium" onclick="playS('click'); setProfileMode('edit')" data-lang="btn_edit"><span class="btn-icon">✎</span> Editar</button>
                            <button class="btn-premium btn-secondary" onclick="playS('click'); exitProfile()" data-lang="btn_back"><span class="btn-icon">↩</span> Voltar</button>
                        </div>
                        <div id="edit-mode-btns" class="action-group" style="display:none;">
                            <button class="btn-premium btn-save" onclick="playS('click'); saveProfileData()" data-lang="btn_save"><span class="btn-icon">💾</span> Salvar</button>
                            <button class="btn-premium btn-secondary" onclick="playS('click'); cancelProfileEdit()" data-lang="btn_cancel"><span class="btn-icon">✖</span> Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <div class="panel-glass">
            <h2 style="color:var(--accent-gold)" data-lang="settings_title">OPÇÕES</h2>
            <div class="cfg-section"><h3 data-lang="settings_audio">ÁUDIO</h3><div class="cfg-row"><span data-lang="settings_music">Música</span><input type="range" min="0" max="1" step="0.1" id="rng-musica" oninput="setAudio('m', this.value)"></div><div class="cfg-row"><span data-lang="settings_sfx">Efeitos</span><input type="range" min="0" max="1" step="0.1" id="rng-sfx" oninput="setAudio('s', this.value)"></div></div>
            <div class="btn-main" onclick="playS('click'); voltarConfig()" data-lang="btn_back">Voltar</div>
            <div id="btn-quit-match" class="btn-main" style="border-color:var(--combo-orange); color:var(--combo-orange); display:none; margin-top:10px;" onclick="playS('click'); sairParaMenu()" data-lang="btn_quit">Voltar ao Menu Principal</div>
        </div>
    </div>

    <div id="screen-credits" class="screen" style="background:radial-gradient(circle at center, #1a0b2e 0%, #000000 100%); z-index:20005; display:none;">
        <div id="grimoire-stars"></div>
        <div class="grimoire-container">
            <div class="grimoire-bookmark" onclick="playS('click')"></div>
            <div class="grimoire-header"><h1 class="grimoire-title">Grimório das Lendas</h1><div class="grimoire-subtitle">Os Desafios Superados</div></div>
            <div id="book-content" class="grimoire-page"></div>
            <div class="grimoire-nav"><button class="page-btn" id="prev-btn" onclick="prevPage()">❮</button><div class="page-number">Página <span id="page-num">1</span></div><button class="page-btn" id="next-btn" onclick="nextPage()">❯</button></div>
        </div>
        <div class="grimoire-actions"><div class="btn-main" style="width:250px; background:rgba(0,0,0,0.8); border:1px solid var(--accent-gold); color:var(--accent-gold); box-shadow:0 0 20px rgba(197, 160, 40, 0.3); border-radius: 50px;" onclick="playS('click'); toggleGrimoireWithMist('close')">Voltar ao Menu</div></div>
    </div>

    <div id="modal-infinite" class="modal-overlay">
        <div class="panel-glass" style="width: 500px; position: relative;">
            <div class="btn-close-modal" onclick="document.getElementById('modal-infinite').style.display='none'">✖</div>
            <h2 style="color:var(--chaos-purple); text-shadow: 0 0 10px var(--chaos-purple);">MODO INFINITO</h2>
            <div style="margin: 20px 0; font-family: 'MedievalSharp'; color: #ccc;">Sobreviva o máximo que puder.<br>A dificuldade aumenta a cada passo.</div>
            <div class="ranking-box"><h3 style="color:var(--accent-gold); border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:10px;">HALL DAS LENDAS</h3><div id="infinite-ranking-list" style="max-height: 200px; overflow-y: auto; text-align: left; padding: 5px;"></div></div>
            <div class="btn-main" style="border-color:var(--chaos-purple); color:var(--chaos-purple);" onclick="playS('click'); startInfiniteRun()">INICIAR RUN</div>
        </div>
    </div>

    <div id="modal-ngplus" class="modal-overlay">
        <div class="panel-glass" style="width: 500px; position: relative; border-color: var(--danger-red); box-shadow: 0 0 50px rgba(139, 0, 0, 0.3);">
            <div class="btn-close-modal" onclick="document.getElementById('modal-ngplus').style.display='none'">✖</div>
            <h2 style="color:var(--danger-red); text-shadow: 0 0 10px var(--danger-red);">NEW GAME +</h2>
            <div style="margin: 20px 0; font-family: 'MedievalSharp'; color: #ccc;">O desafio definitivo aguarda.<br><br><span style="color:#aaa; font-size:0.95rem;">🔥 Tempo Reduzido (45s)<br>🃏 Tabuleiro Expandido (24 Cartas)</span></div>
            <div class="btn-main" style="border-color:var(--danger-red); color:var(--danger-red);" onclick="confirmNewGamePlus()">INICIAR PESADELO</div>
        </div>
    </div>

    <div id="screen-slots" class="screen" style="display:none; background: #050505; z-index: 30000;">
        <div class="panel-glass" style="width: 800px; max-width: 95%;">
            <h2 style="color:var(--accent-gold); margin-bottom: 10px;" data-lang="slots_title">SELECIONE UM PERFIL</h2>
            <div class="slots-container" id="slots-list" style="display:flex; gap:20px; justify-content:center; margin-top:30px; flex-wrap: wrap;"></div>
            <div class="btn-main" style="margin-top: 30px; width: 200px; margin-left: auto; margin-right: auto;" onclick="playS('click'); changeUIState('MAIN_MENU')" data-lang="btn_back">Voltar</div>
        </div>
    </div>

    <div id="exit-screen"><div style="font-family:'Cinzel'; font-size:2rem; margin-bottom:20px; color:var(--accent-gold); text-shadow:0 0 10px var(--accent-gold);">Até logo, Mago.</div></div>

    <div class="game-footer">Versão 1.1.0 | Arcane Academy &copy; Davi Eduardo</div>

    <script>
        /**
         * Arcane Academy [DEMO] - Patch 2.1
         * Refatoração para Performance e Manutenibilidade
         */

        let ipcRenderer; 
        try { ipcRenderer = require('electron').ipcRenderer; } catch(e) {}

        // --- 1. CONSTANTES E DADOS ---
        
        /**
         * UI STATE MANAGER
         * Centraliza o fluxo de navegação e estados da interface.
         */
        const UI_STATES = {
            INTRO: 'intro',
            MAIN_MENU: 'menu',
            PROFILE_SELECT: 'slots',
            PROFILE_VIEW: 'profile_view',
            PROFILE_CREATE: 'profile_create',
            GAME: 'game',
            SETTINGS: 'settings',
            CREDITS: 'credits'
        };

        let currentState = UI_STATES.INTRO;
        let previousState = UI_STATES.MAIN_MENU;

        function changeUIState(newState, params = {}) {
            // Salva estado anterior para retornos (exceto se for transição interna de perfil)
            if (newState !== UI_STATES.PROFILE_VIEW && newState !== UI_STATES.PROFILE_CREATE) {
                if (currentState !== UI_STATES.SETTINGS) previousState = currentState;
            }
            currentState = newState;

            // Lógica de Estado
            switch(newState) {
                case UI_STATES.MAIN_MENU:
                    _renderScreen('screen-menu');
                    checkSave();
                    animateMenuEntrance();
                    break;
                case UI_STATES.PROFILE_SELECT:
                    initSlots();
                    _renderScreen('screen-slots');
                    break;
                case UI_STATES.PROFILE_VIEW:
                    setProfileMode('view');
                    _renderScreen('screen-profile');
                    break;
                case UI_STATES.PROFILE_CREATE:
                    setProfileMode('create');
                    _renderScreen('screen-profile');
                    break;
                case UI_STATES.GAME:
                    _renderScreen('screen-game');
                    break;
                case UI_STATES.SETTINGS:
                    _renderScreen('screen-settings');
                    break;
                case UI_STATES.CREDITS:
                    _renderScreen('screen-credits');
                    break;
            }
        }

        // Função interna de renderização (antiga navegar)
        function _renderScreen(id) {
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('active');
                s.style.display = 'none';
            });
            const t = document.getElementById(id);
            if(t) {
                t.style.display = 'flex';
                setTimeout(() => t.classList.add('active'), 10);
            }
        }

        const CONFIG_DEFAULTS = {
            MUSIC_VOL: 0.2,
            SFX_VOL: 0.5,
            PARTICLES: true
        };

        const UI = {
            screens: {},
            hud: {},
            boss: {},
            modal: {},
            init() {
                // Cache de elementos frequentes
                this.screens.menu = document.getElementById('screen-menu');
                this.screens.game = document.getElementById('screen-game');
                this.screens.profile = document.getElementById('screen-profile');
                this.screens.settings = document.getElementById('screen-settings');
                this.hud.score = document.getElementById('ui-score');
                this.hud.tempo = document.getElementById('ui-tempo');
                this.hud.fase = document.getElementById('ui-fase');
                this.board = document.getElementById('board');
            }
        };

        const avatares = [ { file: "mago_aprendiz.png", color: "#3498db" }, { file: "feiticeira_natureza.png", color: "#2ecc71" }, { file: "guerreiro_magico.png", color: "#e74c3c" }, { file: "mago_sabio.png", color: "#9b59b6" }, { file: "feiticeira_lua.png", color: "#00d2ff" } ];
        
        const molduras = [
            { name: "Padrão", req: "Desbloqueado", unlock: p => true, apply: (el, c) => { el.style.border = `4px solid ${c}`; el.style.boxShadow = `0 0 20px ${c}`; } },
            { name: "Veterano", req: "Nível 10", unlock: p => p.lvl >= 10, apply: (el, c) => { el.style.border = `4px double #cd7f32`; el.style.boxShadow = `0 0 15px #cd7f32`; } },
            { name: "Elite", req: "Nível 25", unlock: p => p.lvl >= 25, apply: (el, c) => { el.style.border = `4px solid #c0c0c0`; el.style.boxShadow = `0 0 20px #c0c0c0`; } },
            { name: "Mestre", req: "Nível 50", unlock: p => p.lvl >= 50, apply: (el, c) => { el.style.border = `4px solid #ffd700`; el.style.boxShadow = `0 0 25px #ffd700`; } },
            { name: "Lenda", req: "Grimório", unlock: p => p.grimoireUnlocked, apply: (el, c) => { el.style.border = `4px double #fff`; el.style.boxShadow = `0 0 30px #fff, inset 0 0 10px #fff`; } },
            { name: "Vazio", req: "Infinito", unlock: p => p.infiniteUnlocked, apply: (el, c) => { el.style.border = `4px dashed #6c3483`; el.style.boxShadow = `0 0 20px #6c3483`; } }
        ];
        
        const titulos = ["Aprendiz", "Novato", "Estudante", "Adepto", "Feiticeiro", "Mago", "Bruxo", "Encantador", "Mestre", "Grão-Mestre", "Arquimago", "Auror", "Lenda", "Semideus", "Divindade Arcana"];
        
        const bosses = [
            { n:"Glacia", title:"A Sentinela do Inverno", file:"fada_gelo.png", color:"#00d2ff", lore:"Antigamente uma fada que trazia o orvalho da manhã, Glacia foi corrompida quando um estudante tentou aprisionar o frio em um frasco. Agora, ela protege o Pico de Cristal, acreditando que qualquer estranho é um ladrão de essência ártica.", env:"env-glacia", phrases:["O zero absoluto se aproxima.", "Sinta a mordida do inverno eterno.", "Cristais de gelo perfuram a alma.", "A nevasca sussurra seu fim.", "Nem o fogo resiste ao meu toque.", "Durma sob o manto branco.", "Sua magia treme de frio?", "O Pico de Cristal não perdoa."], missPhrases:["Seus dedos congelaram?", "A frieza entorpece sua mente.", "Tão lento quanto uma geleira.", "O gelo reflete sua falha."] },
            { n:"Thalros", title:"O Titã de Pedra", file:"golem_pedra.png", color:"#d35400", lore:"Thalros não foi construído para lutar, mas para servir de biblioteca viva para as primeiras runas de proteção. Com o tempo, o musgo cobriu suas escrituras e ele esqueceu os comandos de desativação. Ele esmaga qualquer um que considere uma ameaça ao conhecimento antigo.", env:"env-thalros", phrases:["A rocha é eterna, você é efêmero.", "Minhas runas brilham com fúria.", "O peso da montanha cairá sobre ti.", "Conhecimento antigo, defesa impenetrável.", "Você não passará pela muralha viva.", "Sinta o tremor da terra.", "Sou o guardião das eras.", "Pedra não sangra, mago."], missPhrases:["Sua magia ricocheteia.", "Duro como pedra, não?", "Tente quebrar uma montanha.", "Fútil contra a rocha."] },
            { n:"Umbra", title:"O Eco do Abismo", file:"espectro_sombras.png", color:"#8e44ad", lore:"Umbra é a amálgama dos medos deixados para trás por alunos que falharam. Ela não possui forma física constante, habitando as sombras dos corredores proibidos e alimentando-se da hesitação de quem ousa atravessá-los.", env:"env-umbra", phrases:["A luz projeta sombras, e eu sou todas elas.", "O abismo olha de volta para você.", "Seus segredos alimentam minha força.", "Não há onde se esconder na escuridão.", "Abrace o silêncio eterno.", "Sua coragem se desfaz como fumaça.", "Eu sou o pesadelo que você esqueceu.", "A escuridão consome tudo."], missPhrases:["Tateando no escuro?", "O medo te cegou?", "Você luta contra o nada.", "A sombra desviou seu golpe."] },
            { n:"Ferrum", title:"O Golem de Ferro", file:"gargula_ferro.png", color:"#7f8c8d", lore:"Forjado durante a Grande Guerra Mágica para ser indestrutível. Ele é uma máquina de guerra movida por um feitiço de sangue que o obriga a guardar o portão principal até que seu mestre — morto há séculos — o dispense.", env:"env-ferrum", phrases:["Protocolo Arcano: Aniquilação.", "Aço forjado em sangue mágico.", "Sua magia não penetra minha blindagem.", "O Portão permanece selado.", "Engrenagens da guerra giram novamente.", "Resistência é ilógica.", "Ferro frio anula sua feitiçaria.", "Sentinela eterno, vigilância constante."], missPhrases:["Cálculo incorreto.", "Blindagem intacta.", "Erro de execução.", "Sua lógica falhou."] },
            { n:"Solari", title:"A Fênix Renascida", file:"fenix_fogo.png", color:"#e67e22", lore:"Solari surge apenas quando a magia da academia está instável. Sua luz é tão intensa que pode cegar os impuros. Para os heróis, derrotá-la não é um ato de violência, mas um teste de resistência ao calor absoluto.", env:"env-solari", phrases:["O sol nasce para julgar.", "Minhas chamas purificam a corrupção.", "Cinzas são o destino dos impuros.", "O calor da criação e da destruição.", "Renascerei quantas vezes for preciso.", "Não ouse olhar diretamente para a luz.", "A chama sagrada não se apaga.", "Sinta o ardor da justiça."], missPhrases:["Ofuscado pela glória?", "O calor te confunde?", "Queimou os dedos?", "A luz revelou seu erro."] },
            { n:"Aurelius", title:"O Dragão da Ganância", file:"dragao_dourado.png", color:"#f1c40f", lore:"Um dragão que se apaixonou pelos tesouros da escola. A magia acumulada fundiu o ouro de sua toca diretamente em suas escamas. Ele vê cada item do seu inventário como uma joia que deve pertencer a ele.", env:"env-aurelius", phrases:["Sua ganância não supera a minha.", "Ouro fundido corre em minhas veias.", "Você é apenas mais uma joia para minha coleção.", "O brilho deste tesouro será a última coisa que verá.", "Dragões não dividem.", "Pagará com sua vida pelo que tocou.", "Minhas escamas são impenetráveis como diamantes.", "Avareza é a lei deste covil."], missPhrases:["Mãos trêmulas de cobiça?", "O brilho te distraiu?", "Não toque no que é meu.", "Sua oferta foi rejeitada."] },
            { n:"Malakor", title:"O Feiticeiro Sombrio", file:"feiticeiro_trevas.png", color:"#2c3e50", lore:"O maior vilão da história da academia. Malakor foi o diretor mais brilhante, mas sua obsessão pela imortalidade o corrompeu. Agora ele é uma casca de poder arcano, drenando a magia da ilha para sustentar sua existência.", env:"env-malakor", phrases:["A imortalidade exige sacrifícios, aprendiz.", "Você mal compreende a magia que empunha.", "Eu reescrevi as leis da natureza.", "Sua alma servirá bem aos meus propósitos.", "O conhecimento proibido é o único poder real.", "Curve-se diante do verdadeiro Diretor.", "A morte é apenas uma porta que eu tranquei.", "Sua mana é insignificante."], missPhrases:["Estudou pouco.", "Previsível demais.", "Falta-lhe ambição.", "Sua mente é um livro aberto."] },
            { n:"Sertis", title:"A Serpente do Veneno", file:"basilisco.png", color:"#27ae60", lore:"Nos esgotos, o descarte de poções falhas criou Sertis. Esta serpente colossal sofreu mutações químicas, desenvolvendo um veneno que não apenas mata o corpo, mas corrompe a própria mana da vítima.", env:"env-sertis", phrases:["A toxina já está em suas veias...", "Sssinta a magia se dissolver...", "O pântano engole os fracos.", "Minhas presas gotejam o fim.", "Respire fundo... é seu último suspiro.", "A corrupção se espalha rápido.", "Ssssua visão está turva?", "O antídoto é a morte."], missPhrases:["O veneno te deixou lento?", "Ssscorregou?", "A tontura começou?", "Errou o alvo..."] },
            { n:"Trion", title:"A Quimera Caótica", file:"quimera.png", color:"#c0392b", lore:"Um experimento de fusão falho. Trion possui três mentes em um corpo, cada uma lutando pelo controle. O leão ruge por força, o lobo por instinto e a serpente por malícia. Seus ataques são imprevisíveis.", env:"env-trion", phrases:["Três vontades, um único predador.", "O caos da natureza em perfeita forma.", "Qual de nós te devorará primeiro?", "A quimera não conhece piedade.", "Garras, presas e veneno... escolha seu fim.", "A harmonia da destruição.", "Nós somos a legião da besta.", "Não há escapatória da tríade."], missPhrases:["Confuso com tantas cabeças?", "Qual olho você mira?", "A besta foi mais rápida.", "Tropeçou nas próprias pernas?"] },
            { n:"Gaiaos", title:"O Espírito da Terra", file:"elemental_terra.png", color:"#795548", lore:"Gaiaos é a própria ilha se levantando contra os magos. Ele sente a dor da mineração de cristais e vê a academia como um parasita. Ele representa a fúria final da natureza contra a manipulação mágica.", env:"env-gaiaos", phrases:["A ilha rejeita sua presença mágica.", "Raízes profundas esmagam pedras e ossos.", "O solo clama por vingança.", "Você é uma praga nesta terra sagrada.", "A natureza sempre retoma o que é dela.", "Sinta a fúria dos elementos primordiais.", "Cristais drenados, terra ferida... chega!", "Retorne ao ciclo da vida e morte."], missPhrases:["A terra tremeu sob você?", "Enredado nas raízes?", "O solo é instável para invasores.", "A natureza desviou seu foco."] }
        ];

        const items = [
            'Espadas-Photoroom.png', 'Escudo-Photoroom.png', 'Pocao-Photoroom.png', 'Mapa-Photoroom.png', 
            'Cristal-Photoroom.png', 'Anel-Photoroom.png', 'GemaAzul-Photoroom.png', 'Chave-Photoroom.png', 
            'Lua-Photoroom.png', 'Fenix-Photoroom.png', 'Raio-Photoroom.png', 'Olho-Photoroom.png', 
            'Teia-Photoroom.png', 'Coroa-Photoroom.png', 'Sangue-Photoroom.png', 'Balanca-Photoroom.png'
        ];
        
        // CORES DOS ITENS (GLOW PERSONALIZADO)
        const itemColors = {
            'Espadas-Photoroom.png': '#bdc3c7', // Prata
            'Escudo-Photoroom.png': '#3498db', // Azul Aço
            'Pocao-Photoroom.png': '#2ecc71', // Verde Poção
            'Mapa-Photoroom.png': '#d35400', // Laranja Mapa
            'Cristal-Photoroom.png': '#00d2ff', // Ciano Cristal
            'Anel-Photoroom.png': '#9b59b6', // Roxo Místico
            'GemaAzul-Photoroom.png': '#0000ff', // Azul Profundo
            'Chave-Photoroom.png': '#e67e22', // Bronze
            'Lua-Photoroom.png': '#ecf0f1', // Branco Lunar
            'Fenix-Photoroom.png': '#ff4500', // Vermelho Fogo
            'Raio-Photoroom.png': '#f1c40f', // Amarelo Elétrico
            'Olho-Photoroom.png': '#8e44ad', // Roxo Olho
            'Teia-Photoroom.png': '#95a5a6', // Cinza Teia
            'Coroa-Photoroom.png': '#ffd700', // Ouro Real
            'Sangue-Photoroom.png': '#8b0000', // Vermelho Sangue
            'Balanca-Photoroom.png': '#f39c12' // Dourado Justiça
        };

        // --- ASSET MANAGER (PRELOAD SYSTEM) ---
        const AssetManager = {
            images: {}, // Cache de imagens carregadas
            
            // Carrega uma imagem e armazena em memória
            loadImage(key, src) {
                return new Promise((resolve) => {
                    if (this.images[key]) return resolve(this.images[key]);
                    const img = new Image();
                    img.onload = () => {
                        this.images[key] = img;
                        resolve(img);
                    };
                    img.onerror = () => {
                        console.warn(`[AssetManager] Falha ao carregar: ${src}`);
                        resolve(null); // Resolve para não quebrar o Promise.all
                    };
                    img.src = src;
                });
            },

            // Retorna o src da imagem pré-carregada (ou string vazia se falhar)
            getSrc(key) {
                if (this.images[key]) return this.images[key].src;
                // Fallback: tenta retornar o caminho original se soubermos construir, 
                // mas idealmente tudo deve estar pré-carregado.
                console.warn(`[AssetManager] Asset não encontrado no cache: ${key}`);
                return ''; 
            },

            async init() {
                console.log("[AssetManager] Iniciando preload de assets...");
                const bgList = ['bg_glacia.jpg', 'bg_thalros.jpg', 'bg_umbra.jpg', 'bg_ferrum.jpg', 'bg_solari.jpg', 'bg_aurelius.jpg', 'bg_malakor.jpg', 'bg_sertis.jpg', 'bg_trion.jpg', 'bg_gaiaos.jpg'];
                
                const promises = [
                    // UI Básica
                    this.loadImage('capa', 'Imagens/CapaGame.jpg'),
                    this.loadImage('icone_back', 'Imagens/icone.png'),
                    // Dados do Jogo
                    ...avatares.map(a => this.loadImage(a.file, `Imagens/Personagens/${a.file}`)),
                    ...bosses.map(b => this.loadImage(b.file, `Imagens/Monstros/${b.file}`)),
                    ...items.map(i => this.loadImage(i, `Imagens/Icones/${i}`)),
                    ...bgList.map(bg => this.loadImage(bg, `Imagens/Fundos/${bg}`)) // Cache para CSS
                ];
                await Promise.all(promises);
                console.log("[AssetManager] Preload concluído.");
            }
        };

        // BASE DE DADOS EXPANDIDA (50 PERGUNTAS)
        const triviaDB = [
            // Geral & Alquimia
            {p:"Qual destes não é um elemento clássico?", o:["Fogo","Vento","Metal"], r:2},
            {p:"O que alquimistas buscavam?", o:["Pedra Filosofal","Ouro Líquido","Vida Eterna"], r:0},
            {p:"Qual metal é tóxico para fadas?", o:["Ouro","Ferro Frio","Prata"], r:1},
            {p:"O que é um Grimório?", o:["Livro de Receitas","Livro Mágico","Diário"], r:1},
            {p:"Qual a forma de um círculo mágico?", o:["Quadrado","Triangular","Redondo"], r:2},
            {p:"O que é Mana?", o:["Energia Mágica","Moeda","Comida"], r:0},
            {p:"Qual joia armazena mais magia?", o:["Diamante","Cristal","Carvão"], r:1},
            {p:"Transmutação altera o quê?", o:["A Forma","O Tempo","A Alma"], r:0},
            {p:"Qual destes é um ingrediente de poção?", o:["Raiz de Mandrágora","Pedra de Calçada","Vidro"], r:0},
            {p:"Onde poções são preparadas?", o:["Forno","Caldeirão","Frasco"], r:1},

            // Criaturas
            {p:"Qual criatura renasce das cinzas?", o:["Dragão","Fênix","Grifo"], r:1},
            {p:"Qual criatura petrifica com o olhar?", o:["Basilisco","Medusa","Górgona"], r:0},
            {p:"O que o Lobisomem teme?", o:["Prata","Alho","Luz"], r:0},
            {p:"Qual criatura guarda tesouros?", o:["Duende","Dragão","Sereia"], r:1},
            {p:"O que é um Centauro?", o:["Meio Homem Meio Cavalo","Meio Peixe","Meio Bode"], r:0},
            {p:"Qual criatura canta para atrair marinheiros?", o:["Harpia","Sereia","Banshee"], r:1},
            {p:"O que é um Golem?", o:["Ser Artificial","Fantasma","Demônio"], r:0},
            {p:"Qual criatura chupa sangue?", o:["Zumbi","Vampiro","Múmia"], r:1},
            {p:"O que é um Grifo?", o:["Leão e Águia","Lobo e Urso","Cobra e Pássaro"], r:0},
            {p:"Qual criatura vive em vulcões?", o:["Salamandra","Yeti","Kraken"], r:0},

            // Ferramentas & Magia
            {p:"Qual destes é uma ferramenta de adivinhação?", o:["Bola de Cristal","Varinha","Caldeirão"], r:0},
            {p:"O que bruxas usam para voar?", o:["Tapetes","Vassouras","Arbustos"], r:1},
            {p:"Qual é o símbolo da realeza?", o:["Coroa","Cetro","Anel"], r:0},
            {p:"Necromancia lida com o quê?", o:["Vida","Mortos","Plantas"], r:1},
            {p:"Piromancia controla o quê?", o:["Gelo","Fogo","Raio"], r:1},
            {p:"O que faz uma Varinha?", o:["Canaliza Magia","Gera Ouro","Corta Pedra"], r:0},
            {p:"Qual carta prevê a morte?", o:["O Louco","A Torre","A Morte"], r:2},
            {p:"O que são Runas?", o:["Alfabeto Mágico","Pedras","Moedas"], r:0},
            {p:"Qual poção cura feridas?", o:["Veneno","Elixir de Vida","Poção de Cura"], r:2},
            {p:"O que reflete feitiços?", o:["Espelho Mágico","Escudo de Madeira","Água"], r:0},

            // Lore do Jogo (Bosses)
            {p:"Quem é a Sentinela do Inverno?", o:["Glacia","Sertis","Umbra"], r:0},
            {p:"De que é feito Thalros?", o:["Carne","Pedra","Ferro"], r:1},
            {p:"Onde vive Sertis?", o:["Torre","Esgotos","Floresta"], r:1},
            {p:"Qual o pecado de Aurelius?", o:["Ira","Ganância","Preguiça"], r:1},
            {p:"Quantas cabeças tem Trion?", o:["Uma","Duas","Três"], r:2},
            {p:"Quem foi o diretor corrompido?", o:["Malakor","Merlin","Gandalf"], r:0},
            {p:"O que Ferrum guarda?", o:["O Portão","O Tesouro","A Biblioteca"], r:0},
            {p:"Qual elemento de Solari?", o:["Gelo","Fogo","Sombra"], r:1},
            {p:"O que Umbra representa?", o:["Medo","Coragem","Sabedoria"], r:0},
            {p:"Gaiaos é o espírito de quê?", o:["Ar","Terra","Água"], r:1},
            // Lore Expandida
            {p:"O que Glacia protege com fervor?", o:["Pico de Cristal","Floresta Negra","O Portão"], r:0},
            {p:"Qual era a função original de Glacia?", o:["Guerreira","Trazer Orvalho","Cozinheira"], r:1},
            {p:"O que cobre as escrituras de Thalros?", o:["Ouro","Sangue","Musgo"], r:2},
            {p:"Thalros é uma biblioteca viva de quê?", o:["Feitiços de Fogo","Runas de Proteção","História Antiga"], r:1},
            {p:"Do que Umbra se alimenta?", o:["Carne","Medo e Hesitação","Luz"], r:1},
            {p:"Onde Umbra costuma habitar?", o:["Corredores Proibidos","Jardim","Telhado"], r:0},
            {p:"O que move o Golem Ferrum?", o:["Vapor","Eletricidade","Feitiço de Sangue"], r:2},
            {p:"Quando Solari costuma aparecer?", o:["À Noite","Na Chuva","Instabilidade Mágica"], r:2},
            {p:"O que se fundiu às escamas de Aurelius?", o:["Ferro","Ouro da Toca","Diamantes"], r:1},
            {p:"O que Malakor busca obsessivamente?", o:["Paz","Imortalidade","Riqueza"], r:1},
            {p:"O que criou a serpente Sertis?", o:["Magia Negra","Descarte de Poções","Um Dragão"], r:1},
            {p:"O veneno de Sertis corrompe o quê?", o:["A Mana","A Armadura","A Espada"], r:0},
            {p:"Quais animais formam Trion?", o:["Leão, Lobo, Serpente","Águia, Touro, Urso","Gato, Cão, Rato"], r:0},
            {p:"O que as mentes de Trion disputam?", o:["Comida","Controle","Sono"], r:1},
            {p:"O que Gaiaos considera os magos?", o:["Aliados","Deuses","Parasitas"], r:2},
            {p:"O que causa dor a Gaiaos?", o:["Chuva","Vento","Mineração de Cristais"], r:2},

            // Mecânicas do Jogo
            {p:"Qual a cor da magia do caos neste jogo?", o:["Azul","Roxo","Verde"], r:1},
            {p:"Quantos segundos tem a fase?", o:["50","60","90"], r:1},
            {p:"O que acontece se o tempo acabar?", o:["Game Over","Quiz","Nada"], r:1},
            {p:"Qual item dá XP extra?", o:["Lágrima de Fênix","Ouro","Carta"], r:0},
            {p:"Quantas cartas tem no tabuleiro?", o:["12","16","20"], r:1},
            {p:"Qual o nome da Academia?", o:["Arcane Academy","Hogwarts","Luna Nova"], r:0},
            {p:"O que o modo Fúria faz?", o:["Triplica Pontos","Para o Tempo","Mata Boss"], r:0},
            {p:"O que quebra seu combo?", o:["Errar Par","Acertar Par","Nada"], r:0},
            {p:"Qual nível libera skins de Diamante?", o:["10","20","40"], r:2},
            {p:"Qual boss é um Dragão?", o:["Aurelius","Solari","Trion"], r:0}
        ];

        // 50 Achievements (Resumidos para caber, lógica mantida)
        const achievementsDB = [
            {id:'win_1',icon:'✨',title:'Iniciado',desc:'Vença a Fase 1.'}, {id:'win_5',icon:'🔥',title:'Intermediário',desc:'Vença a Fase 5.'}, {id:'win_10',icon:'👑',title:'O Fim do Início',desc:'Complete o Modo História.'},
            {id:'lvl_5',icon:'📜',title:'Estudante',desc:'Alcance Nível 5.'}, {id:'lvl_10',icon:'📘',title:'Adepto',desc:'Alcance Nível 10.'}, {id:'lvl_25',icon:'🧙‍♂️',title:'Mago',desc:'Alcance Nível 25.'}, {id:'lvl_50',icon:'🔮',title:'Arquimago',desc:'Alcance Nível 50.'}, {id:'lvl_100',icon:'🌟',title:'Lenda',desc:'Alcance Nível 100.'},
            {id:'combo_3',icon:'⚡',title:'Rápido',desc:'Combo 3x.'}, {id:'combo_5',icon:'🌩️',title:'Relâmpago',desc:'Combo 5x.'}, {id:'combo_10',icon:'🔥',title:'Imparável',desc:'Combo 10x.'}, {id:'score_1k',icon:'💎',title:'Tesouro',desc:'1k pts.'}, {id:'score_5k',icon:'👑',title:'Magnata',desc:'5k pts.'},
            {id:'kill_glacia',icon:'❄️',title:'Quebra-Gelo',desc:'Derrote Glacia.'}, {id:'kill_thalros',icon:'🪨',title:'Demolidor',desc:'Derrote Thalros.'}, {id:'kill_umbra',icon:'🌑',title:'Iluminado',desc:'Derrote Umbra.'}, {id:'kill_ferrum',icon:'⚙️',title:'Ferrugem',desc:'Derrote Ferrum.'}, {id:'kill_solari',icon:'☀️',title:'Extintor',desc:'Derrote Solari.'},
            {id:'kill_aurelius',icon:'🐉',title:'Matador',desc:'Derrote Aurelius.'}, {id:'kill_malakor',icon:'☠️',title:'Justiça',desc:'Derrote Malakor.'}, {id:'kill_sertis',icon:'🐍',title:'Antídoto',desc:'Derrote Sertis.'}, {id:'kill_trion',icon:'🦁',title:'Domador',desc:'Derrote Trion.'}, {id:'kill_gaiaos',icon:'🌍',title:'Terra',desc:'Derrote Gaiaos.'},
            {id:'quiz_win',icon:'🧠',title:'Sábio',desc:'Acerte Quiz.'}, {id:'chaos_survivor',icon:'🌀',title:'Ordem',desc:'Vença no Caos.'}, {id:'low_hp',icon:'❤️‍🩹',title:'Fio',desc:'Vença com 1 HP.'}, {id:'speedster',icon:'👟',title:'Ligeiro',desc:'Vença < 25s.'}, {id:'veteran_10',icon:'🎖️',title:'Veterano I',desc:'10 Jogos.'}, {id:'veteran_50',icon:'🏅',title:'Veterano II',desc:'50 Jogos.'},
            {id:'infinite_15',icon:'♾️',title:'Eterno',desc:'Fase 15 Infinito.'}, {id:'completionist',icon:'📖',title:'Historiador',desc:'Grimório Completo.'}, {id:'collector',icon:'🃏',title:'Colecionador',desc:'Todas Skins.'}, {id:'fashion',icon:'🧙‍♀️',title:'Estiloso',desc:'Todos Avatares.'}
        ];

        // --- 2. GERENCIAMENTO DE ÁUDIO ---
        const sfx = { flip:new Audio('Sons/flip.mp3'), match:new Audio('Sons/match.mp3'), win:new Audio('Sons/win.mp3'), click:new Audio('Sons/click.mp3'), chaos:new Audio('Sons/chaos.mp3'), swear:new Audio('Sons/raio.mp3'), achievement:new Audio('Sons/win.mp3'), alohomora:new Audio('Sons/alohomora.mp3'), combo:new Audio('Sons/combo.mp3'), expelliarmus:new Audio('Sons/expelliarmus.mp3'), thunder:new Audio('Sons/raio.mp3'), owl:new Audio('Sons/owl.mp3'), paper:new Audio('Sons/paper.mp3'), teleport:new Audio('Sons/teleport.mp3'), bookOpen:new Audio('Sons/paper.mp3') };
        class AudioManager { 
            constructor(){this.bgMusic=null;this.gameMusic=null;this.ambMenu=null;}
            init(){this.bgMusic=document.getElementById('ost-menu');this.gameMusic=document.getElementById('ost-game');this.ambMenu=document.getElementById('amb-menu');this.bgMusic.volume=0.2;this.gameMusic.volume=0.2;if(this.ambMenu)this.ambMenu.volume=0.3;}
            playMenu(){if(this.gameMusic)this.gameMusic.pause();if(this.bgMusic){this.bgMusic.currentTime=0;this.bgMusic.play().catch(()=>{});}if(this.ambMenu){this.ambMenu.currentTime=0;this.ambMenu.play().catch(()=>{});}} 
            playGame(){if(this.bgMusic)this.bgMusic.pause();if(this.ambMenu)this.ambMenu.pause();if(this.gameMusic){this.gameMusic.currentTime=0;this.gameMusic.play().catch(()=>{});}} 
            stopAll(){if(this.bgMusic)this.bgMusic.pause();if(this.gameMusic)this.gameMusic.pause();if(this.ambMenu)this.ambMenu.pause();} 
            updateVolume(){if(this.bgMusic)this.bgMusic.volume=cfg.m;if(this.gameMusic)this.gameMusic.volume=cfg.m;if(this.ambMenu)this.ambMenu.volume=cfg.s*0.6;} 
        } 
        const audioManager = new AudioManager();

        // --- 3. ESTADO GLOBAL ---
        let currentSlotPrefix = "";
        const DB = {
            getItem: (k) => { if(k==='aa_cfg') return localStorage.getItem(k); return localStorage.getItem(currentSlotPrefix + k); },
            setItem: (k,v) => { if(k==='aa_cfg') return localStorage.setItem(k,v); return localStorage.setItem(currentSlotPrefix + k, v); },
            removeItem: (k) => { if(k==='aa_cfg') return localStorage.removeItem(k); return localStorage.removeItem(currentSlotPrefix + k); }
        };

        let globalData = null;
        let prof = null;
        let justUnlockedGrimoire = false;
        let pendingDeleteId = null;

        function initProfileData() {
            globalData = JSON.parse(DB.getItem('aa_global')) || { achievements: [], infiniteHighScores: [] };
            prof = JSON.parse(DB.getItem('aa_prof')) || { nome: "Aprendiz", av: 0, lvl: 1, xp: 0, maxScore: 0, totalGames: 0, quizStreak: 0, grimoireUnlocked: false, ngPlusUnlocked: false, infiniteUnlocked: false, wins: 0, bossKills: {}, playTime: 0 };
            if(typeof prof.frame === 'undefined') prof.frame = 0;
            if(typeof prof.wins === 'undefined') prof.wins = 0;
            if(typeof prof.bossKills === 'undefined') prof.bossKills = {};
            if(typeof prof.playTime === 'undefined') prof.playTime = 0;
            if(typeof prof.levelRecords === 'undefined') prof.levelRecords = {};
            if(!globalData.achievements) globalData.achievements = [];
        }

        let cfg = JSON.parse(localStorage.getItem('aa_cfg')) || { m: CONFIG_DEFAULTS.MUSIC_VOL, s: CONFIG_DEFAULTS.SFX_VOL, part: CONFIG_DEFAULTS.PARTICLES };
        let game = { fase: 1, score: 0, infiniteMode: false, chaosActive: false, ngPlus: false };
        
        let cartas=[], pares=0, total=0, travado=false, hp=0, hpMax=0, combo=0, missCombo=0, tempo=0, timer=null, chaosTimer=null, tauntTimer=null, lastScreen='screen-menu', currentBossIndex=0;
        let lastMatch = 0, currentBookPage = 0, bleedInterval = null, chaosInternalTimer = null, speechHideTimer = null, typewriterTimer = null;
    

        // --- 4. INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            UI.init();
            audioManager.init();
            initWeatherSystem(); 
            initProfileData();
            updateProfUI(); 
            applySettings(); 
            checkSave();
            checkAchievements('startup');
            initAudioVisualizer();
            AssetManager.init(); // Inicia o preload em background enquanto a intro roda
            
            const vid = document.getElementById('intro-video'); vid.muted=true; vid.loop=true; vid.play().catch(()=>{});
            gsap.to("#start-btn-intro", { opacity: 1, duration: 1, delay: 0.5 });
            document.addEventListener("mousemove", (e) => {
                // Menu Particles
                if(document.getElementById('screen-menu').style.display !== 'none' && cfg.part) {
                    createMenuParticle(e.clientX, e.clientY);
                }
            });
        });

        function initSlots() {
            const c = document.getElementById('slots-list'); c.innerHTML = '';
            for(let i=1; i<=3; i++) {
                const pKey = `slot_${i}_aa_prof`;
                const pData = JSON.parse(localStorage.getItem(pKey));
                let html = '';
                if(pData) {
                    const av = avatares[pData.av] || avatares[0];
                    html = `<div class="btn-delete-slot" onclick="event.stopPropagation(); deleteSlot(${i})">✖</div>
                            <img src="${AssetManager.getSrc(av.file)}" class="slot-avatar" style="border-color:${av.color}; width:80px; height:80px;">
                            <div class="slot-info"><div class="slot-name">${pData.nome}</div><div>Nível ${pData.lvl}</div></div>`;
                } else {
                    html = `<div class="slot-avatar" style="background:#111; display:flex; align-items:center; justify-content:center; font-size:2rem; color:#333;">+</div>
                            <div class="slot-info"><div class="slot-name" style="color:#666;">Novo Jogo</div><div>Slot ${i}</div></div>`;
                }
                const div = document.createElement('div'); div.className = 'slot-card'; div.id = `slot-card-${i}`; div.innerHTML = html;
                div.onclick = () => loadSlot(i); c.appendChild(div);
            }
            
            // Animação de Entrada (Stagger)
            gsap.fromTo(".slot-card", 
                { y: 50, opacity: 0, scale: 0.8 }, 
                { y: 0, opacity: 1, scale: 1, duration: 0.6, stagger: 0.15, ease: "back.out(1.5)", delay: 0.1, clearProps: "transform,opacity,scale" }
            );
        }

        function deleteSlot(i) {
            pendingDeleteId = i;
            playS('click');
            document.getElementById('modal-delete-confirm').style.display = 'flex';
        }

        function closeDeleteModal() { document.getElementById('modal-delete-confirm').style.display = 'none'; pendingDeleteId = null; }

        function executeDeleteSlot() {
            const i = pendingDeleteId;
            closeDeleteModal();
            if (i === null) return;

            const el = document.getElementById(`slot-card-${i}`);
            if(el) {
                playS('chaos'); // Som de destruição
                
                // Efeito de Partículas (Desintegração)
                const rect = el.getBoundingClientRect();
                for(let j=0; j<40; j++) {
                    const p = document.createElement('div');
                    p.style.cssText = `position:fixed; left:${rect.left + Math.random() * rect.width}px; top:${rect.top + Math.random() * rect.height}px; width:${Math.random()*5+2}px; height:${Math.random()*5+2}px; background:#555; border-radius:50%; z-index:30001; pointer-events:none;`;
                    document.body.appendChild(p);
                    gsap.to(p, { x: (Math.random()-0.5)*150, y: (Math.random()-0.5)*150, opacity: 0, scale: 0, duration: 0.6 + Math.random()*0.4, ease: "power2.out", onComplete: () => p.remove() });
                }

                // Animação do Card
                gsap.to(el, {
                    scale: 0.9, opacity: 0, filter: "grayscale(1) blur(10px)", duration: 0.5, ease: "power2.in",
                    onComplete: () => {
                        localStorage.removeItem(`slot_${i}_aa_prof`); localStorage.removeItem(`slot_${i}_aa_save`); localStorage.removeItem(`slot_${i}_aa_global`); initSlots();
                    }
                });
            } else {
                localStorage.removeItem(`slot_${i}_aa_prof`); localStorage.removeItem(`slot_${i}_aa_save`); localStorage.removeItem(`slot_${i}_aa_global`); initSlots();
            }
        }

        function loadSlot(i) {
            playS('click');
            const fade = document.getElementById('fade-layer');
            fade.style.zIndex = 40000; // Garante prioridade sobre a tela de slots
            fade.classList.add('fade-active');

            setTimeout(() => {
                currentSlotPrefix = `slot_${i}_`;
                initProfileData();
                checkSave(); checkAchievements('startup');
                document.getElementById('screen-slots').style.display = 'none';
                
                if(prof.nome === "Aprendiz") {
                    changeUIState(UI_STATES.PROFILE_CREATE);
                } else {
                    changeUIState(UI_STATES.PROFILE_VIEW);
                }
                
                setTimeout(() => {
                    fade.classList.remove('fade-active');
                    setTimeout(() => { fade.style.zIndex = ''; }, 800);
                }, 200);
            }, 800);
        }

        // --- 5. NAVEGAÇÃO E FLUXO ---
        function playIntroSound() { const vid=document.getElementById('intro-video'); vid.muted=false; vid.loop=false; vid.currentTime=0; vid.play(); document.getElementById('start-btn-intro').style.display='none'; document.getElementById('skip-text').style.display='block'; vid.onended=endIntro; }
        function endIntro() { document.getElementById('intro-video').pause(); gsap.to('#screen-intro', {opacity:0, duration:1, onComplete:()=>{ document.getElementById('screen-intro').style.display='none'; changeUIState(UI_STATES.MAIN_MENU); audioManager.playMenu(); }}); }
        
        function novoJogo(isNgPlus = false) { if(prof.nome==="Aprendiz"){notificar("Configure seu perfil!");abrirPerfilMenu();return;} DB.removeItem('aa_save'); game={fase:1,score:0,infiniteMode:false,chaosActive:false, ngPlus: isNgPlus}; prof.totalGames++; DB.setItem('aa_prof',JSON.stringify(prof)); checkAchievements('game_start'); audioManager.playGame(); transitionFase(1); }
        function iniciarNewGamePlus() { playS('click'); document.getElementById('modal-ngplus').style.display = 'flex'; }
        function confirmNewGamePlus() { document.getElementById('modal-ngplus').style.display = 'none'; novoJogo(true); }
        function continuarJogo() { const s=JSON.parse(DB.getItem('aa_save')); if(s){game=s;audioManager.playGame();transitionFase(game.fase);} }

        function transitionFase(f) {
            playS('teleport');
            playPortalEffect(() => {
                UI.screens.menu.style.display = 'none'; changeUIState(UI_STATES.GAME); 
                try { carregarFase(f); } catch(e) { console.error(e); sairParaMenu(); }
            });
        }

        function carregarFase(f) {
            game.fase = f; UI.hud.fase.innerText = f; UI.hud.score.innerText = game.score; UI.board.innerHTML = '';
            let bIdx = (f-1)%bosses.length; if(game.infiniteMode) bIdx = Math.floor(Math.random()*bosses.length); currentBossIndex = bIdx; const b = bosses[bIdx];
            document.getElementById('boss-img-tag').src = AssetManager.getSrc(b.file); document.getElementById('boss-n').innerText = b.n; document.getElementById('boss-n').style.textShadow = "0 0 20px " + b.color; document.getElementById('dynamic-bg-layer').className = b.env;
            
            let n = 16;
            if (game.ngPlus) n = 24;
            if (game.infiniteMode) { n = 16; if(f > 5) n = 20; if(f > 10) n = 24; } // Dificuldade Progressiva no Infinito
            
            const p=n/2; hpMax=p; hp=p; updateHP(); total=p; pares=0; cartas=[]; travado=false; combo=0; missCombo=0;
            clearInterval(bleedInterval); // Limpa sangramento anterior
            
            let gridClass = 'grid-4'; if(n===20) gridClass='grid-5'; if(n===24) gridClass='grid-6';
            const rewards = getRewards(prof.lvl);
            UI.board.className = `card-grid ${gridClass} ${rewards.cardSkin}`;
            game.startTime = Date.now();
            
            let deck = items.slice(0, p); deck = [...deck, ...deck].sort(()=>Math.random()-0.5);
            deck.forEach(icon => {
                const wrapper = document.createElement('div'); wrapper.className = 'card-wrapper';
                const c = document.createElement('div'); c.className = 'card'; 
                c.dataset.icon = icon; 
                c.innerHTML = `<div class="face front"><img src="${AssetManager.getSrc(icon)}" alt="Item"></div><div class="face back"></div>`;
                c.onclick = () => cardClick(c); 
                wrapper.appendChild(c);
                UI.board.appendChild(wrapper);
            });
            clearInterval(timer); startTimer(game.ngPlus ? 45 : 60); // NG+ tem 45s
            scheduleNextChaos(); scheduleTaunt(); if(!game.infiniteMode) DB.setItem('aa_save', JSON.stringify(game));
        }

        function cardClick(c) {
            const val = c.dataset.icon; // FIX: Ler do dataset para garantir sincronia com o Caos
            if(travado || game.chaosActive || c.classList.contains('flipped')) return;
            
            playS('flip');
            // Eleva a carta visualmente durante o giro
            c.parentElement.style.zIndex = "100";
            c.classList.add('flipped'); cartas.push({el:c, v:val});
            
            gsap.to(c, {rotateY: 180, duration: 0.5, ease: "back.out(1.5)"});
            
            if(cartas.length === 2) {
                travado = true; const [c1, c2] = cartas;
                if(c1.v === c2.v) {
                    playS('match'); c1.el.classList.add('matched'); c2.el.classList.add('matched'); pares++; hp--; updateHP(); missCombo=0;
                    
                    // APLICA GLOW ESPECÍFICO
                    const glowColor = itemColors[c1.v] || '#c5a028';
                    [c1.el, c2.el].forEach(card => {
                        const front = card.querySelector('.front');
                        front.style.borderColor = glowColor;
                        front.style.boxShadow = `0 0 30px ${glowColor}`;
                    });

                    // DISPARA PROJÉTIL ARCANO NO BOSS
                    triggerArcaneShot(c1.el);
                    setTimeout(() => triggerArcaneShot(c2.el), 150); // Pequeno delay para o segundo tiro

                    const now = Date.now(); if(now-lastMatch < 3000) { combo++; showCombo(combo); } else { combo=1; } lastMatch = now;
                    
                    // FURY SYSTEM
                    let isFury = combo >= 3;
                    if(isFury) {
                        UI.board.classList.add('fury-active');
                        if(combo === 5) notificar("FÚRIA ARCANA ATIVADA!");
                    }

                    // Boss Shake & Flash FX
                    gsap.fromTo(".boss-hp-bg", {x:-5}, {x:5, duration:0.05, repeat:5, yoyo:true, clearProps:"x"});
                    gsap.fromTo("#hp-bar", {filter:"brightness(2)"}, {filter:"brightness(1)", duration:0.3, clearProps:"filter"});

                    let pts = Math.floor(100*combo); 
                    if(isFury) pts *= 3; // Triplo de pontos na Fúria
                    
                    game.score+=pts; document.getElementById('ui-score').innerText=game.score; showFloatScore(c1.el, pts);
                    if(cfg.part) createMagicBurst(c1.el.getBoundingClientRect().left, c1.el.getBoundingClientRect().top);
                    cartas=[]; travado=false;
                    if(pares === total) { clearInterval(timer); document.getElementById('time-warning-layer').classList.remove('active'); clearTimeout(chaosTimer); clearTimeout(tauntTimer); setTimeout(() => { playS('win'); finishStage(); }, 1000); }
                } else {
                    if(combo >= 2) triggerComboBreaker(); // Só ativa se realmente quebrar um combo (sequência >= 2)
                    combo=0; 
                    missCombo++;
                    if(missCombo >= 3) { triggerBossReaction('miss'); missCombo = 0; }

                    UI.board.classList.remove('fury-active');
                    setTimeout(()=>{
                        gsap.to([c1.el, c2.el], {
                            rotateY: 0, duration: 0.4, ease: "power2.inOut",
                            onComplete: () => { c1.el.parentElement.style.zIndex = ""; c2.el.parentElement.style.zIndex = ""; }
                        });
                        c1.el.classList.remove('flipped'); c2.el.classList.remove('flipped'); cartas=[]; travado=false;
                    }, 1000);
                }
            }
        }

        function finishStage() {
            if(game.startTime) {
                const timeSpent = (Date.now() - game.startTime) / 1000;
                if(!prof.levelRecords) prof.levelRecords = {};
                if(!prof.levelRecords[game.fase] || timeSpent < prof.levelRecords[game.fase]) {
                    prof.levelRecords[game.fase] = timeSpent;
                }
            }
            const xpGained = 100 + (game.score/10); prof.xp += xpGained;
            let msg = `Vitória! +${Math.floor(xpGained)} XP.`;
            if(game.score > prof.maxScore) prof.maxScore = game.score;
            
            const bName = bosses[currentBossIndex].n; prof.bossKills[bName] = (prof.bossKills[bName] || 0) + 1;
            
            // Limpeza de intervalos (Sangramento, etc)
            clearInterval(bleedInterval);

            // 2° ZERAMENTO DO JOGO (Fase 10 - Gaiaos)
            if(game.fase >= 10 && !game.infiniteMode) {
                prof.xp += 2000; // Bônus de Zeramento
                if(prof.xp >= prof.lvl*100 && prof.lvl < 100) { prof.xp=0; prof.lvl++; checkAchievements('levelup'); }
                DB.setItem('aa_prof', JSON.stringify(prof));
                updateProfUI();
                completeGame();
                return;
            }

            if(prof.xp >= prof.lvl*100 && prof.lvl < 100) { prof.xp=0; prof.lvl++; msg = `LEVEL UP! Nível ${prof.lvl}!`; checkAchievements('levelup'); triggerLevelUpFX(); }
            DB.setItem('aa_prof', JSON.stringify(prof)); updateProfUI();
            
            notificar(msg);
            playS('win');
            
            setTimeout(() => {
                transitionFase(game.fase+1);
            }, 3000);
        }

        function completeGame() {
            playS('win');
            prof.wins = (prof.wins || 0) + 1;
            
            // Desbloqueia Grimório
            if(!prof.grimoireUnlocked) {
                prof.grimoireUnlocked = true;
                prof.ngPlusUnlocked = true; // Desbloqueia NG+
                prof.infiniteUnlocked = true; // Desbloqueia Infinito
                DB.setItem('aa_prof', JSON.stringify(prof));
                notificar("GRIMÓRIO DESBLOQUEADO!");
                justUnlockedGrimoire = true; // Flag para animação
            } else {
                notificar("A JORNADA ESTÁ COMPLETA!");
            }
            
            // 1° MECANISMO DE SAVE: Limpa o save da run atual pois o jogo foi concluído
            DB.removeItem('aa_save');
            checkSave();

            // Transição para o Grimório (Tela Final)
            toggleGrimoireWithMist('open', true);
        }

        function openInfiniteMenu() {
            const list = document.getElementById('infinite-ranking-list'); list.innerHTML = '';
            const scores = globalData.infiniteHighScores.sort((a,b) => b.score - a.score).slice(0, 10);
            if(scores.length === 0) list.innerHTML = `<div style="text-align:center; color:#666; font-style:italic;">Nenhum registro encontrado.</div>`;
            else scores.forEach((s, i) => {
                const color = i === 0 ? '#ffd700' : (i === 1 ? '#c0c0c0' : (i === 2 ? '#cd7f32' : '#aaa'));
                list.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:1.1rem;"><span style="color:${color}; font-weight:bold;">#${i+1} ${s.name}</span><span style="font-family:'Cinzel';">${s.score} pts (Fase ${s.fase})</span></div>`;
            });
            document.getElementById('modal-infinite').style.display = 'flex';
        }

        function startInfiniteRun() {
            document.getElementById('modal-infinite').style.display = 'none'; DB.removeItem('aa_save');
            game = { fase: 1, score: 0, infiniteMode: true, chaosActive: false, ngPlus: false };
            prof.totalGames++; DB.setItem('aa_prof', JSON.stringify(prof));
            audioManager.playGame(); transitionFase(1);
        }

        function gameOverInfinite() {
            playS('chaos'); // Som do Vazio
            const bh = document.getElementById('black-hole');
            const allCards = Array.from(document.querySelectorAll('.card-wrapper'));
            
            gsap.to(bh, { opacity: 1, scale: 2.5, duration: 1.5, ease: "power2.out" });
            allCards.forEach(w => {
                const rect = w.getBoundingClientRect();
                const dx = (window.innerWidth/2) - (rect.left + rect.width/2);
                const dy = (window.innerHeight/2) - (rect.top + rect.height/2);
                gsap.to(w, { x: dx, y: dy, scale: 0, rotation: 1080, opacity: 0, duration: 1.2, ease: "power4.in", delay: Math.random()*0.3 });
            });

            setTimeout(() => {
                const entry = { name: prof.nome, score: game.score, fase: game.fase, date: new Date().toLocaleDateString() };
                globalData.infiniteHighScores.push(entry); DB.setItem('aa_global', JSON.stringify(globalData));
                notificar("O Vazio consumiu tudo...");
                gsap.to(bh, { scale: 0, opacity: 0, duration: 0.5, delay: 0.5 });
                setTimeout(() => { sairParaMenu(); setTimeout(() => openInfiniteMenu(), 500); }, 2000);
            }, 2000);
        }

        // --- 6. MECÂNICAS E UTILITÁRIOS ---
        function startTimer(t) { 
            tempo=t; UI.hud.tempo.innerText=tempo; 
            document.getElementById('time-warning-layer').classList.remove('active');
            timer=setInterval(()=>{
                tempo--; UI.hud.tempo.innerText=tempo;
                prof.playTime = (prof.playTime || 0) + 1;
                if(tempo<=10) document.getElementById('time-warning-layer').classList.add('active');
                if(tempo<=0){ clearInterval(timer); document.getElementById('time-warning-layer').classList.remove('active'); quiz("Tempo Esgotado!"); }
            },1000); 
        }
        function updateHP() { 
            const pct = hp/hpMax;
            document.getElementById('hp-bar').style.width = (pct*100)+'%'; 
            
            // Sistema de Sangramento (Low HP)
            if(pct <= 0.3 && pct > 0) {
                if(!bleedInterval) bleedInterval = setInterval(spawnBossBleed, 200);
            } else {
                clearInterval(bleedInterval); bleedInterval = null;
            }
        }
        
        // Intervalo de Caos ajustado para 15s - 30s (Mais frequente)
        function scheduleNextChaos() { clearTimeout(chaosTimer); const time = Math.random()*(30000-15000)+15000; chaosTimer = setTimeout(() => { triggerChaosShuffle(); scheduleNextChaos(); }, time); }
        function triggerChaosShuffle() {
            const validCards = Array.from(document.querySelectorAll('.card:not(.flipped):not(.matched)')); if(validCards.length<2) return;
            const wrappers = validCards.map(c => c.parentElement);
            game.chaosActive = true; playS('chaos'); notificar("O Vazio embaralha o destino...");
            validCards.forEach(c => c.classList.add('chaos-glow'));
            
            const bh = document.getElementById('black-hole');
            gsap.to(bh, { opacity: 1, scale: 1.5, duration: 0.5, ease: "back.out" });

            wrappers.forEach(w => {
                const rect = w.getBoundingClientRect();
                const dx = (window.innerWidth/2) - (rect.left + rect.width/2);
                const dy = (window.innerHeight/2) - (rect.top + rect.height/2);
                gsap.to(w, { x: dx, y: dy, scale: 0, rotation: 720, opacity: 0, duration: 0.8, ease: "power2.in", delay: Math.random()*0.1 });
            });

            chaosInternalTimer = setTimeout(() => {
                const icons = validCards.map(c => c.dataset.icon).sort(() => Math.random() - 0.5);
                validCards.forEach((c, i) => { c.dataset.icon = icons[i]; c.querySelector('.front').innerHTML = `<img src="${AssetManager.getSrc(icons[i])}" alt="Item">`; });
                
                gsap.to(wrappers, { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1, duration: 0.6, ease: "back.out(1.2)", stagger: 0.02, clearProps:"all", onComplete: () => { 
                    validCards.forEach(c => c.classList.remove('chaos-glow')); game.chaosActive = false; 
                    gsap.to(bh, { opacity: 0, scale: 0, duration: 0.5 });
                }});
            }, 1000);
        }

        function quiz(msg) { 
            clearInterval(timer); document.getElementById('time-warning-layer').classList.remove('active'); 
            
            // HOTFIX: Parar Mecânicas de Caos e Resetar Visual
            clearTimeout(chaosTimer); clearTimeout(tauntTimer); clearTimeout(chaosInternalTimer);
            gsap.killTweensOf(".card-wrapper"); gsap.killTweensOf(".card"); gsap.killTweensOf("#black-hole");
            
            // Reseta o tabuleiro para estado limpo
            gsap.set(".card-wrapper", { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1, clearProps: "all" });
            gsap.set("#black-hole", { scale: 0, opacity: 0 });
            document.querySelectorAll('.chaos-glow').forEach(c => c.classList.remove('chaos-glow'));
            game.chaosActive = false;

            const m=document.getElementById('modal-quiz'); 
            const p=document.getElementById('quiz-paper'); 
            
            // Efeito Visual de Streak Alto (Brilho Dourado)
            if(prof.quizStreak >= 3) p.classList.add('streak-glow');
            else p.classList.remove('streak-glow');

            const q=triviaDB[Math.floor(Math.random()*triviaDB.length)]; 
            document.getElementById('quiz-q').innerText=q.p; 
            const c=document.getElementById('quiz-ops'); c.innerHTML=''; 
            q.o.forEach((op, i)=>{ const d=document.createElement('button'); d.className='quiz-opt-btn'; d.innerText=op; d.onclick=()=>{playS('click');if(i===q.r)quizSuccess();else quizFail();}; c.appendChild(d); }); 
            m.style.display='flex'; playS('paper'); 
            gsap.fromTo(p, {scale:0, rotation:-720, opacity:0}, {scale:1, rotation:0, opacity:1, duration:1, ease:"back.out"}); 
        }
        function quizSuccess() { 
            document.getElementById('modal-quiz').style.display='none'; 
            
            // Sistema de Streak (3 acertos = Item Raro)
            prof.quizStreak = (prof.quizStreak || 0) + 1;
            if(prof.quizStreak % 3 === 0) {
                notificar("Streak x3! Item Raro: Lágrima de Fênix (+500 XP)");
                prof.xp += 500; playS('achievement');
            }
            
            finishStage();
        }
        function quizFail() { 
            if(game.infiniteMode) {
                document.getElementById('modal-quiz').style.display='none';
                gameOverInfinite();
                return;
            }
            prof.quizStreak = 0; DB.setItem('aa_prof', JSON.stringify(prof));
            playS('thunder'); 
            document.getElementById('modal-quiz').style.display='none'; 
            gsap.fromTo("#fx-overlay", {backgroundColor:"#fff", opacity:0.8}, {opacity:0, duration:0.8}); // Clarão
            gsap.to(".game-area", {x:"+=20", yoyo:true, repeat:10, duration:0.05, clearProps:"x"}); // Tremor
            if(game.fase > 1) { notificar("Falha crítica! -1 Fase"); setTimeout(() => transitionFase(game.fase - 1), 1500); }
            else { notificar("Expulso da Academia!"); setTimeout(() => sairParaMenu(), 1500); }
        }

        function playS(k, rate=1){
            if(sfx[k]){
                const s = sfx[k].cloneNode();
                if(k === 'paper' || k === 'bookOpen') s.playbackRate = 0.9 + Math.random() * 0.2; // Variação de pitch para realismo
                else s.playbackRate = rate;
                s.play().catch(()=>{});
            }
        }
        function notificar(msg){const b=document.getElementById('notif-bar');b.innerText=msg;b.classList.add('show');setTimeout(()=>b.classList.remove('show'),2500);}
        function showCombo(v){
            if(v<2)return;
            const c=document.getElementById('combo-container');
            const isFury = v >= 5;
            const scale = Math.min(1 + (v * 0.15), 3); // Cresce conforme o combo
            c.innerHTML=`<div class="combo-text ${isFury?'fury':''}">x${v}</div>`;
            playS('combo');
            gsap.fromTo(".combo-text",{scale:0, rotation:-15}, {scale:scale, rotation:0, duration:0.4, ease:"elastic.out(1, 0.5)", onComplete:()=>{ gsap.to(".combo-text", {opacity:0, duration:0.3, delay:0.3, onComplete:()=>c.innerHTML=''}); }});
        }
        function showFloatScore(el,pts){const r=el.getBoundingClientRect();const f=document.createElement('div');f.innerText="+"+pts;f.className='float-score';f.style.left=(r.left+r.width/2)+'px';f.style.top=r.top+'px';document.body.appendChild(f);gsap.to(f,{y:-50,opacity:0,duration:1,onComplete:()=>f.remove()});}
        
        function checkSave(){
            const s=DB.getItem('aa_save'); const b=document.getElementById('btn-continue');
            if(s) b.classList.remove('disabled'); else b.classList.add('disabled');
            
            // Verifica Grimório (Só aparece se desbloqueado)
            const g=document.getElementById('btn-grimoire-menu'); 
            if(prof.grimoireUnlocked) {
                g.style.display='flex';
                if(justUnlockedGrimoire) g.classList.add('glow-gold');
            } else { g.style.display='none'; g.classList.remove('glow-gold'); }

            const ng=document.getElementById('btn-ngplus'); if(prof.ngPlusUnlocked) ng.style.display='flex'; else ng.style.display='none';
            const inf=document.getElementById('btn-infinite'); if(prof.infiniteUnlocked) inf.style.display='flex'; else inf.style.display='none';
            if(document.getElementById('screen-menu').style.display !== 'none') animateMenuEntrance();
        }
        
        function fecharJogo() { playS('click'); document.getElementById('exit-screen').style.display='flex'; setTimeout(()=>document.getElementById('exit-screen').style.opacity=1,10); setTimeout(()=>{ if(ipcRenderer)ipcRenderer.send('app-quit'); else window.close(); },2000); }
        function sairParaMenu() { 
            clearInterval(timer); 
            clearInterval(bleedInterval); 
            clearTimeout(chaosTimer); 
            clearTimeout(chaosInternalTimer);
            clearTimeout(tauntTimer);
            
            document.getElementById('time-warning-layer').classList.remove('active'); 
            document.getElementById('dynamic-bg-layer').className='env-default';
            
            DB.setItem('aa_prof', JSON.stringify(prof)); audioManager.playMenu(); changeUIState(UI_STATES.MAIN_MENU); 
        }
        function closeMagicAlert() { document.getElementById('magic-modal-content').classList.remove('show'); setTimeout(()=>document.getElementById('magic-alert-modal').style.display='none',300); }
        
        function abrirPerfilMenu(){ changeUIState(UI_STATES.PROFILE_SELECT); }
        
        // --- PROFILE SYSTEM (REFACTORED) ---
        function setProfileMode(mode) {
            const viewBtns = document.getElementById('view-mode-btns');
            const editBtns = document.getElementById('edit-mode-btns');
            const btnPlay = document.getElementById('btn-prof-play');
            const els = {
                nameDisplay: document.getElementById('dash-name'), nameInput: document.getElementById('prof-name-input'),
                controls: [document.getElementById('avatar-controls'), document.getElementById('frame-controls')],
                avatarDisplay: document.getElementById('dash-av-img'), avatarEdit: document.getElementById('prof-av-edit')
            };

            if (mode === 'view') {
                viewBtns.style.display = 'flex'; editBtns.style.display = 'none';
                // Botão Jogar só aparece se o perfil já está criado e estamos no fluxo de seleção
                btnPlay.style.display = (prof.nome !== "Aprendiz") ? 'flex' : 'none';
                
                els.nameDisplay.style.display = 'block'; els.nameInput.style.display = 'none';
                els.controls.forEach(e => e.style.display = 'none');
                els.avatarDisplay.style.display = 'block'; els.avatarEdit.style.display = 'none';
                els.nameInput.value = prof.nome;
            } else { // edit or create
                viewBtns.style.display = 'none'; editBtns.style.display = 'flex';
                els.nameDisplay.style.display = 'none'; els.nameInput.style.display = 'block';
                els.nameInput.value = prof.nome === "Aprendiz" ? "" : prof.nome;
                els.controls.forEach(e => e.style.display = 'flex');
                els.avatarDisplay.style.display = 'none'; els.avatarEdit.style.display = 'block';
            }
            updateProfUI();
        }

        function saveProfileData() {
            const n = document.getElementById('prof-name-input').value.trim();
            if (n) prof.nome = n; else if (prof.nome === "Aprendiz" || prof.nome === "") prof.nome = "Mago";
            if (!molduras[prof.frame].unlock(prof)) prof.frame = 0;
            DB.setItem('aa_prof', JSON.stringify(prof));
            changeUIState(UI_STATES.PROFILE_VIEW);
        }

        function cancelProfileEdit() {
            if (prof.nome === "Aprendiz") exitProfile();
            else {
                const saved = JSON.parse(DB.getItem('aa_prof'));
                if(saved) { prof = saved; updateProfUI(); }
                changeUIState(UI_STATES.PROFILE_VIEW);
            }
        }

        function exitProfile() { changeUIState(UI_STATES.PROFILE_SELECT); }
        
        function enterGameFromProfile() { changeUIState(UI_STATES.MAIN_MENU); }
        
        function editarPerfil(){ setProfileMode('edit'); } 
        function mudarAvatar(d){
            prof.av = (prof.av + d + avatares.length) % avatares.length;
            updateProfUI();
        }
        function mudarFrame(d){prof.frame=(prof.frame+d+molduras.length)%molduras.length;updateProfUI();}
        
        function updateProfUI(){
            const a=avatares[prof.av]; const c=a.color; const glow=`0 0 20px ${c}`;
            const m = molduras[prof.frame];
            const isLocked = !m.unlock(prof);

            // UI do Seletor
            const fName = document.getElementById('frame-name');
            const fReq = document.getElementById('frame-req');
            if(fName) {
                fName.innerText = m.name; fName.style.color = isLocked ? '#555' : 'var(--accent-gold)';
            }
            if(fReq) {
                fReq.innerText = isLocked ? `Bloqueado (${m.req})` : m.req; fReq.style.color = isLocked ? '#880000' : '#666';
            }
            
            const pEdit = document.getElementById('prof-av-edit');
            if(pEdit) {
                pEdit.src=AssetManager.getSrc(a.file); 
                pEdit.style.borderColor = c; pEdit.style.boxShadow = glow;
                if(isLocked) { pEdit.style.border = "4px solid #333"; pEdit.style.boxShadow = "none"; }
                else m.apply(pEdit, c);
            }
            
            // Para HUD e Dash, usa apenas moldura válida
            const validM = m.unlock(prof) ? m : molduras[0];
            
            // Update Main Profile Avatar (New Design)
            const profFrame = document.getElementById('profile-avatar-frame');
            if(profFrame) {
                profFrame.style.borderColor = c; profFrame.style.boxShadow = glow;
                validM.apply(profFrame, c);
            }

            const dashAvImg = document.getElementById('dash-av-img'); if(dashAvImg) dashAvImg.src=AssetManager.getSrc(a.file); 
            
            const hudAvImg = document.getElementById('hud-av-img'); if(hudAvImg) hudAvImg.src=AssetManager.getSrc(a.file); 
            
            const hudFrame = document.querySelector('#hud-avatar-container .avatar-frame');
            if(hudFrame) {
                hudFrame.style.borderColor = c; hudFrame.style.boxShadow = glow;
                validM.apply(hudFrame, c);
            }
            
            const elDashName = document.getElementById('dash-name'); if(elDashName) elDashName.innerText=prof.nome;
            const elHudName = document.getElementById('hud-name'); if(elHudName) elHudName.innerText=prof.nome;
            const elDashLvl = document.getElementById('dash-lvl'); if(elDashLvl) elDashLvl.innerText=prof.lvl;
            const elHudLvl = document.getElementById('hud-lvl'); if(elHudLvl) elHudLvl.innerText=prof.lvl;
            const elDashTitle = document.getElementById('dash-title'); if(elDashTitle) elDashTitle.innerText=titulos[Math.min(Math.floor((prof.lvl-1)/5),titulos.length-1)];

            // --- FIX: ATUALIZAÇÃO DE STATUS E XP ---
            const nextXp = prof.lvl * 100;
            const curXp = prof.xp || 0;
            const pct = Math.min((curXp / nextXp) * 100, 100);
            
            const elXpBar = document.getElementById('dash-xp-bar'); if(elXpBar) elXpBar.style.width = pct + '%';
            const elXpCur = document.getElementById('dash-xp-current'); if(elXpCur) elXpCur.innerText = Math.floor(curXp);
            const elXpNext = document.getElementById('dash-xp-next'); if(elXpNext) elXpNext.innerText = nextXp;

            const elScore = document.getElementById('dash-score'); if(elScore) elScore.innerText = prof.maxScore || 0;
            const elWins = document.getElementById('dash-wins'); if(elWins) elWins.innerText = prof.wins || 0;
            const elGames = document.getElementById('dash-games'); if(elGames) elGames.innerText = prof.totalGames || 0;
            
            const elTime = document.getElementById('dash-time');
            if(elTime) {
                const t = prof.playTime || 0;
                const h = Math.floor(t / 3600);
                const m = Math.floor((t % 3600) / 60);
                elTime.innerText = `${h}h ${m}m`;
            }
        }
        function openConfigMenu(fromState){
            const q = document.getElementById('btn-quit-match'); 
            lastScreen = fromState === 'game' ? 'screen-game' : 'screen-menu'; // Atualiza referência global
            
            if(fromState === 'game') q.style.display = 'block'; 
            else q.style.display = 'none'; 
            
            changeUIState(UI_STATES.SETTINGS);
        }
        function voltarConfig(){ 
            if(lastScreen === 'screen-game') changeUIState(UI_STATES.GAME);
            else changeUIState(UI_STATES.MAIN_MENU);
        }
        
        function applySettings(){
            audioManager.updateVolume();
            document.getElementById('rng-musica').value=cfg.m;
            document.getElementById('rng-sfx').value=cfg.s;
            // document.getElementById('chk-part').checked=cfg.part; // Elemento não existe no HTML original, removido para evitar erro
            setGfx('part',cfg.part);
        }
        function setGfx(t,v){cfg[t]=v;if(t==='part')document.body.classList.toggle('no-particles',!v);DB.setItem('aa_cfg',JSON.stringify(cfg));}
        function setAudio(t,v){if(t==='m')cfg.m=v;if(t==='s')cfg.s=v;DB.setItem('aa_cfg',JSON.stringify(cfg));audioManager.updateVolume();}
        function deletarSave() { if(confirm("Apagar tudo?")) { DB.removeItem('aa_prof'); DB.removeItem('aa_save'); location.reload(); } }

        function animateMenuEntrance() {
            const visibleCards = Array.from(document.querySelectorAll('.magic-menu-card')).filter(c => window.getComputedStyle(c).display !== 'none');
            
            // Animação de entrada em sequência (Stagger)
            gsap.from(visibleCards, {
                y: 100, opacity: 0, scale: 0.8,
                duration: 0.8, stagger: 0.1, ease: "back.out(1.2)",
                clearProps: "all"
            });
        }

        function createMenuParticle(x, y) {
            const p = document.createElement('div');
            p.className = 'menu-particle';
            p.style.left = x + 'px';
            p.style.top = y + 'px';
            document.body.appendChild(p);
            
            gsap.to(p, {
                x: (Math.random() - 0.5) * 60,
                y: (Math.random() - 0.5) * 60 + 30,
                opacity: 0, scale: 0, duration: 1 + Math.random(), ease: "power1.out", onComplete: () => p.remove()
            });
        }

        // --- 7. VFX E ANIMAÇÕES ---
        function triggerLevelUpFX() {
            const av = document.getElementById('hud-avatar-container');
            const rect = av.getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;

            // 1. Onda de Choque
            const wave = document.createElement('div'); wave.className = 'levelup-shockwave';
            wave.style.left = cx + 'px'; wave.style.top = cy + 'px'; wave.style.width = '0px'; wave.style.height = '0px';
            document.body.appendChild(wave);
            gsap.to(wave, { width: 400, height: 400, x: -200, y: -200, opacity: 1, duration: 0.1, onComplete: () => { gsap.to(wave, { opacity: 0, duration: 0.5, onComplete: ()=>wave.remove() }); } });

            // 2. Explosão de Partículas
            for(let i=0; i<40; i++) {
                const p = document.createElement('div'); p.className = 'magic-spark'; p.style.left = cx + 'px'; p.style.top = cy + 'px';
                p.style.backgroundColor = ['#ffd700', '#fff', '#00a8cc', '#ff4500'][Math.floor(Math.random()*4)]; document.body.appendChild(p);
                const angle = Math.random() * Math.PI * 2; const dist = Math.random() * 150 + 50;
                gsap.to(p, { x: Math.cos(angle) * dist, y: Math.sin(angle) * dist, opacity: 0, scale: 0, duration: 1 + Math.random(), ease: "power2.out", onComplete: ()=>p.remove() });
            }
        }
        
        function triggerComboBreaker() {
            playS('thunder');
            const crack = document.getElementById('crack-fx');
            gsap.fromTo(crack, {opacity: 1, scale: 0.8}, {opacity: 0, scale: 1.2, duration: 0.8, ease: "power2.out"});
            gsap.to(".game-area", {x:"+=15", yoyo:true, repeat:5, duration:0.05, clearProps:"x"});
            gsap.fromTo("#fx-overlay", {backgroundColor:"#ff0000", opacity:0.3}, {opacity:0, duration:0.5});
        }

        function spawnBossBleed() {
            const bar = document.querySelector('.boss-hp-bg');
            if(!bar) return;
            const rect = bar.getBoundingClientRect();
            const p = document.createElement('div'); p.className = 'boss-blood';
            // Posição aleatória ao longo da barra
            p.style.left = (rect.left + Math.random() * rect.width) + 'px';
            p.style.top = (rect.top + rect.height - 5) + 'px';
            document.body.appendChild(p);
            gsap.to(p, {y: 50 + Math.random()*50, opacity: 0, scale: 0.5, duration: 1, ease: "power1.in", onComplete: ()=>p.remove()});
        }

        function initWeatherSystem(){
            const c=document.getElementById('magic-canvas'); 
            const ctx=c.getContext('2d');
            c.width=window.innerWidth; c.height=window.innerHeight;
            
            const hour = new Date().getHours();
            const isNight = hour >= 18 || hour < 6;
            const type = isNight ? 'snow' : 'rain';
            
            let ps=[]; 
            const count = isNight ? 80 : 120;

            class WeatherParticle {
                constructor() { this.reset(true); }
                reset(init=false) {
                    this.x = Math.random() * c.width;
                    this.y = init ? Math.random() * c.height : -10;
                    if (type === 'snow') {
                        this.vx = (Math.random()-0.5)*0.5; this.vy = 1+Math.random()*1.5;
                        this.s = 2+Math.random()*2; this.a = 0.3+Math.random()*0.5;
                    } else {
                        this.vx = 0.5; this.vy = 15+Math.random()*10;
                        this.l = 15+Math.random()*15; this.a = 0.1+Math.random()*0.2;
                    }
                }
                update() { this.x+=this.vx; this.y+=this.vy; if(this.y>c.height||this.x>c.width) this.reset(); }
                draw() {
                    ctx.beginPath();
                    if (type === 'snow') {
                        ctx.fillStyle=`rgba(255,255,255,${this.a})`; ctx.arc(this.x,this.y,this.s,0,Math.PI*2); ctx.fill();
                    } else {
                        ctx.strokeStyle=`rgba(174,194,224,${this.a})`; ctx.lineWidth=1.5;
                        ctx.moveTo(this.x,this.y); ctx.lineTo(this.x+this.vx,this.y+this.l); ctx.stroke();
                    }
                }
            }

            for(let i=0;i<count;i++) ps.push(new WeatherParticle());
            function ani(){ ctx.clearRect(0,0,c.width,c.height); ps.forEach(p=>{p.update();p.draw();}); requestAnimationFrame(ani); }
            ani();
        }
        
        function playPortalEffect(callback) {
            const cvs = document.getElementById('portal-canvas');
            const ctx = cvs.getContext('2d');
            cvs.width = window.innerWidth; cvs.height = window.innerHeight;
            cvs.classList.add('active');
            document.body.classList.add('chromatic-active'); // Ativa distorção
            
            let radius = 0;
            const maxRadius = Math.sqrt(cvs.width**2 + cvs.height**2);
            let rotation = 0;
            let midCalled = false;
            
            function render() {
                ctx.clearRect(0, 0, cvs.width, cvs.height);
                const cx = cvs.width / 2; const cy = cvs.height / 2;
                
                rotation += 0.15;
                radius += maxRadius / 60; // Velocidade de expansão (Mais suave/delicado)
                
                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate(rotation);
                
                // Gradiente Mágico (Branco -> Azul -> Roxo -> Transparente)
                const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, radius);
                gradient.addColorStop(0, '#fff'); 
                gradient.addColorStop(0.3, 'rgba(197, 160, 40, 0.8)'); // Ouro (Accent Gold)
                gradient.addColorStop(0.6, 'rgba(0, 168, 204, 0.4)'); // Magic Blue suave
                gradient.addColorStop(1, 'transparent');
                
                ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fillStyle = gradient; ctx.fill();
                
                // Runas/Linhas de Energia girando
                ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 4;
                for(let i=0; i<6; i++) { ctx.beginPath(); ctx.arc(0, 0, radius * (0.4 + i*0.1), i, Math.PI + i); ctx.stroke(); }
                
                ctx.restore();
                
                // Momento de cobertura total (Tela Branca/Cheia)
                if (radius > maxRadius * 1.2) {
                    if (!midCalled) {
                        midCalled = true;
                        if (callback) callback(); // Troca a cena
                        cvs.classList.remove('active'); // Fade out via CSS
                        document.body.classList.remove('chromatic-active'); // Remove distorção
                        setTimeout(() => ctx.clearRect(0,0,cvs.width,cvs.height), 500);
                    }
                } else {
                    requestAnimationFrame(render);
                }
            }
            render();
        }

        function showBossSpeech(text) {
            const bb = document.getElementById('boss-speech');
            if(!bb) return;
            clearTimeout(speechHideTimer);
            bb.innerText = text;
            bb.style.opacity = 1;
            bb.style.top = "-140px";
            gsap.killTweensOf(bb);
            gsap.fromTo(bb, {y: 20}, {y: 0, duration: 0.3});
            speechHideTimer = setTimeout(() => bb.style.opacity = 0, 4000);
        }

        function triggerBossReaction(type) {
            const b = bosses[currentBossIndex];
            if(!b) return;
            let pool = b.phrases;
            if(type === 'miss' && b.missPhrases) pool = b.missPhrases;
            const p = pool[Math.floor(Math.random() * pool.length)];
            showBossSpeech(p);
            clearTimeout(tauntTimer); scheduleTaunt(); // Reseta timer de taunt aleatório
        }

        function scheduleTaunt(){
            clearTimeout(tauntTimer);
            const t=Math.random()*5000+10000;
            tauntTimer=setTimeout(()=>{
                const b=bosses[currentBossIndex];
                if(b){
                    let pIdx;
                    // Evita repetir a mesma frase duas vezes seguidas
                    do { pIdx = Math.floor(Math.random()*b.phrases.length); } while(pIdx === b.lastPhraseIdx && b.phrases.length > 1);
                    b.lastPhraseIdx = pIdx;
                    showBossSpeech(b.phrases[pIdx]);
                }
                scheduleTaunt();
            },t);
        }
        
        let achievementQueue = [];
        let isAchQueueRunning = false;

        function checkAchievements(t){
            achievementsDB.forEach(a=>{
                if(globalData.achievements.includes(a.id)) return;
                let u=false;
                
                // Níveis
                if(a.id==='lvl_5' && prof.lvl>=5) u=true;
                if(a.id==='lvl_10' && prof.lvl>=10) u=true;
                if(a.id==='lvl_25' && prof.lvl>=25) u=true;
                if(a.id==='lvl_50' && prof.lvl>=50) u=true;
                if(a.id==='lvl_100' && prof.lvl>=100) u=true;
                
                // Jogos
                if(a.id==='veteran_10' && prof.totalGames>=10) u=true;
                if(a.id==='veteran_50' && prof.totalGames>=50) u=true;
                
                // Pontuação
                if(a.id==='score_1k' && prof.maxScore>=1000) u=true;
                if(a.id==='score_5k' && prof.maxScore>=5000) u=true;
                
                // Bosses (Correção de Rastreamento)
                if(a.id.startsWith('kill_')) {
                    const bTarget = a.id.split('_')[1]; // ex: glacia
                    // Busca case-insensitive nas chaves de bossKills (que estão Capitalizadas: Glacia)
                    const bKey = Object.keys(prof.bossKills).find(k => k.toLowerCase() === bTarget);
                    if(bKey && prof.bossKills[bKey] > 0) u=true;
                }

                // Progressão & Especiais
                if(a.id==='win_1' && prof.levelRecords && prof.levelRecords[1]) u=true;
                if(a.id==='win_5' && prof.levelRecords && prof.levelRecords[5]) u=true;
                if(a.id==='win_10' && prof.levelRecords && prof.levelRecords[10]) u=true;
                if(a.id==='completionist' && prof.grimoireUnlocked) u=true;
                if(a.id==='infinite_15' && globalData.infiniteHighScores.some(s => s.fase >= 15)) u=true;

                if(u){ globalData.achievements.push(a.id); DB.setItem('aa_global',JSON.stringify(globalData)); showAch(a); }
            });
        }
        
        function showAch(a){
            achievementQueue.push(a);
            processAchQueue();
        }

        function processAchQueue() {
            if(isAchQueueRunning || achievementQueue.length === 0) return;
            isAchQueueRunning = true;
            const a = achievementQueue.shift();
            
            const p=document.getElementById('achievement-popup');
            document.getElementById('ach-pop-icon').innerText=a.icon;
            document.getElementById('ach-pop-title').innerText=a.title;
            document.getElementById('ach-pop-desc').innerText=a.desc;
            
            playS('achievement');
            p.classList.add('show');
            
            // 4s visível + tempo de transição
            setTimeout(()=>{
                p.classList.remove('show');
                setTimeout(() => {
                    isAchQueueRunning = false;
                    processAchQueue();
                }, 600); // Espera a animação de saída (transition transform 0.6s)
            }, 4000);
        }

        function initGrimoireStars() {
            const c = document.getElementById('grimoire-stars');
            if(!c) return;
            c.innerHTML = '';
            for(let i=0; i<80; i++) {
                const s = document.createElement('div');
                s.className = 'g-star';
                s.style.left = Math.random()*100 + '%';
                s.style.top = Math.random()*100 + '%';
                const size = Math.random()*3 + 1;
                s.style.width = size + 'px';
                s.style.height = size + 'px';
                s.style.animationDelay = Math.random()*3 + 's';
                s.style.animationDuration = (2 + Math.random()*3) + 's';
                c.appendChild(s);
            }
        }

        function toggleGrimoireWithMist(action, fromGame = false) {
            const mist = document.getElementById('mist-layer');
            mist.classList.add('active');
            playS('teleport', 0.6); // Som suave de teleporte/névoa

            setTimeout(() => {
                if (action === 'open') {
                    const g = document.getElementById('btn-grimoire-menu'); if(g) g.classList.remove('glow-gold');
                    if(fromGame) {
                        document.getElementById('screen-game').style.display = 'none';
                        document.getElementById('dynamic-bg-layer').className = 'env-default';
                    }
                    justUnlockedGrimoire = false;
                    changeUIState(UI_STATES.CREDITS);
                    currentBookPage = 0; 
                    renderBookPage(); 
                    initGrimoireStars();
                    if(fromGame && justUnlockedGrimoire) triggerGrimoireUnlockFX();
                } else {
                    sairParaMenu();
                }
                setTimeout(() => mist.classList.remove('active'), 800);
            }, 1500);
        }

        function renderBookPage(dir=0) { 
            const c = document.getElementById('book-content'); const pNum = document.getElementById('page-num');
            if(dir!==0) playS('paper');
            clearTimeout(typewriterTimer);
            
            // Configuração para efeito 3D de 4 segundos (2s saida + 2s entrada) para sincronizar com o áudio
            const duration = 2.0;

            let out={opacity:0,duration:0.3};
            if(dir!==0) gsap.set(c, {transformOrigin: "left center"});
            if(dir===1) out={rotationY:-90,opacity:0,duration:duration,ease:"power1.in"};
            if(dir===-1) out={rotationY:90,opacity:0,duration:duration,ease:"power1.in"};

            gsap.to(c, {...out, onComplete:()=>{
                if(dir!==0) createBookDust();
                let textToType = null; let targetId = null;

                if(currentBookPage===0) {
                    c.innerHTML=`<div class="grimoire-intro-text" id="type-target"></div>`;
                    textToType = "O Grimório Sagrado."; targetId = "type-target";
                }
                else if(currentBookPage<=10) { 
                    const b=bosses[currentBookPage-1]; 
                    c.innerHTML=`<div class="boss-portrait"><img src="${AssetManager.getSrc(b.file)}"></div><h2>${b.n}</h2><p id="type-target"></p>`; 
                    textToType = b.lore; targetId = "type-target";
                }
                else if(currentBookPage===11) {
                    // PÁGINA DO CRIADOR (NOVA)
                    c.innerHTML = `
                        <div class="grimoire-header" style="border-bottom: 2px solid var(--accent-gold); margin-bottom: 30px;"><h1 class="grimoire-title" style="font-size:3rem;">O Criador</h1></div>
                        <div style="text-align:center; display:flex; flex-direction:column; align-items:center; height:100%; justify-content:center;">
                            <div style="width:140px; height:140px; border-radius:50%; border:4px double var(--accent-gold); overflow:hidden; margin-bottom:20px; box-shadow:0 0 20px rgba(0,0,0,0.4); background:#000;">
                                <img src="${AssetManager.getSrc('mago_sabio.png')}" style="width:100%; height:100%; object-fit:cover;">
                            </div>
                            <div style="font-family:'Cinzel'; font-size:1.8rem; color:#8b0000; margin-bottom:10px; font-weight:bold;">Davi Eduardo</div>
                            <div style="font-family:'Cinzel'; font-size:1rem; color:#555; margin-bottom:30px; text-transform:uppercase; letter-spacing:2px;">Dev Junior e Junior Game Designer</div>
                            <p id="type-target" style="font-family:'MedievalSharp'; font-size:1.3rem; color:#2c1e0b; line-height:1.8; max-width:85%; font-style:italic;"></p>
                        </div>
                    `;
                    textToType = "Este é meu primeiro projeto solo, desenvolvido e criado com muita dedicação. Obrigado por completar esta jornada e desvendar os segredos da Arcane Academy."; 
                    targetId = "type-target";
                }
                else if(currentBookPage===12) {
                    // ESTATÍSTICAS (NOVA PÁGINA)
                    let favBoss = "Nenhum"; let maxKills = 0;
                    for(let b in prof.bossKills) { if(prof.bossKills[b] > maxKills) { maxKills = prof.bossKills[b]; favBoss = b; } }
                    
                    const hours = Math.floor(prof.playTime / 3600);
                    const mins = Math.floor((prof.playTime % 3600) / 60);
                    const timeStr = `${hours}h ${mins}m`;

                    c.innerHTML = `
                        <div class="grimoire-header"><h1 class="grimoire-title">Estatísticas</h1><div class="grimoire-subtitle">Seus Feitos</div></div>
                        <div style="display:flex; flex-direction:column; gap:30px; width:100%; padding:20px;">
                            <div class="stat-box" style="background:rgba(93, 64, 55, 0.1); border-color:#5d4037;"><div class="stat-label" style="color:#5d4037;">Vitórias Totais</div><div class="stat-val-big" style="color:#2c1e0b;">${prof.wins}</div></div>
                            <div class="stat-box" style="background:rgba(93, 64, 55, 0.1); border-color:#5d4037;"><div class="stat-label" style="color:#5d4037;">Inimigo Favorito</div><div class="stat-val-big" style="color:#8b0000; font-size:1.5rem;">${favBoss} <span style="font-size:1rem; color:#555;">(${maxKills}x)</span></div></div>
                            <div class="stat-box" style="background:rgba(93, 64, 55, 0.1); border-color:#5d4037;"><div class="stat-label" style="color:#5d4037;">Tempo de Jogo</div><div class="stat-val-big" style="color:#2c1e0b;">${timeStr}</div></div>
                            <div class="stat-box" style="background:rgba(93, 64, 55, 0.1); border-color:#5d4037;"><div class="stat-label" style="color:#5d4037;">Maior Combo</div><div class="stat-val-big" style="color:#2c1e0b;">${prof.maxScore} pts</div></div>
                        </div>
                    `;
                    gsap.from(".stat-box", {opacity:0, y:20, stagger:0.1, duration:0.5});
                }
                else if(currentBookPage===13) { 
                    let h = `<div class="grimoire-header"><h1 class="grimoire-title">Cronônimo</h1><div class="grimoire-subtitle">Recordes de Tempo</div></div>`;
                    h += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; padding:0 20px; max-height:550px; overflow-y:auto;">`;
                    for(let i=1; i<=10; i++) {
                        const t = prof.levelRecords ? prof.levelRecords[i] : null;
                        const tStr = t ? t.toFixed(2) + 's' : '--';
                        const b = bosses[i-1];
                        const bName = b ? b.n : 'Fase '+i;
                        h += `<div class="stat-box" style="background:rgba(93, 64, 55, 0.1); border-color:#5d4037; padding:10px; display:flex; flex-direction:column; align-items:center;"><div style="font-size:0.8rem; color:#5d4037; margin-bottom:5px;">Fase ${i} - ${bName}</div><div style="font-family:'Cinzel'; font-size:1.4rem; color:${t?'#8b0000':'#555'}; font-weight:bold;">${tStr}</div></div>`;
                    }
                    h += `</div>`;
                    c.innerHTML = h;
                    gsap.from(".stat-box", {opacity:0, scale:0.9, stagger:0.05, duration:0.4});
                }
                else if(currentBookPage===14) { 
                    let h=`<div class="grimoire-header"><h1 class="grimoire-title">Conquistas</h1><div class="grimoire-subtitle">Seus Troféus</div></div><div class="ach-list">`; 
                    achievementsDB.forEach(a=>{ 
                        h+=`<div class="ach-item ${globalData.achievements.includes(a.id)?'unlocked':''}"><div class="ach-item-icon">${a.icon}</div><div class="ach-item-text"><h4>${a.title}</h4><p>${a.desc}</p></div></div>`; 
                    }); 
                    c.innerHTML=h+'</div>'; 
                    gsap.from(".ach-item", {opacity:0, y:10, stagger:0.03, duration:0.4, clearProps:"all"});
                }
                
                pNum.innerText=currentBookPage+1; 
                
                if(dir===1) gsap.fromTo(c,{rotationY:90,opacity:0},{rotationY:0,opacity:1,duration:duration,ease:"power1.out"});
                else if(dir===-1) gsap.fromTo(c,{rotationY:-90,opacity:0},{rotationY:0,opacity:1,duration:duration,ease:"power1.out"});
                else gsap.to(c,{opacity:1,duration:0.3});

                if(textToType && targetId) setTimeout(() => typeWriterEffect(document.getElementById(targetId), textToType), 200);
            }});
        }

        function createBookDust() {
            const container = document.getElementById('vfx-container');
            const rect = document.querySelector('.grimoire-container').getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.bottom - 50;
            
            for(let i=0; i<25; i++) {
                const p = document.createElement('div');
                p.style.cssText = `position:fixed; left:${cx}px; top:${cy}px; width:${Math.random()*4+2}px; height:${Math.random()*4+2}px; background:radial-gradient(circle, #ffd700, transparent); border-radius:50%; z-index:20005; pointer-events:none; opacity:1;`;
                container.appendChild(p);
                
                gsap.to(p, { x: (Math.random()-0.5)*300, y: -50 - Math.random()*150, opacity: 0, scale: 0, duration: 1.5 + Math.random(), ease: "power2.out", onComplete: () => p.remove() });
            }
        }

        function typeWriterEffect(el, text, i = 0) {
            if (!el) return;
            if (i === 0) el.textContent = "";
            el.textContent = text.substring(0, i + 1);
            if (i < text.length - 1) {
                typewriterTimer = setTimeout(() => typeWriterEffect(el, text, i + 1), 15 + Math.random() * 15);
            }
        }

        function nextPage(){if(currentBookPage<14){currentBookPage++;renderBookPage(1);}} function prevPage(){if(currentBookPage>0){currentBookPage--;renderBookPage(-1);}}
        function getRewards(lvl) { let cardSkin = ''; let aura = ''; let hitEffect = 'boss-hit'; if (lvl >= 80) { cardSkin = 'card-skin-cosmic'; aura = 'aura-light'; hitEffect = 'boss-hit-void'; } else if (lvl >= 60) { cardSkin = 'card-skin-mythril'; aura = 'aura-shadow'; hitEffect = 'boss-hit-shock'; } else if (lvl >= 40) { cardSkin = 'card-skin-diamond'; aura = 'aura-lightning'; hitEffect = 'boss-hit-fire'; } else if (lvl >= 20) { cardSkin = 'card-skin-gold'; aura = 'aura-fire'; hitEffect = 'boss-hit-ice'; } else if (lvl >= 5) { cardSkin = 'card-skin-silver'; aura = 'aura-ice'; } return { cardSkin, aura, hitEffect }; }
        
        function triggerArcaneShot(el) {
            const b = document.getElementById('boss-vis');
            if(!b) return;
            const rect = el.getBoundingClientRect();
            const bRect = b.getBoundingClientRect();
            
            const p = document.createElement('div');
            p.className = 'spell-projectile';
            // Centraliza no elemento de origem
            p.style.left = (rect.left + rect.width/2 - 25) + 'px';
            p.style.top = (rect.top + rect.height/2 - 25) + 'px';
            
            // Se estiver em Fúria, o projétil fica vermelho/fogo
            if(combo >= 3) { p.style.background = "radial-gradient(circle, #fff, #ff4500)"; p.style.boxShadow = "0 0 30px #ff4500, 0 0 60px #fff"; }

            document.getElementById('vfx-container').appendChild(p);
            
            const destX = (bRect.left + bRect.width/2) - (rect.left + rect.width/2);
            const destY = (bRect.top + bRect.height/2) - (rect.top + rect.height/2);
            
            gsap.to(p, {
                x: destX, y: destY, scale: 0.5, duration: 0.4, ease: "power2.in",
                onComplete: () => { p.remove(); const img = document.getElementById('boss-img-tag'); img.classList.remove('boss-hit'); void img.offsetWidth; img.classList.add('boss-hit'); createMagicBurst(bRect.left + bRect.width/2, bRect.top + bRect.height/2); }
            });
        }

        function createMagicBurst(x, y) { const container = document.getElementById('vfx-container'); const count = 12; const colors = ['#d4af37', '#00d2ff', '#ffffff']; for (let i = 0; i < count; i++) { const spark = document.createElement('div'); spark.classList.add('magic-spark'); spark.style.left = x + 'px'; spark.style.top = y + 'px'; spark.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]; container.appendChild(spark); const angle = Math.random() * Math.PI * 2; const distance = Math.random() * 60 + 30; const destX = Math.cos(angle) * distance; const destY = Math.sin(angle) * distance; gsap.to(spark, { x: destX, y: destY, opacity: 0, scale: 0, duration: 0.6, ease: "power2.out", onComplete: () => spark.remove() }); } }
        function initAudioVisualizer() { gsap.to(".magic-menu-card", { boxShadow: "0 15px 40px -5px rgba(0, 210, 255, 0.4)", borderColor: "rgba(0, 210, 255, 0.6)", duration: 2.5, repeat: -1, yoyo: true, stagger: { each: 0.3, from: "center" }, ease: "sine.inOut" }); }
        
        function triggerGrimoireUnlockFX() {
            const container = document.getElementById('vfx-container');
            const rect = document.querySelector('.grimoire-container').getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;
            
            // Partículas Douradas
            for(let i=0; i<60; i++) {
                const p = document.createElement('div');
                p.style.cssText = `position:fixed; left:${cx}px; top:${cy}px; width:${Math.random()*6+2}px; height:${Math.random()*6+2}px; background:radial-gradient(circle, #ffd700, #b8860b); border-radius:50%; z-index:20000; pointer-events:none; box-shadow:0 0 10px #ffd700;`;
                container.appendChild(p);
                
                const angle = Math.random() * Math.PI * 2;
                const dist = 100 + Math.random() * 300;
                
                gsap.to(p, {
                    x: Math.cos(angle) * dist,
                    y: Math.sin(angle) * dist,
                    opacity: 0,
                    scale: 0,
                    duration: 1.5 + Math.random(),
                    ease: "power2.out",
                    onComplete: () => p.remove()
                });
            }
            
            // Flash de Luz
            const flash = document.createElement('div');
            flash.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; opacity:0.8; z-index:19999; pointer-events:none; mix-blend-mode:overlay;";
            document.body.appendChild(flash);
            gsap.to(flash, {opacity:0, duration:1, onComplete:()=>flash.remove()});
        }
    
    </script>
</body>
</html>